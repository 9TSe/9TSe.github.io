<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>RTMP | 9TSe</title><meta name="author" content="9TSe"><meta name="copyright" content="9TSe"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1. 协议简介1.1 RTMPRTMP是Real Time Messaging Protocol（实时消息传输协议）的首字母缩写。该协议基于TCP，是一个协议族，包括RTMP基本协议RTMPT&#x2F;RTMPS&#x2F;RTMPE等多种变种。RTMP是一种设计用来进行实时数据通信的网络协议，主要用来在Flash&#x2F;AIR平台和支持RTMP协议的流媒体&#x2F;交互服务器之间进行音视">
<meta property="og:type" content="article">
<meta property="og:title" content="RTMP">
<meta property="og:url" content="http://example.com/2024/03/18/RTMP/index.html">
<meta property="og:site_name" content="9TSe">
<meta property="og:description" content="1. 协议简介1.1 RTMPRTMP是Real Time Messaging Protocol（实时消息传输协议）的首字母缩写。该协议基于TCP，是一个协议族，包括RTMP基本协议RTMPT&#x2F;RTMPS&#x2F;RTMPE等多种变种。RTMP是一种设计用来进行实时数据通信的网络协议，主要用来在Flash&#x2F;AIR平台和支持RTMP协议的流媒体&#x2F;交互服务器之间进行音视">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/pic/1.png">
<meta property="article:published_time" content="2024-03-18T04:14:50.000Z">
<meta property="article:modified_time" content="2024-04-01T13:03:39.063Z">
<meta property="article:author" content="9TSe">
<meta property="article:tag" content="RTMP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/pic/1.png"><link rel="shortcut icon" href="/pic/12.png"><link rel="canonical" href="http://example.com/2024/03/18/RTMP/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'RTMP',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-01 21:03:39'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="9TSe" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/pic/avater.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">47</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url('/pic/1.png')"><nav id="nav"><span id="blog-info"><a href="/" title="9TSe"><img class="site-icon" src="/pic/9.png"/></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">RTMP</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-03-18T04:14:50.000Z" title="发表于 2024-03-18 12:14:50">2024-03-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-01T13:03:39.063Z" title="更新于 2024-04-01 21:03:39">2024-04-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9F%B3%E8%A7%86%E9%A2%91/">音视频</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="RTMP"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-协议简介"><a href="#1-协议简介" class="headerlink" title="1. 协议简介"></a>1. 协议简介</h1><h2 id="1-1-RTMP"><a href="#1-1-RTMP" class="headerlink" title="1.1 RTMP"></a>1.1 RTMP</h2><p>RTMP是Real Time Messaging Protocol（实时消息传输协议）的首字母缩写。该协议<code>基于TCP</code>，是一个协议族，包括RTMP基本协议RTMPT&#x2F;RTMPS&#x2F;RTMPE等多种变种。<br>RTMP是一种设计用来进行实时数据通信的网络协议，主要用来在Flash&#x2F;AIR平台和支持RTMP协议的流媒体&#x2F;交互服务器之间进行音视频和数据通信。<br>支持该协议的软件包括Adobe Media Server&#x2F;Ultrant Media Server&#x2F;red5等。RTMP与HTTP一样，都属于TCP&#x2F;IP四层模型的应用层。</p>
<ul>
<li><p>应用层协议，依靠TCP保证可靠传输。</p>
</li>
<li><p>默认端口：<code>1953</code>，可能被防火墙屏蔽。</p>
</li>
<li><p>在流媒体&#x2F;交互服务器之间进行音视频和数据<code>通信</code>。</p>
</li>
</ul>
<h2 id="1-2-HLS"><a href="#1-2-HLS" class="headerlink" title="1.2 HLS"></a>1.2 HLS</h2><p>HLS(HTTP Live Streaming)是一个由苹果公司提出的<strong>基于HTTP</strong>的流媒体网络传输协议。<br>所以在 Apple 的全系列产品包括 iPhone、 iPad、safari 都不需要安装任何插件就可以原生支持播放 HLS， 现在 Android 也加入了对 HLS 的支持。</p>
<p><font color = red>工作原理 : 把整个流分成一个个小的基于HTTP的TS文件来下载，每次只下载一些。</font><br>当媒体流正在播放时，客户端可以选择从许多不同的备用源中以不同的速率下载同样的资源，允许流媒体会话适应不同的数据速率。</p>
<p>HLS请求基本的HTTP报文，与实时传输协议（<code>RTP</code>)不同<br><font color = red>HLS可以穿过任何允许HTTP数据通过的防火墙或者代理服务器。它也很容易使用内容分发网络来传输媒体流。 </font></p>
<p>HLS缺陷:</p>
<ul>
<li>实时性差，延迟高。延迟基本在 10s+ 以上</li>
<li>ts 切片较小，会造成海量小文件，对存储和缓存有影响</li>
</ul>
<p>HLS规范：</p>
<ul>
<li><p>视频的封装格式是<code>TS</code>。</p>
</li>
<li><p>音视频采用<code>H264</code>编码和<code>AAC</code>编码。</p>
</li>
<li><p>除了<code>TS</code>视频文件本身，还定义了用来控制播放的<code>m3u8</code>索引文件</p>
</li>
</ul>
<h2 id="1-3-对比RTMP，HLS-HTTP-FLV"><a href="#1-3-对比RTMP，HLS-HTTP-FLV" class="headerlink" title="1.3  对比RTMP，HLS, HTTP-FLV"></a>1.3  对比RTMP，HLS, HTTP-FLV</h2><p>在开始之前，我们先要明确一个问题，根据应用场景不同，流媒体协议分为：</p>
<ul>
<li><p>推流协议</p>
</li>
<li><p>拉流播放协议</p>
</li>
</ul>
<blockquote>
<p><code>RTMP</code>  &gt;&gt; 双端<br><code>HLS</code> &gt;&gt; 拉流端<br><code>HTTP-FLV</code> &gt;&gt; 拉流端。</p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th>RTMP</th>
<th>HTTP-FLV</th>
<th>HLS</th>
</tr>
</thead>
<tbody><tr>
<td>传输协议</td>
<td>TCP</td>
<td>HTTP</td>
<td>HTTP</td>
</tr>
<tr>
<td>视频封装格式</td>
<td>flv</td>
<td>flv</td>
<td>ts</td>
</tr>
<tr>
<td>延时</td>
<td>1-3秒</td>
<td>1-3秒</td>
<td>5-20秒</td>
</tr>
<tr>
<td>Web支持</td>
<td>H5需要使用插件</td>
<td>H5需要使用插件</td>
<td>支持H5</td>
</tr>
<tr>
<td>数据</td>
<td>连续流</td>
<td>连续流</td>
<td>切片文件</td>
</tr>
</tbody></table>
<p>ps: H5 是 <code>HTML5</code></p>
<p><strong>1. RTMP &amp; HTTP-FLV</strong></p>
<ul>
<li><p>这两个协议实际上传输的数据是一样的，数据都是<code>flv文件的tag</code>。</p>
</li>
<li><p>RTMP：实时播放服务器的 FLV 文件或服务器转发的FLV数据，本地<code>无 FLV 缓存文件</code>，<code>FLV保密性好</code>。</p>
</li>
<li><p>HTTP-FLV：将 FLV <code>下载到本地</code>再播放，FLV<code>保密性不好</code>。</p>
</li>
</ul>
<p><strong>2. HLS &amp; RTMP</strong></p>
<ul>
<li><p>RTMP：采用<code>1935</code>端口，而非HTTP<code>80</code>端口，在某些网络环境下可能被<code>屏蔽</code>。</p>
</li>
<li><p>RTMP：是一种<code>有状态协议</code>，需要为每一个播放视频流的客户端维护状态，服务器平滑<code>扩展难度大</code>。</p>
</li>
<li><p>HLS：基于<code>无状态HTTP协议</code>，客户端只需要按顺序使用下载的TS文件就可，负载均衡如同普通的HTTP文件服务器负载均衡一样。</p>
</li>
</ul>
<p><strong>3. HTTP-FLV</strong></p>
<p>HTTP-FLV 结合了 RTMP 和 HLS 的优点，易用（HTTP协议）低延时（flv）</p>
<p><strong>4. 为什么 RTPM 比 HLS 快</strong></p>
<ul>
<li><p>HLS拉流：服务器音视频数据切片生成 TS 文件</p>
</li>
<li><p>HLS拉流：客户端必须等待服务端至少生成一个 TS 文件<br>通常下载完两个媒体文件后才能保证不同分段音视频间的无缝连接。</p>
</li>
<li><p>HLS一直在等切片数据，<code>RTMP不需要切片</code></p>
</li>
</ul>
<hr>
<h1 id="2-封装简介"><a href="#2-封装简介" class="headerlink" title="2. 封装简介"></a>2. 封装简介</h1><h2 id="2-1-FLV"><a href="#2-1-FLV" class="headerlink" title="2.1 FLV"></a>2.1 FLV</h2><p><strong>1. FLV的封装格式</strong></p>
<p><code>FLV</code>（Flash Video），Adobe公司设计开发的一种流行的流媒体格式，由于其视频文件体积轻巧、封装简单等特点，使其很适合在互联网上进行应用。除了播放视频，在直播时也可以使用。采用FLV格式封装的文件后缀为<code>.flv</code>，格式如下（<code>FLV = FLV Header + Body</code>）</p>
<p><img src="/img/mv1.13.png"></p>
<p><strong>2. FLV Header</strong></p>
<p>Header 部分记录了FLV的类型、版本、流信息、Header 长度等。<br>一般整个Header占用<code>9</code>个字节，大于9个字节则表示头部信息在这基础之上还存在扩展数据。<br>FLV Header 的信息排布如下所示：</p>
<p><img src="/img/mv1.14.png"></p>
<p><strong>3. FLV Body</strong></p>
<p>Body 是由一个个<code>Tag</code>组成的，每个Tag下面有一块<code>4</code>个字节的空间，用来记录这个Tag 的长度。<br>这个后置的<code>PreviousTagSize</code>用于<code>逆向</code>读取处理，表示的是前面的Tag的大小。<br>FLV Body 的信息排布如下：</p>
<p><img src="/img/mv1.15.png"></p>
<p><strong>4. FLV Tag</strong></p>
<p>每个Tag 也是由两部分组成的：<code>Tag Header</code> 和 <code>Tag Data</code>。<br>Tag Header 存放了当前Tag的类型，数据长度、时间戳、时间戳扩展、StreamsID等信息，然后再接着数据区Tag Data。<br>Tag的排布如下：</p>
<p><img src="/img/mv1.16.png"></p>
<p><strong>5. Tag Data</strong></p>
<p>Tag Data分成 <code>Audio</code>，<code>Video</code>，<code>Script</code> 三种。</p>
<p><strong>5.1 Audio Tag Data</strong></p>
<p>音频的Tag Data又分为 <code>AudioTagHeader</code> 和 <code>Data</code> 数据区，其排布结构如下图所示：</p>
<p><img src="/img/mv1.17.png"></p>
<p><strong>5.2 Video Tag Data</strong></p>
<ul>
<li>Video Tag 由<code>一个字节的VideoTagHeader</code> 和 <code>Video数据区</code>部分组成</li>
</ul>
<p><img src="/img/mv1.18.png"></p>
<ul>
<li>Video数据区部分格式不确定。对于<code>AVC (H.264)</code>编码部分，Video数据区排布如下:</li>
</ul>
<p><img src="/img/mv1.19.png"></p>
<p><strong>5.3 Script Tag Data</strong></p>
<p><img src="/img/mv1.20.png"></p>
<h2 id="2-2-TS"><a href="#2-2-TS" class="headerlink" title="2.2 TS"></a>2.2 TS</h2><blockquote>
<p><code>TS</code>（Transport Stream，<code>传输流</code>），一种常见的视频封装格式，是基于<code>MPEG-2</code>的封装格式（所以也叫<code>MPEG-TS</code>），后缀为<code>.ts</code>。</p>
</blockquote>
<p><strong>1. TS的分层结构</strong></p>
<p>TS文件分为三层，如下所示（可以倒序看更好理解）：</p>
<ul>
<li><p><code>TS层</code>（Transport Stream）<br>在PES层基础上加入了数据流识别信息和传输信息。</p>
</li>
<li><p><code>PES层</code>（Packet Elemental Stream）<br>在ES层基础上加入时间戳（PTS&#x2F;DTS）等信息。</p>
</li>
<li><p><code>ES层</code>（Elementary Stream）<br>压缩编码后的音视频数据。</p>
</li>
</ul>
<p><img src="/img/mv1.21.png"></p>
<p><strong>2. TS层</strong></p>
<blockquote>
<p>ts包大小<code>固定为188字节</code> ，ts层分为三个部分：<code>ts header</code>、<code>adaptation field</code>、<code>payload</code>。</p>
</blockquote>
<ul>
<li><p><code>ts header</code>固定<code>4</code>个字节；</p>
</li>
<li><p><code>adaptation field</code>可能存在也可能不存在，主要作用是给不足188字节的数据做<code>填充</code>。</p>
</li>
<li><p><code>payload</code>是 <code>PES</code> 数据，或者<code>PAT</code>，<code>PMT</code>等。</p>
</li>
</ul>
<p>◆ ts Header + adaptation field 格式如下：</p>
<p><img src="/img/mv1.22.png"></p>
<p><strong>2.1 TS Header</strong></p>
<ul>
<li>TS Header格式如下：</li>
</ul>
<p><img src="/img/mv1.23.png"></p>
<ul>
<li><code>pid</code> 决定了<code>负载内容</code>的类型，主要包括：PAT表，PMT表，视频流，音频流。常用的PID值：</li>
</ul>
<table>
<thead>
<tr>
<th>表</th>
<th>PAT</th>
<th>CAT</th>
<th>TSDT</th>
<th>EIT,ST</th>
<th>RST,ST</th>
<th>TDT,TOT,ST</th>
</tr>
</thead>
<tbody><tr>
<td>PID</td>
<td>0x0000</td>
<td>0x0001</td>
<td>0x0002</td>
<td>0x0012</td>
<td>0x0013</td>
<td>0x0014</td>
</tr>
</tbody></table>
<p><strong>2.2 调整字段</strong></p>
<p><img src="/img/mv1.24.png"></p>
<p><strong>2.3 PAT表结构（指明PMT表的PID值）</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">TS_PAT</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> table_id                 :<span class="number">8</span>  <span class="comment">//固定位0x00，表示该表是PAT</span></span><br><span class="line">    <span class="type">unsigned</span> section_syntax_indicator :<span class="number">1</span>  <span class="comment">//段语法标志，固定为1</span></span><br><span class="line">    <span class="type">unsigned</span> zero                     :<span class="number">1</span>  <span class="comment">//固定为0</span></span><br><span class="line">    <span class="type">unsigned</span> reserved_1               :<span class="number">2</span>  <span class="comment">//第一个保留位</span></span><br><span class="line">    <span class="type">unsigned</span> section_length           :<span class="number">12</span> <span class="comment">//表示这个字节之后有用的字节数，包括CRC_32</span></span><br><span class="line">    <span class="type">unsigned</span> transport_stream_id      :<span class="number">16</span> <span class="comment">//传输流的ID，区别于一个网络中其他多路复用的流</span></span><br><span class="line">    <span class="type">unsigned</span> reserved_2               :<span class="number">2</span>  <span class="comment">//第二个保留位</span></span><br><span class="line">    <span class="type">unsigned</span> version_number           :<span class="number">5</span>  <span class="comment">//表示PAT的版本号</span></span><br><span class="line">    <span class="type">unsigned</span> current_next_indicator   :<span class="number">1</span>  <span class="comment">//表示发送的PAT是当前有效还是下一个有效，为1时代表当前有效</span></span><br><span class="line">    <span class="type">unsigned</span> section_number           :<span class="number">8</span>  <span class="comment">//如果PAT分段传输，那么此值每次递增1</span></span><br><span class="line">    <span class="type">unsigned</span> last_section_number      :<span class="number">8</span>  <span class="comment">//最后一个分段的号码</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;N;i++)&#123;</span><br><span class="line">        <span class="type">unsigned</span> Program_number           :<span class="number">16</span> <span class="comment">//节目号</span></span><br><span class="line">        <span class="type">unsigned</span> Reversed_3               :<span class="number">3</span>  <span class="comment">//保留位</span></span><br><span class="line">        <span class="keyword">if</span>(Program_number == <span class="number">0</span>)</span><br><span class="line">            Network_id                    :<span class="number">13</span> <span class="comment">//网络信息表（NIT）的PID</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            Program_MAP_PID               :<span class="number">13</span> <span class="comment">//节目映射表的PID，每个节目都有一个</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">unsigned</span> CRC_32                   :<span class="number">32</span> <span class="comment">//CRC32校检码</span></span><br><span class="line">&#125;TS_PAT</span><br></pre></td></tr></table></figure>

<p><strong>2.4 PMT表（指明音视频流的PID值）</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">TS_program_map_section</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> Table_id                    :<span class="number">8</span>  <span class="comment">//标志PSI分段的内容，对于PMT，此值为0x02</span></span><br><span class="line">    <span class="type">unsigned</span> Section_syntax_indicator    :<span class="number">1</span>  <span class="comment">//置为1</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="string">&#x27;0&#x27;</span>                         :<span class="number">1</span></span><br><span class="line">    <span class="type">unsigned</span> Reserved                    :<span class="number">2</span>  <span class="comment">//保留位</span></span><br><span class="line">    <span class="type">unsigned</span> Section_length              :<span class="number">12</span> <span class="comment">//指明了自此到最后CRC_32的字节数</span></span><br><span class="line">    <span class="type">unsigned</span> Program_number              :<span class="number">16</span> <span class="comment">//指出该节目的节目号，与PAT表对应</span></span><br><span class="line">    <span class="type">unsigned</span> Reserved                    :<span class="number">2</span>  <span class="comment">//保留位</span></span><br><span class="line">    <span class="type">unsigned</span> Version_number              :<span class="number">5</span>  <span class="comment">//取值0-31，代表当前PMT的版本号</span></span><br><span class="line">    <span class="type">unsigned</span> Current_next_indicator      :<span class="number">1</span>  <span class="comment">//代表当前PMT是否有效</span></span><br><span class="line">    <span class="type">unsigned</span> Section_number              :<span class="number">8</span>  <span class="comment">//给出了当前所处段的数目</span></span><br><span class="line">    <span class="type">unsigned</span> Last_section_number         :<span class="number">8</span>  <span class="comment">//给出了最后一个分段，即分段的最大数目</span></span><br><span class="line">    <span class="type">unsigned</span> Reserved                    :<span class="number">3</span>  <span class="comment">//保留位</span></span><br><span class="line">    <span class="type">unsigned</span> PCR_PID                     :<span class="number">13</span> <span class="comment">//指示TS包的PCR值，该TS包含有PCR字段</span></span><br><span class="line">    <span class="type">unsigned</span> Reserved                    :<span class="number">4</span>  <span class="comment">//保留位</span></span><br><span class="line">    <span class="type">unsigned</span> Program_info_length         :<span class="number">12</span> <span class="comment">//该字段描述跟随其后对节目信息描述的字节数</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">        <span class="built_in">Descriptr</span>()</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++)&#123;</span><br><span class="line">        <span class="type">unsigned</span> Stream_type             :<span class="number">8</span>  <span class="comment">//0x00：保留， 0x01：MPEG1视频，0x02：MPEG2视频，0x03:MPEG1音频，0x04：MPEG2音频，0x05：私有字段，0x06：含有私有数据的PES包 ......</span></span><br><span class="line">        <span class="type">unsigned</span> Reserved                :<span class="number">3</span>  <span class="comment">//保留</span></span><br><span class="line">        <span class="type">unsigned</span> Elementary_PID          :<span class="number">13</span> <span class="comment">//指示TS包的PID，这些TS包含有相同的PID</span></span><br><span class="line">        <span class="type">unsigned</span> Reserved                :<span class="number">4</span>  <span class="comment">//保留</span></span><br><span class="line">        <span class="type">unsigned</span> ES_info_length          :<span class="number">12</span> <span class="comment">//指示跟随其后描述相关节目元素的字节数</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; N2; j++)</span><br><span class="line">            <span class="built_in">Descriptr</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">unsigned</span> CRC_32                      :<span class="number">32</span> <span class="comment">//循环校检位</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2.5 补充</strong></p>
<ul>
<li><p>打包ts流时<code>PAT</code>和<code>PMT</code>表是没有调整字段的，不够的长度直接补<code>0xff</code>即可。</p>
</li>
<li><p><code>视频流</code>和<code>音频流</code>都需要加<code>adaptation field</code>，<font color = red>通常加在一个帧的第一个ts包和最后一个ts包里，中间的ts包不加。</font></p>
</li>
</ul>
<p><strong>3. PES 层</strong></p>
<ul>
<li><p><code>PES</code>（Packetized Elementary Stream，打包的ES），在 ES 层的基础上加入了时间戳（PTS&#x2F;TDS）等信息。</p>
</li>
<li><p>ES数据包比较大，加入PES头时需<code>将ES进行分割</code>，只在<code>第一个分割的ES上加PES头</code>，如下图所示</p>
</li>
</ul>
<p><img src="/img/mv1.25.png"></p>
<ul>
<li><p><code>PES packet length</code> — 指示PES 包中跟随该字段最后字节的字节数。0 值指示PES 包长度既未指示也未限定并且仅在这样的PES 包中才被允许，该PES 包的有效载荷由来自传输流包中所包含的视频基本流的字节组成。</p>
</li>
<li><p>PES结构如下：</p>
</li>
</ul>
<p><img src="/img/mv1.26.png"></p>
<ul>
<li>PES 关键字段说明</li>
</ul>
<p><img src="/img/mv1.27.png"></p>
<p><strong>4. ES 层</strong></p>
<ul>
<li><p><code>ES</code>（Elementary Stream，基本码流），就是<code>音视频编码数据流</code>，比如视频<code>H.264</code>，音频<code>AAC</code>。</p>
</li>
<li><p><font color = red>一个 ES 流中只包含一种类型的数据（视频，或音频，或字幕）。</font></p>
</li>
</ul>
<hr>
<h1 id="3-HLS-Server-demo"><a href="#3-HLS-Server-demo" class="headerlink" title="3. HLS_Server(demo)"></a>3. HLS_Server(demo)</h1><h2 id="3-1-ffmpeg-命令生成m3u8切片"><a href="#3-1-ffmpeg-命令生成m3u8切片" class="headerlink" title="3.1 ffmpeg 命令生成m3u8切片"></a>3.1 ffmpeg 命令生成m3u8切片</h2><blockquote>
<p>第一种方式</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.mp4 -c:v libx264 -c:a copy -f hls -hls_time 10 -hls_list_size 0 -hls_start_number 0 input/index.m3u8</span><br></pre></td></tr></table></figure>
<p><strong>注解 :</strong></p>
<ul>
<li>-<code>c:v</code> codec（编解码器）: video（视频）。 &#x3D;&#x3D; -vcodec</li>
<li>-<code>c:a</code> audio（音频）  &#x3D;&#x3D; -acodec </li>
<li>-<code>f</code> (format) 以<code>hls</code>格式</li>
<li>-<code>hls_time n</code>: 设置每片的长度，默认值为2,单位为秒</li>
<li>-<code>hls_list_size n</code>:设置播放列表保存的最多条目，设置为0会保存有所片信息，默认值为5</li>
<li>-<code>hls_start_number n</code>:设置播放列表中sequence number的值为number，默认值为0</li>
<li>-<code>hls_wrap n</code>:设置多少片之后开始覆盖，如果设置为0则不会覆盖，默认值为0<br> 这个选项能够避免在磁盘上存储过多的片，而且能够限制写入磁盘的最多的片的数量</li>
<li>input 文件需要自己新建</li>
</ul>
<blockquote>
<p>第二种方式</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i input.mp4 -fflags flush_packets -max_delay 2 -flags -global_header </span><br><span class="line">-hls_time 5 -hls_list_size 0 -vcodec libx264 -acodec aac -r 30 -g 60 index.m3u8</span><br></pre></td></tr></table></figure>
<p><strong>注解:</strong></p>
<ul>
<li><code>-fflags</code> 设置输入&#x2F;输出文件或流的标志（flags）<br>用来激活或修改 FFmpeg 内部的标志，以控制特定的行为</li>
<li><code>-flush_packets</code> 导致 FFmpeg 立即输出已经在内存缓冲中的数据包（packets）<br>而不是等待缓冲区满或其他条件触发输出。</li>
<li><code>-max_delay 2</code>：设置最大延迟时间为 2 秒</li>
</ul>
<ul>
<li><p><code>-flags -global_header</code>：这是一个设置视频编码器标志的选项。在这个情况下，<code>-flags</code> 用于设置特定的编码器标志。<code>-global_header</code> 标志指示在视频流的第一个关键帧（I帧）中包含全局头信息（global headers），这对于某些视频流的处理和解码非常重要。</p>
</li>
<li><p><code>-vcodec libx264</code>：指定视频编码器为 libx264，用于对视频进行 H.264 编码。</p>
</li>
<li><p><code>-acodec aac</code>：指定音频编码器为 AAC，用于对音频进行 AAC 编码。</p>
</li>
</ul>
<h2 id="3-2-源代码"><a href="#3-2-源代码" class="headerlink" title="3.2 源代码"></a>3.2 源代码</h2><blockquote>
<p>Log.h</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> std::string <span class="title">GetCur_FormatTime</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format = <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">time_t</span> t = <span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="type">char</span> str[<span class="number">64</span>];</span><br><span class="line">    <span class="built_in">strftime</span>(str, <span class="built_in">sizeof</span>(str), format, <span class="built_in">localtime</span>(&amp;t));</span><br><span class="line">    std::string time;</span><br><span class="line">    <span class="keyword">return</span> time;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGI(format, ...) \</span></span><br><span class="line"><span class="meta">fprintf(stderr, <span class="string">&quot;[INFO]%s, [%s:%d %s()]&quot;</span> format <span class="string">&quot;\n&quot;</span>, GetCur_FormatTime().data(), __FILE__, __LINE__,__func__, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGE(format, ...) \</span></span><br><span class="line"><span class="meta">fprintf(stderr, <span class="string">&quot;[INFO]%s, [%s:%d %s()]&quot;</span> format <span class="string">&quot;\n&quot;</span>, GetCur_FormatTime().data(), __FILE__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>main.cpp</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Log.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;connection.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//ffplay -i http://127.0.0.1:8080/index.m3u8</span></span><br><span class="line">    WSADATA wsadata;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsadata) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;WSAStartup error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> port = <span class="number">8080</span>;</span><br><span class="line">    SOCKET serverFd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    SOCKADDR_IN server_addr;</span><br><span class="line">    server_addr.sin_family = AF_INET;</span><br><span class="line">    server_addr.sin_addr.S_un.S_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    server_addr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(serverFd, (SOCKADDR*)&amp;server_addr, <span class="built_in">sizeof</span>(SOCKADDR)) == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;socket bind error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">listen</span>(serverFd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;socket bind error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGI</span>(<span class="string">&quot;wait new connect&quot;</span>);</span><br><span class="line">        <span class="type">int</span> len = <span class="built_in">sizeof</span>(SOCKADDR);</span><br><span class="line">        SOCKADDR_IN accept_addr;</span><br><span class="line">        <span class="type">int</span> clientFd = <span class="built_in">accept</span>(serverFd, (SOCKADDR*)&amp;accept_addr, &amp;len);</span><br><span class="line">        <span class="keyword">if</span> (clientFd == SOCKET_ERROR)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOGE</span>(<span class="string">&quot;accept connection error&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">LOGI</span>(<span class="string">&quot;new connect clientFd = %d&quot;</span>, clientFd);</span><br><span class="line">        <span class="function">Connection <span class="title">conn</span><span class="params">(clientFd)</span></span>;</span><br><span class="line">        conn.<span class="built_in">start</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">closesocket</span>(serverFd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>connection.h</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Log.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Connection</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Connection</span>(<span class="type">int</span> clientFd);</span><br><span class="line">    ~<span class="built_in">Connection</span>();</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> mclientFd;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>connection.cpp</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;connection.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Connection::<span class="built_in">Connection</span>(<span class="type">int</span> clientFd)</span><br><span class="line">    :<span class="built_in">mclientFd</span>(clientFd)</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line">Connection::~<span class="built_in">Connection</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">closesocket</span>(mclientFd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> buf[<span class="number">1500000</span>];</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Connection::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> bufRecv[<span class="number">2000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="type">int</span> bufRecvSize = <span class="built_in">recv</span>(mclientFd, bufRecv, <span class="built_in">sizeof</span>(bufRecv), <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> uri[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;; <span class="comment">//index0.ts, index1.ts</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* sep = <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="type">char</span>* line = <span class="built_in">strtok</span>(bufRecv, sep); <span class="comment">//before sep</span></span><br><span class="line">    <span class="keyword">while</span> (line)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;GET&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;GET %s HTTP/1.1\r\n&quot;</span>, &amp;uri) != <span class="number">1</span>)</span><br><span class="line">                <span class="built_in">LOGE</span>(<span class="string">&quot;parse uri error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        line = <span class="built_in">strtok</span>(<span class="literal">nullptr</span>, sep); <span class="comment">//after sep</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;uri = %s\n&quot;</span>, uri);</span><br><span class="line"></span><br><span class="line">    std::string filename = <span class="string">&quot;D:/ffmpeg/learn/m3u8/test&quot;</span> + std::<span class="built_in">string</span>(uri);</span><br><span class="line">    FILE* fp = <span class="built_in">fopen</span>(filename.<span class="built_in">data</span>(), <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;fopen error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> buflen = <span class="built_in">fread</span>(buf, <span class="number">1</span>, <span class="built_in">sizeof</span>(buf), fp);</span><br><span class="line">    <span class="built_in">LOGI</span>(<span class="string">&quot;buflen = %d&quot;</span>, buflen);</span><br><span class="line">    <span class="keyword">if</span> (fp) <span class="built_in">fclose</span>(fp);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> http_headers[<span class="number">2000</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="string">&quot;/index.m3u8&quot;</span>, uri) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(http_headers, <span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Access-Control-Allow-Origin: * \r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Connection: keep-alive\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Content-Length: %d\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Content-Type: application/vnd.apple.mpegurl; charset=utf-8\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Keep-Alive: timeout=30, max=100\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Server: hlsServer\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\r\n&quot;</span>,</span><br><span class="line">            buflen);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(http_headers, <span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Access-Control-Allow-Origin: * \r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Connection: close\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Content-Length: %d\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Content-Type: video/mp2t; charset=utf-8\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Keep-Alive: timeout=30, max=100\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Server: hlsServer\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\r\n&quot;</span>,</span><br><span class="line">            buflen);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">send</span>(mclientFd, http_headers, <span class="built_in">strlen</span>(http_headers), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">send</span>(mclientFd, buf, buflen, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">Sleep</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><em><strong>抓包分析</strong></em></p>
<p><img src="/img/rtmp1.png"></p>
<hr>
<h1 id="4-Http-Flv-Server-demo"><a href="#4-Http-Flv-Server-demo" class="headerlink" title="4. Http-Flv Server(demo)"></a>4. Http-Flv Server(demo)</h1><h2 id="4-1-ffmpeg命令-mp4转flv"><a href="#4-1-ffmpeg命令-mp4转flv" class="headerlink" title="4.1 ffmpeg命令 mp4转flv"></a>4.1 ffmpeg命令 mp4转flv</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg.exe -i source.mp4 -c:v libx264 -crf 24 destination.flv</span><br></pre></td></tr></table></figure>

<h2 id="4-2-源码"><a href="#4-2-源码" class="headerlink" title="4.2 源码"></a>4.2 源码</h2><blockquote>
<p>Log.h</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable : 4996)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> std::string <span class="title">Get_CurTime</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* fmt = <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">time_t</span> t = <span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="type">char</span> str[<span class="number">64</span>];</span><br><span class="line">    <span class="built_in">strftime</span>(str, <span class="built_in">sizeof</span>(str), fmt, <span class="built_in">localtime</span>(&amp;t));</span><br><span class="line">    <span class="function">std::string <span class="title">time</span><span class="params">(str)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> time;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGI(format, ...) \</span></span><br><span class="line"><span class="meta">fprintf(stderr, <span class="string">&quot;[INFO]%s [%s:%d %s()]&quot;</span> format<span class="string">&quot;\n&quot;</span>, Get_CurTime().data(), __FILE__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGE(format, ...) \</span></span><br><span class="line"><span class="meta">fprintf(stderr, <span class="string">&quot;[ERROR]%s [%s:%d %s()]&quot;</span> format<span class="string">&quot;\n&quot;</span>, Get_CurTime().data(), __FILE__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>main.cpp</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Log.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> port = <span class="number">8080</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* filename = <span class="string">&quot;D:/ffmpeg/learn/test.flv&quot;</span>;</span><br><span class="line"></span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;WSAStartup error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    SOCKADDR_IN sockAddr;</span><br><span class="line">    sockAddr.sin_family = AF_INET;</span><br><span class="line">    sockAddr.sin_addr.S_un.S_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    sockAddr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line"></span><br><span class="line">    SOCKET serverFd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(serverFd, (SOCKADDR*)&amp;sockAddr, <span class="built_in">sizeof</span>(SOCKADDR)) == SOCKET_ERROR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;socket bind error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">listen</span>(serverFd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;socket listen error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Expires 设置资源的有效期来控制http的缓存</span></span><br><span class="line">    <span class="comment">//pragma 用于客户端发送的请求中, 客户端会要求所有的中间服务器不返回缓存的资源</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> http_headers[] = \</span><br><span class="line">        <span class="string">&quot;HTTP/1.1 200 OK\r\n&quot;</span> \</span><br><span class="line">        <span class="string">&quot;Access-Control-Allow-Origin: * \r\n&quot;</span> \</span><br><span class="line">        <span class="string">&quot;Content-Type: video/x-flv\r\n&quot;</span> \</span><br><span class="line">        <span class="string">&quot;Content-Length: -1\r\n&quot;</span> \</span><br><span class="line">        <span class="string">&quot;Connection: Keep-Alive\r\n&quot;</span> \</span><br><span class="line">        <span class="string">&quot;Expires: -1\r\n&quot;</span> \</span><br><span class="line">        <span class="string">&quot;Pragma: no-cache\r\n&quot;</span> \</span><br><span class="line">        <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">    <span class="type">int</span> http_headersLen = <span class="built_in">strlen</span>(http_headers);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGI</span>(<span class="string">&quot;wait connection&quot;</span>);</span><br><span class="line">        <span class="type">int</span> len = <span class="built_in">sizeof</span>(SOCKADDR);</span><br><span class="line">        SOCKADDR_IN accept_addr;</span><br><span class="line">        <span class="type">int</span> clientFd = <span class="built_in">accept</span>(serverFd, (SOCKADDR*)&amp;accept_addr, &amp;len);</span><br><span class="line">        <span class="keyword">if</span> (clientFd == SOCKET_ERROR)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOGE</span>(<span class="string">&quot;accept connection error&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">LOGI</span>(<span class="string">&quot;new connetion clientFd = %d&quot;</span>, clientFd);</span><br><span class="line"></span><br><span class="line">        FILE* fp = <span class="built_in">fopen</span>(filename, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!fp) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> buf[<span class="number">5000</span>];</span><br><span class="line">        <span class="type">char</span> bufRecv[<span class="number">2000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="type">int</span> times = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ++times;</span><br><span class="line">            <span class="keyword">if</span> (times == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">int</span> bufRecvSize = <span class="built_in">recv</span>(clientFd, bufRecv, <span class="number">2000</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="built_in">LOGI</span>(<span class="string">&quot;bufRecvSize = %d, bufRecv =\n%s&quot;</span>, bufRecvSize, bufRecv);</span><br><span class="line">                <span class="built_in">send</span>(clientFd, http_headers, http_headersLen, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">Sleep</span>(<span class="number">10</span>);</span><br><span class="line">                <span class="type">int</span> bufLen = <span class="built_in">fread</span>(buf, <span class="number">1</span>, <span class="built_in">sizeof</span>(buf), fp);</span><br><span class="line">                <span class="type">int</span> ret = <span class="built_in">send</span>(clientFd, (<span class="type">char</span>*)buf, bufLen, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (ret &lt;= <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fp) <span class="built_in">fclose</span>(fp);</span><br><span class="line">        <span class="built_in">closesocket</span>(clientFd);</span><br><span class="line">        <span class="built_in">LOGI</span>(<span class="string">&quot;close connect clientFd = %d&quot;</span>, clientFd);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">closesocket</span>(serverFd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>抓包分析</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffplay -i http://127.0.0.1:8080</span><br></pre></td></tr></table></figure>

<p><img src="/img/rtmp2.png"></p>
<p>与运行结果一致<br><img src="/img/rtmp3.png"></p>
<hr>
<h1 id="5-RTMPServer"><a href="#5-RTMPServer" class="headerlink" title="5. RTMPServer"></a>5. RTMPServer</h1><h2 id="5-1-RTMP协议推流流程简介"><a href="#5-1-RTMP协议推流流程简介" class="headerlink" title="5.1 RTMP协议推流流程简介"></a>5.1 RTMP协议推流流程简介</h2><p>RTMP协议规范详细可看<code>rtmp_specification_1.0.pdf</code><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Kingfans/p/7083100.html">中文版</a></p>
<p>TCP三次握手后, RTMP协议的流媒体推流需经过以下步骤:</p>
<p><strong>握手</strong><br>RTMP连接都是以握手作为开始的<br>服务端与客户端需要通过3次交换报文完成握手,RTMP是由三个静态大小的块,而非可变的块<br>客户端与服务器发送相同的三个chunk,客户端发送c0,c1,c2,服务端发送s0,s1,s2</p>
<p><img src="/img/rtmp4.png"></p>
<blockquote>
<p>客户端发送 C0，C1 块，握手开始<br>服务端在发送 S0 和 S1 之前必须等待接收 C0, 也可等待 C1, 发送 S2 之前必须等待接收 C1<br>客户端在发送 C2 之前客户端必须等待接收 S1<br>客户端在发送任何数据之前客户端必须等待接收 S2<br>服务端在发送任何数据之前必须等待接收 C2.</p>
</blockquote>
<p><strong>RTMP建立连接</strong></p>
<p><img src="/img/rtmp5.png"></p>
<blockquote>
<ol>
<li>客户端发送<code>命令消息</code>中的连接(<code>connect</code>)到服务器，请求与一个服务应用实例建立连接。</li>
<li>服务器接收到连接命令消息后，发送确认窗口大小(<code>Window Acknowledgement Size</code>)协议消息到客户端，同时连接到连接命令中提到的<code>应用程序</code>, 并且发送设置带宽协议(<code>Set Peer Bandwidth</code>)消息到客户端。</li>
<li>客户端处理设置带宽协议(<code>Set Peer Bandwidth</code>)消息后，发送确认窗口大小(<code>Window Acknowledgement Size</code>)协议消息到服务器端。</li>
<li>服务器发送<code>用户控制消息</code>中的流开始(<code>Stream Begin</code>)消息到客户端, 并发送<code>命令消息</code>中的结果(<code>_result</code>)，通知客户端连接的状态。</li>
</ol>
</blockquote>
<p><strong>RTMP建流</strong></p>
<p><img src="/img/rtmp6.png"></p>
<blockquote>
<p>客户端在收到来自服务器的建流命令(<code>createstream</code>)的成功结果(<code>_result</code>)后发送<code>play</code>命令。<br>服务器在接收到<code>play</code>命令后，发送一个来设置块大小(<code>SetChunkSize</code>)消息。<br>再发送另一个用户控制消息，指定事件“流记录”(<code>StreamIsRecorded</code>)和<code>流ID</code>, 这个消息的头2字节携带事件类型，最后4字节携带流ID。<br>再发送另一个用户控制消息，指定事件“流开始”(<code>StreamBegin</code>)。向客户端指示流的开始。<br>如果客户端发送的播放(<code>play</code>)命令成功，服务器发送命令消息(<code>onStatus</code>)，<code>NeStream.Play.Start &amp; NeStream.Play.Reset</code>。<br>只有当客户端发送的<code>play</code>命令设置了<code>reset</code>标志时，服务器才会发送<code>NeStream.Play.Reset</code>。<br>如果没有找到要播放的流，服务器将发送<code>onStatus</code>消息<code>NeStream.Play.StreamNotFound</code>。<br>之后，客户端播放服务器发送的音频和视频数据</p>
</blockquote>
<p><em><strong>通过抓包理解</strong></em><br><img src="/img/rtmp7.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Client :</span><br><span class="line">connect(‘livetv’)</span><br><span class="line">#</span><br><span class="line">Server :</span><br><span class="line">Window Acknowledgement Size 5000000</span><br><span class="line">Set Peer Bandwidth 5000000,Dynamic</span><br><span class="line">Set Chunk Size 4096</span><br><span class="line">_result(‘NetConnection.Connect.Success’)</span><br><span class="line">#</span><br><span class="line">Client :</span><br><span class="line">Window Acknowledgement Size 5000000</span><br><span class="line">createStream()</span><br><span class="line">#</span><br><span class="line">Server :</span><br><span class="line">_result()</span><br><span class="line">#</span><br><span class="line">Client :</span><br><span class="line">getStreamLength()</span><br><span class="line">play(‘hunantv’)</span><br><span class="line">Set Buffer Length 1,3000ms</span><br><span class="line">#</span><br><span class="line">Server :</span><br><span class="line">Stream Begin 1</span><br><span class="line">onStatus(‘NetStream.Play.Start’)</span><br><span class="line">RtmpSampleAccess()</span><br><span class="line">onMetaData()</span><br><span class="line">#</span><br><span class="line">Server :</span><br><span class="line">Video Data</span><br><span class="line">Audio Data</span><br><span class="line">…</span><br></pre></td></tr></table></figure>


<h2 id="5-2-源码"><a href="#5-2-源码" class="headerlink" title="5.2 源码"></a>5.2 源码</h2><p><a target="_blank" rel="noopener" href="https://github.com/9TSe/RTMPServer">RTMPServer</a></p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/RTMP/">RTMP</a></div><div class="post_share"><div class="social-share" data-image="/pic/1.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2023/12/05/RTSP1/" title="RTSP"><img class="cover" src="/pic/1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">RTSP</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/pic/avater.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">9TSe</div><div class="author-info__description">难正经</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">47</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/9tse"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/9TSe" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:9TSewer@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">C++部分,Qt,Linux,文章摘于 https://subingwen.cn/</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%8D%8F%E8%AE%AE%E7%AE%80%E4%BB%8B"><span class="toc-text">1. 协议简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-RTMP"><span class="toc-text">1.1 RTMP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-HLS"><span class="toc-text">1.2 HLS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%AF%B9%E6%AF%94RTMP%EF%BC%8CHLS-HTTP-FLV"><span class="toc-text">1.3  对比RTMP，HLS, HTTP-FLV</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%B0%81%E8%A3%85%E7%AE%80%E4%BB%8B"><span class="toc-text">2. 封装简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-FLV"><span class="toc-text">2.1 FLV</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-TS"><span class="toc-text">2.2 TS</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-HLS-Server-demo"><span class="toc-text">3. HLS_Server(demo)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-ffmpeg-%E5%91%BD%E4%BB%A4%E7%94%9F%E6%88%90m3u8%E5%88%87%E7%89%87"><span class="toc-text">3.1 ffmpeg 命令生成m3u8切片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-text">3.2 源代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Http-Flv-Server-demo"><span class="toc-text">4. Http-Flv Server(demo)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-ffmpeg%E5%91%BD%E4%BB%A4-mp4%E8%BD%ACflv"><span class="toc-text">4.1 ffmpeg命令 mp4转flv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E6%BA%90%E7%A0%81"><span class="toc-text">4.2 源码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-RTMPServer"><span class="toc-text">5. RTMPServer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-RTMP%E5%8D%8F%E8%AE%AE%E6%8E%A8%E6%B5%81%E6%B5%81%E7%A8%8B%E7%AE%80%E4%BB%8B"><span class="toc-text">5.1 RTMP协议推流流程简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E6%BA%90%E7%A0%81"><span class="toc-text">5.2 源码</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/03/18/RTMP/" title="RTMP"><img src="/pic/1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RTMP"/></a><div class="content"><a class="title" href="/2024/03/18/RTMP/" title="RTMP">RTMP</a><time datetime="2024-03-18T04:14:50.000Z" title="发表于 2024-03-18 12:14:50">2024-03-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/05/RTSP1/" title="RTSP"><img src="/pic/1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RTSP"/></a><div class="content"><a class="title" href="/2023/12/05/RTSP1/" title="RTSP">RTSP</a><time datetime="2023-12-05T13:58:26.000Z" title="发表于 2023-12-05 21:58:26">2023-12-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/05/ffmpeg/" title="ffmpeg命令行简介"><img src="/pic/1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ffmpeg命令行简介"/></a><div class="content"><a class="title" href="/2023/12/05/ffmpeg/" title="ffmpeg命令行简介">ffmpeg命令行简介</a><time datetime="2023-12-05T13:37:52.000Z" title="发表于 2023-12-05 21:37:52">2023-12-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/27/%E9%9F%B3%E8%A7%86%E9%A2%911/" title="音视频入门"><img src="/pic/1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="音视频入门"/></a><div class="content"><a class="title" href="/2023/11/27/%E9%9F%B3%E8%A7%86%E9%A2%911/" title="音视频入门">音视频入门</a><time datetime="2023-11-27T14:24:43.000Z" title="发表于 2023-11-27 22:24:43">2023-11-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/27/algorithm-other/" title="代码随想录-补充篇"><img src="/pic/10.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="代码随想录-补充篇"/></a><div class="content"><a class="title" href="/2023/11/27/algorithm-other/" title="代码随想录-补充篇">代码随想录-补充篇</a><time datetime="2023-11-27T14:24:29.000Z" title="发表于 2023-11-27 22:24:29">2023-11-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 9TSe</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>