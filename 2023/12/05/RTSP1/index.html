<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>RTSP | NineTSe</title><meta name="author" content="NineTSe"><meta name="copyright" content="NineTSe"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1. RTSP协议简介 配置属性 -&gt; 调试 -&gt; 环境 :PATH&#x3D;D:\ffmpeg\ffmpeg-master-latest-win64-gpl-shared\bin;D:\ffmpeg\SDL2-2.28.5\lib\x64用分号来写多个路径,可以指定dll文件,不必再必须配置环境变量.配置属性 -&gt; VC++目录 -&gt; 包含目录 :D:\ffmpeg\S">
<meta property="og:type" content="article">
<meta property="og:title" content="RTSP">
<meta property="og:url" content="http://example.com/2023/12/05/RTSP1/index.html">
<meta property="og:site_name" content="NineTSe">
<meta property="og:description" content="1. RTSP协议简介 配置属性 -&gt; 调试 -&gt; 环境 :PATH&#x3D;D:\ffmpeg\ffmpeg-master-latest-win64-gpl-shared\bin;D:\ffmpeg\SDL2-2.28.5\lib\x64用分号来写多个路径,可以指定dll文件,不必再必须配置环境变量.配置属性 -&gt; VC++目录 -&gt; 包含目录 :D:\ffmpeg\S">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/pic/1.png">
<meta property="article:published_time" content="2023-12-05T13:58:26.000Z">
<meta property="article:modified_time" content="2024-03-18T04:32:47.257Z">
<meta property="article:author" content="NineTSe">
<meta property="article:tag" content="RTSP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/pic/1.png"><link rel="shortcut icon" href="/pic/12.png"><link rel="canonical" href="http://example.com/2023/12/05/RTSP1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'RTSP',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-18 12:32:47'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="NineTSe" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/pic/avater.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">70</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">45</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url('/pic/1.png')"><nav id="nav"><span id="blog-info"><a href="/" title="NineTSe"><img class="site-icon" src="/pic/9.png"/></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">RTSP</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-12-05T13:58:26.000Z" title="发表于 2023-12-05 21:58:26">2023-12-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-03-18T04:32:47.257Z" title="更新于 2024-03-18 12:32:47">2024-03-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9F%B3%E8%A7%86%E9%A2%91/">音视频</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="RTSP"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-RTSP协议简介"><a href="#1-RTSP协议简介" class="headerlink" title="1. RTSP协议简介"></a>1. RTSP协议简介</h1><blockquote>
<p>配置属性 -&gt; 调试 -&gt; 环境 :<br>PATH&#x3D;D:\ffmpeg\ffmpeg-master-latest-win64-gpl-shared\bin;D:\ffmpeg\SDL2-2.28.5\lib\x64<br>用分号来写多个路径,可以指定dll文件,不必再必须配置环境变量<br>.<br>配置属性 -&gt; VC++目录 -&gt; 包含目录 :<br>D:\ffmpeg\SDL2-2.28.5\include<br>D:\ffmpeg\ffmpeg-master-latest-win64-gpl-shared\include<br>D:\ffmpeg\vcpkg\include<br>.<br>配置属性 -&gt; VC++目录 -&gt; 库目录 :<br>D:\ffmpeg\ffmpeg-master-latest-win64-gpl-shared\lib<br>D:\ffmpeg\SDL2-2.28.5\lib\x64<br>D:\ffmpeg\vcpkg\lib<br>.<br>链接器 -&gt; 输入 -&gt; 附加依赖项 :<br>avcodec.lib<br>avdevice.lib<br>avfilter.lib<br>avformat.lib<br>avutil.lib<br>postproc.lib<br>swresample.lib<br>swscale.lib<br>SDL2.lib<br>SDL2main.lib<br>SDL2test.lib<br>fdk-aac.lib<br>zlib.lib<br>event.lib<br>event_core.lib<br>event_extra.lib</p>
</blockquote>
<h2 id="1-1-RTSP服务器基础框架"><a href="#1-1-RTSP服务器基础框架" class="headerlink" title="1.1 RTSP服务器基础框架"></a>1.1 RTSP服务器基础框架</h2><blockquote>
<p>以下代码并没有使用功能,只是通过wireshark进行抓包分析来了解RTSP协议的大致流程</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ws2_32.lib&quot;</span>) <span class="comment">//链接阶段将指定的库文件 ws2_32.lib 加入到当前项目中。(套接字编程的文件)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>( disable : 4996 )</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVER_PORT      8554</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVER_RTP_PORT  55532</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVER_RTCP_PORT 55533</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">CreateTcpSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> fd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="type">int</span> on = <span class="number">1</span>; <span class="comment">//在setsockopt中如果是1就会避免地址被占用的问题,帮助快速启动服务器</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//SOL_SOCKET 是一个常量，表示套接字级别的选项，适用于所有套接字类型，不限于特定的传输协议</span></span><br><span class="line">	<span class="comment">//如果是其他值,可能会代表,用于IPV6,4,TCP,UDP协议相关的选项</span></span><br><span class="line">	<span class="built_in">setsockopt</span>(fd, SOL_SOCKET, SO_REUSEADDR, (<span class="type">const</span> <span class="type">char</span>*)&amp;on, <span class="built_in">sizeof</span>(on));</span><br><span class="line">	<span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">BindSocketAddr</span><span class="params">(<span class="type">int</span> fd)</span> <span class="comment">//加上static封装函数,仅当前文件能够使用</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	sockaddr_in addr;</span><br><span class="line">	addr.sin_family = AF_INET;</span><br><span class="line">	addr.sin_port = <span class="built_in">htons</span>(SERVER_PORT);</span><br><span class="line">	addr.sin_addr.s_addr = INADDR_ANY; <span class="comment">//0 == 0.0.0.0(本机任意IP地址)</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">bind</span>(fd, (sockaddr*)&amp;addr, <span class="built_in">sizeof</span>(sockaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">AcceptClient</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span>* ip, <span class="type">int</span>* port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	sockaddr_in addr;</span><br><span class="line">	<span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="built_in">sizeof</span>(addr));</span><br><span class="line">	<span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(addr);</span><br><span class="line">	<span class="type">int</span> clientfd = <span class="built_in">accept</span>(fd, (sockaddr*)&amp;addr, &amp;len);</span><br><span class="line">	<span class="keyword">if</span> (clientfd &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="comment">//32位地址转换为点分十进制字符串</span></span><br><span class="line">	<span class="built_in">strcpy</span>(ip, <span class="built_in">inet_ntoa</span>(addr.sin_addr)); <span class="comment">//inet_ntop更安全(包括线程安全),但是参数更多</span></span><br><span class="line">	*port = <span class="built_in">ntohs</span>(addr.sin_port); <span class="comment">//转换为小端后存储</span></span><br><span class="line">	<span class="keyword">return</span> clientfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Handle_Option</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> cseq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">sprintf</span>(buf, <span class="string">&quot;RTSP/1.0 200 OK\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;CSeq: %d\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Public: OPTIONS, DESCRIBE, SETUP, PlAY\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;\r\n&quot;</span>,</span><br><span class="line">		cseq);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Handle_Describe</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> cseq, <span class="type">char</span>* url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span> sdp[<span class="number">500</span>];</span><br><span class="line">	<span class="type">char</span> local_ip[<span class="number">100</span>];</span><br><span class="line">	<span class="built_in">sscanf</span>(url, <span class="string">&quot;rtsp://%[^:]:&quot;</span>, local_ip); <span class="comment">//%[^:] 匹配除了:以外的任意字符</span></span><br><span class="line">	<span class="built_in">sprintf</span>(sdp, <span class="string">&quot;v=0\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;o=- 9%ld 1 IN IP4 %s\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;t=0 0\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;a=control:*\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;m=video 0 RTP/AVP 96\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;a=rtpmap:96 H264/90000\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;a=control:track0\r\n&quot;</span>,</span><br><span class="line">		<span class="built_in">time</span>(<span class="literal">NULL</span>), local_ip);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">sprintf</span>(buf, <span class="string">&quot;RTSP/1.0 200 OK\r\nCSeq: %d\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Content-Base: %s\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Content-type: application/sdp\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Content-length: %zu\r\n\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;%s&quot;</span>,</span><br><span class="line">		cseq,url,<span class="built_in">strlen</span>(sdp),sdp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Handle_Setup</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> cseq, <span class="type">int</span> rtp_port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">sprintf</span>(buf, <span class="string">&quot;RTSP/1.0 200 OK\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;CSeq: %d\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Transport: RTP/AVP;unicast;client_port=%d-%d;server_port=%d-%d\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Session: 66334873\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;\r\n&quot;</span>,</span><br><span class="line">		cseq, rtp_port, rtp_port + <span class="number">1</span>, SERVER_RTP_PORT, SERVER_RTCP_PORT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Handle_Play</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> cseq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">sprintf</span>(buf, <span class="string">&quot;RTSP/1.0 200 OK\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;CSeq: %d\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Range: npt=0.000-\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Session: 66334873; timeout=10\r\n\r\n&quot;</span>,</span><br><span class="line">		cseq);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">DoClient</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">char</span>* ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//客户端可能发送来的信息(请求) DESCRIBE rtsp ://127.0.0.1:8554/stream1 RTSP/1.0</span></span><br><span class="line">	<span class="type">char</span> method[<span class="number">40</span>]; <span class="comment">//DESCRIBE</span></span><br><span class="line">	<span class="type">char</span> url[<span class="number">100</span>]; <span class="comment">//rtsp://127.0.0.1:8554/stream1</span></span><br><span class="line">	<span class="type">char</span> version[<span class="number">40</span>]; <span class="comment">//RTSP/1.0</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> CSeq; <span class="comment">//请求中的序列号</span></span><br><span class="line">	<span class="type">int</span> client_Rtp_port;</span><br><span class="line">	<span class="type">int</span> client_Rtcp_port;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span>* r_buf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">10000</span>); <span class="comment">//读缓冲区,读取客户端数据</span></span><br><span class="line">	<span class="type">char</span>* w_buf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">10000</span>); <span class="comment">//写缓冲区,向客户端发送数据</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) <span class="comment">//more reuqest</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">int</span> recv_len = <span class="built_in">recv</span>(fd, r_buf, <span class="number">2000</span>, <span class="number">0</span>); <span class="comment">//从客户端(fd)中读取最多2000个数据到r_buf;</span></span><br><span class="line">		<span class="keyword">if</span> (recv_len &lt;= <span class="number">0</span>) <span class="comment">//return readed len</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		r_buf[recv_len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">		std::cout &lt;&lt; std::endl &lt;&lt; __FUNCTION__ &lt;&lt; <span class="string">&quot; r_buf  = &quot;</span> &lt;&lt; r_buf &lt;&lt; std::endl;</span><br><span class="line">		<span class="type">const</span> <span class="type">char</span>* sepe = <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		<span class="type">char</span>* line = <span class="built_in">strtok</span>(r_buf, sepe);</span><br><span class="line">		<span class="keyword">while</span> (line) <span class="comment">//only one request do</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;OPTIONS&quot;</span>) ||</span><br><span class="line">				<span class="built_in">strstr</span>(line, <span class="string">&quot;DESCRIBE&quot;</span>) ||</span><br><span class="line">				<span class="built_in">strstr</span>(line, <span class="string">&quot;SETUP&quot;</span>) ||</span><br><span class="line">				<span class="built_in">strstr</span>(line, <span class="string">&quot;PLAY&quot;</span>))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;%s %s %s\r\n&quot;</span>, method, url, version) != <span class="number">3</span>) <span class="comment">//return success args num</span></span><br><span class="line">				&#123;</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;sscanf method url version fail&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">					<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;CSeq&quot;</span>))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;CSeq: %d\r\n&quot;</span>, &amp;CSeq) != <span class="number">1</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;sscanf CSeq&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">					<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(line, <span class="string">&quot;Transport:&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;Transport:&quot;</span>))) <span class="comment">//suces</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;Transport: RTP/AVP/UDP;unicast;client_port=%d-%d\r\n&quot;</span>, &amp;client_Rtp_port, &amp;client_Rtcp_port) != <span class="number">2</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;sscanf 2 port fail&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">					<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			line = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, sepe);</span><br><span class="line">			<span class="comment">//nullptr</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;OPTIONS&quot;</span>))</span><br><span class="line">			<span class="built_in">Handle_Option</span>(w_buf, CSeq); <span class="comment">//no check</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;DESCRIBE&quot;</span>))</span><br><span class="line">			<span class="built_in">Handle_Describe</span>(w_buf, CSeq, url);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;SETUP&quot;</span>))</span><br><span class="line">			<span class="built_in">Handle_Setup</span>(w_buf, CSeq, client_Rtp_port);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;PLAY&quot;</span>))</span><br><span class="line">			<span class="built_in">Handle_Play</span>(w_buf, CSeq);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;nb method : &quot;</span> &lt;&lt; method &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">		std::cout &lt;&lt; std::endl &lt;&lt; __FUNCTION__ &lt;&lt; <span class="string">&quot;w_buf = &quot;</span> &lt;&lt; w_buf &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">send</span>(fd, w_buf, <span class="built_in">strlen</span>(w_buf), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;PLAY&quot;</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;start play\n&quot;</span> &lt;&lt; <span class="string">&quot;client ip:&quot;</span> &lt;&lt; ip &lt;&lt; std::endl &lt;&lt; <span class="string">&quot;client port:&quot;</span> &lt;&lt; client_Rtp_port &lt;&lt; std::endl;</span><br><span class="line">			<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//...</span></span><br><span class="line">				<span class="built_in">Sleep</span>(<span class="number">40</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">memset</span>(method, <span class="number">0</span>, <span class="built_in">sizeof</span>(method));</span><br><span class="line">		<span class="built_in">memset</span>(url, <span class="number">0</span>, <span class="built_in">sizeof</span>(url));</span><br><span class="line">		CSeq = <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="comment">//next while</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">closesocket</span>(fd);</span><br><span class="line">	<span class="built_in">free</span>(r_buf);</span><br><span class="line">	<span class="built_in">free</span>(w_buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	WSADATA winsock;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;winsock) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;winsock start error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> server_fd = <span class="built_in">CreateTcpSocket</span>();</span><br><span class="line">	<span class="keyword">if</span> (server_fd &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">WSACleanup</span>();</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;tcpsocket create fail&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">BindSocketAddr</span>(server_fd) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;bind fail&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">listen</span>(server_fd, <span class="number">128</span>) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;listen fail&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	std::cout &lt;&lt; __FILE__ &lt;&lt; <span class="string">&quot; rtsp://127.0.0.1:&quot;</span> &lt;&lt; SERVER_PORT &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">int</span> client_fd;</span><br><span class="line">		<span class="type">char</span> client_ip[<span class="number">40</span>];</span><br><span class="line">		<span class="type">int</span> client_port;</span><br><span class="line">		client_fd = <span class="built_in">AcceptClient</span>(server_fd, client_ip, &amp;client_port);</span><br><span class="line">		<span class="keyword">if</span> (client_fd &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;accept fail&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;accept client ip:&quot;</span> &lt;&lt; client_ip &lt;&lt; <span class="string">&quot; port:&quot;</span> &lt;&lt; client_port;</span><br><span class="line">		<span class="built_in">DoClient</span>(client_fd, client_ip, client_port);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">closesocket</span>(server_fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-2-分析抓包数据"><a href="#1-2-分析抓包数据" class="headerlink" title="1.2 分析抓包数据"></a>1.2 分析抓包数据</h2><p><code>以下服务器的回复抓包数据都是根据以上代码的接受发送数据决定的</code></p>
<p><img src="/img/rtsp1.png"></p>
<blockquote>
<p>客户端第一次发出请求(OPTIONS)<br>向服务器询问有那种请求方式</p>
</blockquote>
<p><img src="/img/rtsp2.png"></p>
<blockquote>
<p>服务器回应OPTIONS<br>服务器给出发出请求的方式</p>
</blockquote>
<p><img src="/img/rtsp3.png"></p>
<blockquote>
<p>客户端第二次发出请求(DESCRIBE)<br>请求指定流媒体的描述信息（<code>SDP</code>，Session Description Protocol）</p>
</blockquote>
<p><img src="/img/rtsp4.png"></p>
<blockquote>
<p>服务器回应DESCRIBE<br>回应会话描述(<code>SDP</code>) 返回流媒体的描述信息，包括媒体类型、编解码器、流地址等。</p>
</blockquote>
<p><img src="/img/rtsp5.png"></p>
<blockquote>
<p>客户端第三次发出请求(SETUP)<br>请求建立媒体流传输的通道<br>两个(RTCP和RTP通道)端口号</p>
</blockquote>
<p><img src="/img/rtsp6.png"></p>
<blockquote>
<p>服务器回应SETUP<br>返回确认或者错误消息。<br>在这个步骤中，可以指定传输协议（UDP、TCP、RTP 等）和端口号等参数。</p>
</blockquote>
<p><img src="/img/rtsp7.png"></p>
<blockquote>
<p>客户端第四次发出请求(PLAY)<br>请求开始播放流媒体</p>
</blockquote>
<p><img src="/img/rtsp8.png"></p>
<blockquote>
<p>服务器回应PLAY<br>接受请求，并开始向客户端发送媒体数据。</p>
</blockquote>
<p><img src="/img/rtsp9.png"></p>
<h1 id="2-UDP的RTP传输h264的RTSP服务器，能拉流播放"><a href="#2-UDP的RTP传输h264的RTSP服务器，能拉流播放" class="headerlink" title="2. UDP的RTP传输h264的RTSP服务器，能拉流播放"></a>2. UDP的RTP传输h264的RTSP服务器，能拉流播放</h1><blockquote>
<p>上一部分已经实现了一个<code>RTSP</code>协议交互的案例，客户端播放器能够向我们的RTSP服务端发起连接建立的请求，并且客户端在发起RTSP的<code>Play</code>请求以后，RTSP服务端也已经回复了<code>Play</code>请求的确认。</p>
</blockquote>
<p>这部分需要实现，客户端建立与RTSP服务端的连接后，并且在RTSP服务端回复了客户端的Play请求以后.<br>服务端需要源源不断的读取一个本地h264视频文件，并将读取到的h264视频流封装到RTP数据包中，再推送至客户端。<br>这样我们就实现了一个简单的支持RTSP协议流媒体分发服务。</p>
<p>问题的关键就是 <code>如何将H264封装到RTP数据包</code></p>
<h2 id="2-1-RTP理解"><a href="#2-1-RTP理解" class="headerlink" title="2.1 RTP理解"></a>2.1 RTP理解</h2><h3 id="2-1-1-RTP简述"><a href="#2-1-1-RTP简述" class="headerlink" title="2.1.1 RTP简述"></a>2.1.1 RTP简述</h3><p>RTP:实时传输协议（Real-time Transport Protocol或简写RTP）是一个网络传输协议.<br>RTP定义了两种报文：<code>RTP报文</code>和<code>RTCP报文</code></p>
<ul>
<li><code>RTP报文</code>用于传送媒体数据（如音频和视频,包括自定义类型,如字幕等）<br>它由 RTP报头和数据两部分组成，RTP数据部分称为有效载荷(payload)；</li>
<li><code>RTCP报文</code>用于传送控制信息，以实现协议控制功能。</li>
<li><code>RTP报文和RTCP报文</code>将作为下层协议的数据单元进行传输。<br><font color = red>如果使用UDP，则RTP报文和RTCP报文分别使用两个相邻的UDP端口，RTP报文使用低端口，RTCP报文使用高端口。</font><br>如果使用其它的下层协议，RTP报文和RTCP报文可以合并，放在一个数据单元中一起传送，控制<code>信息在前</code>，媒体<code>数据在后</code>。通常，RTP是由应用程序实现的。<br>eg: TCP作为协议时,RTP和RTCP甚至RTSP都是一个通道进行传输的</li>
</ul>
<p><img src="/img/rtsp10.png"></p>
<h3 id="2-1-2-RTP报文格式"><a href="#2-1-2-RTP报文格式" class="headerlink" title="2.1.2 RTP报文格式"></a>2.1.2 RTP报文格式</h3><ul>
<li><code>V</code>：RTP协议的版本号，占<code>2位</code><br>当前协议版本号为2。</li>
<li><code>P</code>：填充标志，占<code>1位</code><br>如果P&#x3D;1，则在该报文的尾部填充一个或多个额外的八位组，它们不是有效载荷的一部分。</li>
<li><code>X</code>：扩展标志，占<code>1位</code><br>如果X&#x3D;1，则在RTP报头后跟有一个扩展报头。</li>
<li><code>CC</code>：CSRC计数器，占<code>4位</code><br>指示CSRC 标识符的个数。</li>
<li><code>M</code>: 标记，占<code>1位</code>, 不同的有效载荷有不同的含义<br>对于视频，标记一帧的结束；<br>对于音频，标记会话的开始。</li>
<li><code>PT</code>: 有效载荷类型，占<code>7位</code><br>用于说明RTP报文中有效载荷的类型，如GSM音频、JPEM图像等。</li>
<li><code>序列号</code>：占<code>16位</code><br>用于标识发送者所发送的RTP报文的序列号，每发送一个报文，序列号增1。<br>接收者通过序列号来检测报文丢失情况，重新排序报文，恢复数据。</li>
<li><code>时戳(Timestamp)</code>：占<code>32位</code>，时戳反映了该RTP报文的第一个八位组的采样时刻。<br>接收者使用时戳来计算延迟和延迟抖动，并进行同步控制。</li>
<li><code>同步信源(SSRC)标识符</code>：占<code>32位</code>，用于标识同步信源。<br>该标识符是随机选择的，参加同一视频会议的两个同步信源不能有相同的SSRC。</li>
<li><code>特约信源(CSRC)标识符</code>：每个CSRC标识符占<code>32位</code>，可以有0～15个。<br>每个CSRC标识了包含在该RTP报文有效载荷中的所有特约信源。</li>
</ul>
<blockquote>
<p>每一行占4字节,32位</p>
</blockquote>
<p><img src="/img/rtsp11.png"></p>
<blockquote>
<p>视频会议,直播连麦等类似情况时(多路流汇成一路流),CSRC才会存在(多个SSRC汇集为CSRC)</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_VESION              2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_PAYLOAD_TYPE_H264   96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_PAYLOAD_TYPE_AAC    97</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_HEADER_SIZE         12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_MAX_PKT_SIZE        1400</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  *    0                   1                   2                   3</span></span><br><span class="line"><span class="comment">  *    7 6 5 4 3 2 1 0|7 6 5 4 3 2 1 0|7 6 5 4 3 2 1 0|7 6 5 4 3 2 1 0</span></span><br><span class="line"><span class="comment">  *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">  *   |V=2|P|X|  CC   |M|     PT      |       sequence number         |</span></span><br><span class="line"><span class="comment">  *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">  *   |                           timestamp                           |</span></span><br><span class="line"><span class="comment">  *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">  *   |           synchronization source (SSRC) identifier            |</span></span><br><span class="line"><span class="comment">  *   +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</span></span><br><span class="line"><span class="comment">  *   |            contributing source (CSRC) identifiers             |</span></span><br><span class="line"><span class="comment">  *   :                             ....                              :</span></span><br><span class="line"><span class="comment">  *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RtpHeader</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//位段中,定义的占位数是倒着来的,即在第0个字节中,最后四位是csrcLen</span></span><br><span class="line">    <span class="comment">/* byte 0 */</span></span><br><span class="line">    <span class="type">uint8_t</span> csrcLen : <span class="number">4</span>;<span class="comment">//CSRC计数器，占4位，指示 CSRC 标识符的个数。</span></span><br><span class="line">    <span class="type">uint8_t</span> extension : <span class="number">1</span>;<span class="comment">//占1位，如果X=1，则在RTP报头后跟有一个扩展报头。</span></span><br><span class="line">                        <span class="comment">//一般只有传输类型是非音频,非视频的自定义类型或许需要这个X=1</span></span><br><span class="line">    <span class="type">uint8_t</span> padding : <span class="number">1</span>;<span class="comment">//填充标志，占1位，如果P=1，则在该报文的尾部填充一个或多个额外的八位组</span></span><br><span class="line">                        <span class="comment">//它们不是有效载荷的一部分。</span></span><br><span class="line">    <span class="type">uint8_t</span> version : <span class="number">2</span>;<span class="comment">//RTP协议的版本号，占2位，当前协议版本号为2。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* byte 1 */</span></span><br><span class="line">    <span class="type">uint8_t</span> payloadType : <span class="number">7</span>;<span class="comment">//有效载荷类型，占7位，用于说明RTP报文中有效载荷的类型，如GSM音频、JPEM图像等。</span></span><br><span class="line">    <span class="type">uint8_t</span> marker : <span class="number">1</span>;<span class="comment">//标记，占1位，不同的有效载荷有不同的含义，对于视频，标记一帧的结束；</span></span><br><span class="line">                        <span class="comment">//对于音频，标记会话的开始。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* bytes 2,3 */</span></span><br><span class="line">    <span class="type">uint16_t</span> seq;<span class="comment">//占16位，用于标识发送者所发送的RTP报文的序列号，每发送一个报文(eg:每发送一帧)，序列号增1。</span></span><br><span class="line">                <span class="comment">//接收者通过序列号来检测报文丢失情况，重新排序报文，恢复数据。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* bytes 4-7 */</span></span><br><span class="line">    <span class="type">uint32_t</span> timestamp;<span class="comment">//占32位，时戳反映了该RTP报文的第一个八位组的采样时刻。</span></span><br><span class="line">                    <span class="comment">//接收者使用时戳来计算延迟和延迟抖动，并进行同步控制。(音视频进行同步)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* bytes 8-11 */</span></span><br><span class="line">    <span class="type">uint32_t</span> ssrc;<span class="comment">//占32位，用于标识同步信源。该标识符是随机选择的，参加同一视频会议的两个同步信源不能有相同的SSRC。</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/*标准的RTP Header 还可能存在 0-15个特约信源(CSRC)标识符</span></span><br><span class="line"><span class="comment">   </span></span><br><span class="line"><span class="comment">   每个CSRC标识符占32位，可以有0～15个。每个CSRC标识了包含在该RTP报文有效载荷中的所有特约信源</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//RTP包的结构体</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RtpPacket</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">RtpHeader</span> rtpHeader;</span><br><span class="line">    <span class="type">uint8_t</span> payload[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//包含一个RTP头部和RTP载荷</span></span><br></pre></td></tr></table></figure>

<h3 id="2-1-3-RTP包发送前缀"><a href="#2-1-3-RTP包发送前缀" class="headerlink" title="2.1.3 RTP包发送前缀"></a>2.1.3 RTP包发送前缀</h3><p>RTP，RTCP 数据和 RTSP 数据<code>共享</code> TCP 数据通道，所以必须有一个标识来区别三种数据。<br>RTP 和 <code>RTCP</code> 数据会以 <code>$符号 + 1 个字节的通道编号 + 2 个字节的数据长度</code> 共 4 个字节的前缀开始，RTSP 数据没有前缀数据</p>
<p><strong>RTP 数据和 RTCP 数据的区别在于第二个字节的通道编号, RTP 通道编号是偶数，RTCP通道编号是奇数。</strong></p>
<h2 id="2-2-H264理解"><a href="#2-2-H264理解" class="headerlink" title="2.2 H264理解"></a>2.2 H264理解</h2><h3 id="2-2-1-压缩方式"><a href="#2-2-1-压缩方式" class="headerlink" title="2.2.1 压缩方式"></a>2.2.1 压缩方式</h3><p>H264压缩技术主要采用了以下几种方法对视频数据进行压缩:</p>
<ul>
<li>帧内预测压缩，解决的是空域数据冗余问题。(eg:jpg) 不借助于其他数据</li>
<li>帧间预测压缩（运动估计与补偿），解决的是时域数据冗徐问题。</li>
<li>整数离散余弦变换（DCT），将空间上的相关性变为频域上无关的数据然后进行量化。</li>
<li>CABAC压缩。</li>
</ul>
<p>经过<code>压缩后</code>的帧分为：I帧，P帧和B帧:</p>
<ul>
<li>I帧：关键帧，采用<code>帧内压缩</code>技术。</li>
<li>P帧：向前参考帧，在压缩时，只参考前面已经处理的帧。<br>采用帧间压缩技术。占I帧的一半大小</li>
<li>B帧：双向参考帧，在压缩时，它即参考前而的帧，又参考它后面的帧。采用帧间压缩技术。占I帧1&#x2F;4大小</li>
<li>图像序列GOP(GOP组),将一个视频分为若干部分,防止因为部分帧损坏而导致视频崩盘.GOP至少有一个I帧</li>
</ul>
<blockquote>
<p>虽然B帧的压缩率是最高，但是他占用的CPU以及耗时非常多，既然耗时，在实时直播视频情况就会导致一个延迟的情况。<br>如果只是想减少空间大小，B帧将是一个很好的选择。<br>所以一般在直播中是没有B帧，只有I帧和P帧。</p>
</blockquote>
<p>IDR帧和I帧的关系。</p>
<p>IDR(Instantannous Decoder Refresh) 解码器立即刷新 </p>
<p>作用：在解码的过程，一旦有一帧数据出现错误，将是无法恢复的过程，后面数据帧不能使用。<br>当有了IDR帧，解码器收到IDR帧时，就会将<code>缓冲区的数据清空</code>，找到第一个IDR帧，重新解码。<br>I和IDR帧都使用<code>帧内预测</code>，在编码解码中为了方便，首个I帧要和其他I帧区别开，把<code>第一个I帧叫IDR</code>，这样方便控制编码和解码流程。<br>IDR帧必须是一个I帧，但是I帧不一定是IDR帧，这个帧出现的时候，是告诉解码器，可以清除掉所有的参考帧，这是一个全新的序列，新的<code>GOP</code>已经开始。I帧有被跨帧参考的可能,IDR不会。<br>每个GOP中的第一帧就是IDR帧。<br><code>IDR帧是一种特殊的I帧。</code></p>
<p>帧与分组的关系：</p>
<p><img src="/img/rtsp12.png"></p>
<h3 id="2-2-2-h264组成"><a href="#2-2-2-h264组成" class="headerlink" title="2.2.2 h264组成"></a>2.2.2 h264组成</h3><ol>
<li>网络提取层 (Network Abstraction Layer，<code>NAL</code>), 编码(压缩)后的流</li>
<li>视讯编码层 (Video Coding Layer，<code>VCL</code>), 产生NAL的过程</li>
</ol>
<h3 id="2-2-3-码流结构"><a href="#2-2-3-码流结构" class="headerlink" title="2.2.3 码流结构"></a>2.2.3 码流结构</h3><p>H.264的功能分为两层，视频编码层（VCL）和网络提取层（NAL）。<br>1.VCL数据即被压缩编码后的视频数据序列。<br>2.在VCL数据要封装到NAL单元中之后，才可以用来传输或存储。</p>
<p><img src="/img/rtsp13.png"></p>
<ul>
<li>SPS：序列参数集，作用于一系列连续的编码图像；</li>
<li>PPS：图像参数集，作用于编码视频序列中一个或多个独立的图像；</li>
</ul>
<p>NALU根据<code>nal_unit_type</code>的类型，可以分为：<br><code>VCL的NAL单元 </code>和 <code>非VCL的NAL单元</code></p>
<h2 id="2-3-解封装mp4生成h264文件"><a href="#2-3-解封装mp4生成h264文件" class="headerlink" title="2.3 解封装mp4生成h264文件"></a>2.3 解封装mp4生成h264文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i test.mp4 -codec copy -bsf: h264_mp4toannexb -f h264 test.h264</span><br></pre></td></tr></table></figure>


<h2 id="2-4-将H264封装到RTP数据包"><a href="#2-4-将H264封装到RTP数据包" class="headerlink" title="2.4 将H264封装到RTP数据包"></a>2.4 将H264封装到RTP数据包</h2><p>H.264由一个一个的NALU组成，每个NALU之间使用<code>00 00 00 01</code>或<code>00 00 01</code>分隔开，每个NALU的第一次字节都有特殊的含义,</p>
<p><img src="/img/rtsp14.png"></p>
<p><img src="/img/rtsp15.png"></p>
<ol>
<li><code>F(forbiden):禁止位</code>，占用NAL头的第一个位，当禁止位值为1时表示语法错误；</li>
<li><code>NRI:参考级别</code>，占用NAL头的第二到第三个位；值越大，该NAL越重要。</li>
<li><code>Type:Nal单元数据类型</code>，也就是标识该NAL单元的数据类型是哪种，占用NAL头的第四到第8个位；</li>
</ol>
<p>常用Nalu_type：</p>
<ul>
<li><p>0x06 (0 00 00110) <code>SEI</code>      type &#x3D; 6<br>0x67 (0 11 00111) <code>SPS</code>     type &#x3D; 7<br>0x68 (0 11 01000) <code>PPS</code>      type &#x3D; 8</p>
</li>
<li><p>0x65 (0 11 00101) <code>IDR</code>      type &#x3D; 5<br>0x61 (0 11 00001) <code>I帧</code>      type &#x3D; 1<br>0x41 (0 10 00001) <code>P帧</code>     type &#x3D; 1<br>0x01 (0 00 00001) <code>B帧</code>     type &#x3D; 1</p>
</li>
</ul>
<p><img src="/img/rtsp16.png"></p>
<p>对于H.264格式了解这些就够了，我们的目的是想从一个H.264的文件中将一个一个的NALU提取出来，然后封装成RTP包，下面介绍如何将NALU封装成RTP包。</p>
<p> H.264可以由三种RTP打包方式</p>
<ul>
<li><p><code>单NALU打包</code>： 一个RTP包包含一个完整的NALU</p>
</li>
<li><p><code>聚合打包</code>：对于较小的NALU，一个RTP包可包含多个完整的NALU</p>
</li>
<li><p><code>分片打包</code>：对于较大的NALU，一个NALU可以分为多个RTP包发送</p>
</li>
</ul>
<p><code>注意</code>：这里要区分好概念，每一个RTP包都包含一个RTP头部和RTP荷载，这是固定的。而H.264发送数据可支持三种RTP打包方式</p>
<p>比较常用的是单NALU打包和分片打包，这里只介绍两种</p>
<p><strong>单NALU打包</strong><br>所谓单NALU打包就是将一整个NALU的数据放入RTP包的载荷中，这是最简单的一种方式。</p>
<p><strong>分片打包</strong><br>每个RTP包都有大小限制的，因为RTP一般都是使用UDP发送，UDP没有流量控制，所以要限制每一次发送的大小，所以如果一个NALU的太大，就需要分成多个RTP包发送，至于如何分成多个RTP包，如下：</p>
<p>首先要明确，RTP包的格式是绝不会变的，永远多是RTP头+RTP载荷</p>
<p><img src="/img/rtsp17.png"></p>
<p>RTP头部是固定的，那么只能在RTP载荷中去添加额外信息来说明这个RTP包是表示同一个NALU<br>如果是分片打包的话，那么在RTP载荷开始有两个字节的信息，然后再是NALU的内容</p>
<p><img src="/img/rtsp18.png"></p>
<p>第一个字节位<code>FU Indicator</code>，其格式如下</p>
<p><img src="/img/rtsp19.png"></p>
<p>高三位：与NALU第一个字节的高三位相同<br>Type：<code>28</code>，表示该RTP包一个分片，为什么是28？<br>因为H.264的规范中定义的，此外还有许多其他Type</p>
<p>第二个字节位<code>FU Header</code>，其格式如下</p>
<p><img src="/img/rtsp20.png"></p>
<p>S：标记该分片打包的第一个RTP包<br>E：比较该分片打包的最后一个RTP包<br>Type：NALU的Type</p>
<h2 id="2-5-代码实现"><a href="#2-5-代码实现" class="headerlink" title="2.5 代码实现"></a>2.5 代码实现</h2><blockquote>
<p>rtp.h</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#pragma once</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_VESION              2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_PAYLOAD_TYPE_H264   96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_PAYLOAD_TYPE_AAC    97</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_HEADER_SIZE         12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_MAX_PKT_SIZE        1400</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *    0                   1                   2                   3</span></span><br><span class="line"><span class="comment"> *    7 6 5 4 3 2 1 0|7 6 5 4 3 2 1 0|7 6 5 4 3 2 1 0|7 6 5 4 3 2 1 0</span></span><br><span class="line"><span class="comment"> *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment"> *   |V=2|P|X|  CC   |M|     PT      |       sequence number         |</span></span><br><span class="line"><span class="comment"> *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment"> *   |                           timestamp                           |</span></span><br><span class="line"><span class="comment"> *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment"> *   |           synchronization source (SSRC) identifier            |</span></span><br><span class="line"><span class="comment"> *   +=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+</span></span><br><span class="line"><span class="comment"> *   |            contributing source (CSRC) identifiers             |</span></span><br><span class="line"><span class="comment"> *   :                             ....                              :</span></span><br><span class="line"><span class="comment"> *   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RtpHeader</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* byte 0 */</span></span><br><span class="line">    <span class="type">uint8_t</span> csrcLen : <span class="number">4</span>;<span class="comment">//CSRC计数器，占4位，指示CSRC 标识符的个数。</span></span><br><span class="line">    <span class="type">uint8_t</span> extension : <span class="number">1</span>;<span class="comment">//占1位，如果X=1，则在RTP报头后跟有一个扩展报头。</span></span><br><span class="line">    <span class="type">uint8_t</span> padding : <span class="number">1</span>;<span class="comment">//填充标志，占1位，如果P=1，则在该报文的尾部填充一个或多个额外的八位组，它们不是有效载荷的一部分。</span></span><br><span class="line">    <span class="type">uint8_t</span> version : <span class="number">2</span>;<span class="comment">//RTP协议的版本号，占2位，当前协议版本号为2。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* byte 1 */</span></span><br><span class="line">    <span class="type">uint8_t</span> payloadType : <span class="number">7</span>;<span class="comment">//有效载荷类型，占7位，用于说明RTP报文中有效载荷的类型，如GSM音频、JPEM图像等。</span></span><br><span class="line">    <span class="type">uint8_t</span> marker : <span class="number">1</span>;<span class="comment">//标记，占1位，不同的有效载荷有不同的含义，对于视频，标记一帧的结束；对于音频，标记会话的开始。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* bytes 2,3 */</span></span><br><span class="line">    <span class="type">uint16_t</span> seq;<span class="comment">//占16位，用于标识发送者所发送的RTP报文的序列号，每发送一个报文，序列号增1。接收者通过序列号来检测报文丢失情况，重新排序报文，恢复数据。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* bytes 4-7 */</span></span><br><span class="line">    <span class="type">uint32_t</span> timestamp;<span class="comment">//占32位，时戳反映了该RTP报文的第一个八位组的采样时刻。接收者使用时戳来计算延迟和延迟抖动，并进行同步控制。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* bytes 8-11 */</span></span><br><span class="line">    <span class="type">uint32_t</span> ssrc;<span class="comment">//占32位，用于标识同步信源。该标识符是随机选择的，参加同一视频会议的两个同步信源不能有相同的SSRC。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*标准的RTP Header 还可能存在 0-15个特约信源(CSRC)标识符</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    每个CSRC标识符占32位，可以有0～15个。每个CSRC标识了包含在该RTP报文有效载荷中的所有特约信源</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RtpPacket</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">RtpHeader</span> rtpHeader;</span><br><span class="line">    <span class="type">uint8_t</span> payload[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">RtpHeaderInit</span><span class="params">(<span class="keyword">struct</span> RtpPacket* rtpPacket, <span class="type">uint8_t</span> csrcLen, <span class="type">uint8_t</span> extension,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint8_t</span> padding, <span class="type">uint8_t</span> version, <span class="type">uint8_t</span> payloadType, <span class="type">uint8_t</span> marker,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint16_t</span> seq, <span class="type">uint32_t</span> timestamp, <span class="type">uint32_t</span> ssrc)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">RtpSendPacketOverTcp</span><span class="params">(<span class="type">int</span> clientSockfd, <span class="keyword">struct</span> RtpPacket* rtpPacket, <span class="type">uint32_t</span> dataSize)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">RtpSendPacketOverUdp</span><span class="params">(<span class="type">int</span> serverRtpSockfd, <span class="type">const</span> <span class="type">char</span>* ip, <span class="type">int16_t</span> port, <span class="keyword">struct</span> RtpPacket* rtpPacket, <span class="type">uint32_t</span> dataSize)</span></span>;</span><br></pre></td></tr></table></figure>


<blockquote>
<p>rtp.cpp</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rtp.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">RtpHeaderInit</span><span class="params">(RtpPacket* rtpPacket, <span class="type">uint8_t</span> csrcLen, <span class="type">uint8_t</span> extension,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint8_t</span> padding, <span class="type">uint8_t</span> version, <span class="type">uint8_t</span> payloadType, <span class="type">uint8_t</span> marker,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint16_t</span> seq, <span class="type">uint32_t</span> timestamp, <span class="type">uint32_t</span> ssrc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.csrcLen = csrcLen;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.extension = extension;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.padding = padding;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.version = version;</span><br><span class="line"></span><br><span class="line">    rtpPacket-&gt;rtpHeader.payloadType = payloadType;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.marker = marker;</span><br><span class="line"></span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq = seq;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp = timestamp;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.ssrc = ssrc;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">RtpSendPacketOverTcp</span><span class="params">(<span class="type">int</span> clientSockfd, <span class="keyword">struct</span> RtpPacket* rtpPacket, <span class="type">uint32_t</span> dataSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq = <span class="built_in">htons</span>(rtpPacket-&gt;rtpHeader.seq);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp = <span class="built_in">htonl</span>(rtpPacket-&gt;rtpHeader.timestamp);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.ssrc = <span class="built_in">htonl</span>(rtpPacket-&gt;rtpHeader.ssrc);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> rtpSize = RTP_HEADER_SIZE + dataSize;</span><br><span class="line">    <span class="type">char</span>* tempBuf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">4</span> + rtpSize);</span><br><span class="line">    tempBuf[<span class="number">0</span>] = <span class="number">0x24</span>;<span class="comment">//$ </span></span><br><span class="line">    tempBuf[<span class="number">1</span>] = <span class="number">0x00</span>;</span><br><span class="line">    tempBuf[<span class="number">2</span>] = (<span class="type">uint8_t</span>)(((rtpSize) &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span>);</span><br><span class="line">    tempBuf[<span class="number">3</span>] = (<span class="type">uint8_t</span>)((rtpSize) &amp; <span class="number">0xFF</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(tempBuf + <span class="number">4</span>, (<span class="type">char</span>*)rtpPacket, rtpSize);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">send</span>(clientSockfd, tempBuf, <span class="number">4</span> + rtpSize, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq = <span class="built_in">ntohs</span>(rtpPacket-&gt;rtpHeader.seq);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp = <span class="built_in">ntohl</span>(rtpPacket-&gt;rtpHeader.timestamp);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.ssrc = <span class="built_in">ntohl</span>(rtpPacket-&gt;rtpHeader.ssrc);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(tempBuf);</span><br><span class="line">    tempBuf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">RtpSendPacketOverUdp</span><span class="params">(<span class="type">int</span> serverRtpSockfd, <span class="type">const</span> <span class="type">char</span>* ip, <span class="type">int16_t</span> port, RtpPacket* rtpPacket, <span class="type">uint32_t</span> dataSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sockaddr_in addr;</span><br><span class="line"></span><br><span class="line">    addr.sin_family = AF_INET;</span><br><span class="line">    addr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    addr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip);</span><br><span class="line"></span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq = <span class="built_in">htons</span>(rtpPacket-&gt;rtpHeader.seq);<span class="comment">//从主机字节顺序转变成网络字节顺序</span></span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp = <span class="built_in">htonl</span>(rtpPacket-&gt;rtpHeader.timestamp);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.ssrc = <span class="built_in">htonl</span>(rtpPacket-&gt;rtpHeader.ssrc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从rtpPacket指针缓冲区读取数据,通过fd发送至sockaddr结构体中的位置</span></span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">sendto</span>(serverRtpSockfd, (<span class="type">char</span>*)rtpPacket, dataSize + RTP_HEADER_SIZE, <span class="number">0</span>, (sockaddr*)&amp;addr, <span class="built_in">sizeof</span>(addr));</span><br><span class="line"></span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq = <span class="built_in">ntohs</span>(rtpPacket-&gt;rtpHeader.seq);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp = <span class="built_in">ntohl</span>(rtpPacket-&gt;rtpHeader.timestamp);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.ssrc = <span class="built_in">ntohl</span>(rtpPacket-&gt;rtpHeader.ssrc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>main.cpp</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关于程序ffplay后速度和帧率都比较small的解释</span></span><br><span class="line"><span class="comment">//因为这个案例中读取h264码流的时候，每次读取一个nalu就会封装一次rtp包并发送，</span></span><br><span class="line"><span class="comment">//但事实上读取到一个nalu并不是对应一个视频帧，可能是sps，也可能是pps，也可能是其他类型的nalu，</span></span><br><span class="line"><span class="comment">//事实上这些nalu都不允许参与到休眠间隔时间的。所以sleep = 40，肯定会慢的，sleep = 20，肯定会快的。</span></span><br><span class="line"><span class="comment">//只有准确判断nalu类型，再进行封装rtp。 这个例子只是演示这样服务的原理，并没有处理这些细节。</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>( disable : 4996 )</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rtp.h&quot;</span></span></span><br><span class="line"><span class="comment">//#pragma warning( disable : 4996 )</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> H264_FILE_NAME   <span class="string">&quot;D:\\ffmpeg\\learn\\test.h264&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVER_PORT      8554</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVER_RTP_PORT  55532</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVER_RTCP_PORT 55533</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_MAX_SIZE     (1024*1024)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">CreateTcpSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> fd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="type">int</span> on = <span class="number">1</span>; </span><br><span class="line">	<span class="built_in">setsockopt</span>(fd, SOL_SOCKET, SO_REUSEADDR, (<span class="type">const</span> <span class="type">char</span>*)&amp;on, <span class="built_in">sizeof</span>(on));</span><br><span class="line">	<span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">CreateUdpSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> fd = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="type">int</span> on = <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">setsockopt</span>(fd, SOL_SOCKET, SO_REUSEADDR, (<span class="type">const</span> <span class="type">char</span>*)&amp;on, <span class="built_in">sizeof</span>(on));</span><br><span class="line">	<span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">BindSocketAddr</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> port)</span> <span class="comment">//加上static封装函数,仅当前文件能够使用</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	sockaddr_in addr;</span><br><span class="line">	addr.sin_family = AF_INET;</span><br><span class="line">	addr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">	addr.sin_addr.s_addr = INADDR_ANY; <span class="comment">//0 == 0.0.0.0(本机任意IP地址)</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">bind</span>(fd, (sockaddr*)&amp;addr, <span class="built_in">sizeof</span>(sockaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">AcceptClient</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span>* ip, <span class="type">int</span>* port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	sockaddr_in addr;</span><br><span class="line">	<span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="built_in">sizeof</span>(addr));</span><br><span class="line">	<span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(addr);</span><br><span class="line">	<span class="type">int</span> clientfd = <span class="built_in">accept</span>(fd, (sockaddr*)&amp;addr, &amp;len);</span><br><span class="line">	<span class="keyword">if</span> (clientfd &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="comment">//32位地址转换为点分十进制字符串</span></span><br><span class="line">	<span class="built_in">strcpy</span>(ip, <span class="built_in">inet_ntoa</span>(addr.sin_addr)); <span class="comment">//inet_ntop更安全(包括线程安全),但是参数更多</span></span><br><span class="line">	*port = <span class="built_in">ntohs</span>(addr.sin_port); <span class="comment">//转换为小端后存储</span></span><br><span class="line">	<span class="keyword">return</span> clientfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Handle_Option</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> cseq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">sprintf</span>(buf, <span class="string">&quot;RTSP/1.0 200 OK\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;CSeq: %d\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Public: OPTIONS, DESCRIBE, SETUP, PlAY\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;\r\n&quot;</span>,</span><br><span class="line">		cseq);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Handle_Describe</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> cseq, <span class="type">char</span>* url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span> sdp[<span class="number">500</span>];</span><br><span class="line">	<span class="type">char</span> local_ip[<span class="number">100</span>];</span><br><span class="line">	<span class="built_in">sscanf</span>(url, <span class="string">&quot;rtsp://%[^:]:&quot;</span>, local_ip); <span class="comment">//%[^:] 匹配除了:以外的任意字符</span></span><br><span class="line">	<span class="built_in">sprintf</span>(sdp, <span class="string">&quot;v=0\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;o=- 9%ld 1 IN IP4 %s\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;t=0 0\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;a=control:*\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;m=video 0 RTP/AVP 96\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;a=rtpmap:96 H264/90000\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;a=control:track0\r\n&quot;</span>,</span><br><span class="line">		<span class="built_in">time</span>(<span class="literal">NULL</span>), local_ip);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">sprintf</span>(buf, <span class="string">&quot;RTSP/1.0 200 OK\r\nCSeq: %d\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Content-Base: %s\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Content-type: application/sdp\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Content-length: %zu\r\n\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;%s&quot;</span>,</span><br><span class="line">		cseq, url, <span class="built_in">strlen</span>(sdp), sdp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Handle_Setup</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> cseq, <span class="type">int</span> rtp_port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">sprintf</span>(buf, <span class="string">&quot;RTSP/1.0 200 OK\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;CSeq: %d\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Transport: RTP/AVP;unicast;client_port=%d-%d;server_port=%d-%d\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Session: 66334873\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;\r\n&quot;</span>,</span><br><span class="line">		cseq, rtp_port, rtp_port + <span class="number">1</span>, SERVER_RTP_PORT, SERVER_RTCP_PORT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Handle_Play</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> cseq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">sprintf</span>(buf, <span class="string">&quot;RTSP/1.0 200 OK\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;CSeq: %d\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Range: npt=0.000-\r\n&quot;</span></span><br><span class="line">		<span class="string">&quot;Session: 66334873; timeout=10\r\n\r\n&quot;</span>,</span><br><span class="line">		cseq);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title">StartCode3</span><span class="params">(<span class="type">char</span>* buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//每个nalu单元都以这个开头</span></span><br><span class="line">	<span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="number">0</span> &amp;&amp; buf[<span class="number">1</span>] == <span class="number">0</span> &amp;&amp; buf[<span class="number">2</span>] == <span class="number">1</span>) <span class="comment">//00 00 01</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title">StartCode4</span><span class="params">(<span class="type">char</span>* buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="number">0</span> &amp;&amp; buf[<span class="number">1</span>] == <span class="number">0</span> &amp;&amp; buf[<span class="number">2</span>] == <span class="number">0</span> &amp;&amp; buf[<span class="number">3</span>] == <span class="number">1</span>) <span class="comment">// 00 00 00 01</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">char</span>* <span class="title">FindNextStartCode</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (len &lt; <span class="number">3</span>) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len - <span class="number">3</span>; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">StartCode3</span>(buf) || <span class="built_in">StartCode4</span>(buf))</span><br><span class="line">			<span class="keyword">return</span> buf;</span><br><span class="line">		++buf;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//if (StartCode3(buf))</span></span><br><span class="line">		<span class="comment">//return buf; 可能冗余了,运行test</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">GetFrameFromH264File</span><span class="params">(FILE* fp, <span class="type">char</span>* frame, <span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> read_size, framesize;</span><br><span class="line">	<span class="type">char</span>* next_startcode;</span><br><span class="line"></span><br><span class="line">	read_size = <span class="built_in">fread</span>(frame, <span class="number">1</span>, size, fp); <span class="comment">//从fp读取size个1大小的数据到frame,fp指针此时会移动</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">StartCode3</span>(frame) &amp;&amp; !<span class="built_in">StartCode4</span>(frame)) <span class="comment">//none startcode</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	next_startcode = <span class="built_in">FindNextStartCode</span>(frame + <span class="number">3</span>, read_size - <span class="number">3</span>); <span class="comment">//返回起始码处的指针</span></span><br><span class="line">	<span class="keyword">if</span> (!next_startcode)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		framesize = (next_startcode - frame); <span class="comment">//返回起始的是3还是4</span></span><br><span class="line">		<span class="comment">//由于前面的fread所以要将fp重新偏移回下一个frame的起始位置</span></span><br><span class="line">		<span class="built_in">fseek</span>(fp, framesize - read_size, SEEK_CUR); <span class="comment">//fp指针相对于当前位置,偏移framesize - r_size</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> framesize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">RtpSendH264Frame</span><span class="params">(<span class="type">int</span> serverRtpSockfd, <span class="type">const</span> <span class="type">char</span>* ip, <span class="type">int16_t</span> port,</span></span></span><br><span class="line"><span class="params"><span class="function">			RtpPacket* rtpPacket, <span class="type">char</span>* frame, <span class="type">uint32_t</span> frameSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> sendBytes = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line">	<span class="comment">//H.264由一个一个的NALU组成，每个NALU之间使用00 00 00 01或00 00 01分隔开，每个NALU的第一次字节都有特殊的含义</span></span><br><span class="line">	<span class="type">uint8_t</span> naluType = frame[<span class="number">0</span>];</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;frame size = &quot;</span> &lt;&lt; frameSize &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (frameSize &lt;= RTP_MAX_PKT_SIZE) <span class="comment">// nalu长度小于最大包长：单一NALU单元模式</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//*   0 1 2 3 4 5 6 7 8 9</span></span><br><span class="line">		<span class="comment">//*  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line">		<span class="comment">//*  |F|NRI|  Type   | a single NAL unit ... |</span></span><br><span class="line">		<span class="comment">//*  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"></span><br><span class="line">		<span class="built_in">memcpy</span>(rtpPacket-&gt;payload, frame, frameSize); <span class="comment">//将有效数据传输给有效载荷</span></span><br><span class="line">		ret = <span class="built_in">RtpSendPacketOverUdp</span>(serverRtpSockfd, ip, port, rtpPacket, frameSize);</span><br><span class="line">		<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">		rtpPacket-&gt;rtpHeader.seq++; <span class="comment">//序号加一</span></span><br><span class="line">		sendBytes += ret;</span><br><span class="line">		<span class="comment">//0 00 11111 &amp; 0 11 00111 0 00 00111  </span></span><br><span class="line">		<span class="keyword">if</span> ((naluType &amp; <span class="number">0x1F</span>) == <span class="number">7</span> || (naluType &amp; <span class="number">0x1F</span>) == <span class="number">8</span>) <span class="comment">// 如果是SPS、PPS就不需要加时间戳</span></span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="comment">// nalu长度大于最大包场：分片模式</span></span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//*  0                   1                   2</span></span><br><span class="line">		<span class="comment">//*  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3</span></span><br><span class="line">		<span class="comment">//* +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line">		<span class="comment">//* | FU indicator  |   FU header   |   FU payload   ...  |</span></span><br><span class="line">		<span class="comment">//* +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//*     FU Indicator</span></span><br><span class="line">		<span class="comment">//*    0 1 2 3 4 5 6 7</span></span><br><span class="line">		<span class="comment">//*   +-+-+-+-+-+-+-+-+</span></span><br><span class="line">		<span class="comment">//*   |F|NRI|  Type   |</span></span><br><span class="line">		<span class="comment">//*   +---------------+</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//*      FU Header</span></span><br><span class="line">		<span class="comment">//*    0 1 2 3 4 5 6 7</span></span><br><span class="line">		<span class="comment">//*   +-+-+-+-+-+-+-+-+</span></span><br><span class="line">		<span class="comment">//*   |S|E|R|  Type   |</span></span><br><span class="line">		<span class="comment">//*   +---------------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="type">int</span> pktNum = frameSize / RTP_MAX_PKT_SIZE;       <span class="comment">// 有几个完整的包</span></span><br><span class="line">		<span class="type">int</span> remainPktSize = frameSize % RTP_MAX_PKT_SIZE; <span class="comment">// 剩余不完整包的大小</span></span><br><span class="line">		<span class="type">int</span> i, pos = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 发送完整的包</span></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pktNum; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// 0110 0000 | 0001 1100</span></span><br><span class="line">			<span class="comment">//分片打包载荷的第一个字节中,与NALU第一个字节的高三位相同,处理后, 0 ii 11100</span></span><br><span class="line">			rtpPacket-&gt;payload[<span class="number">0</span>] = (naluType &amp; <span class="number">0x60</span>) | <span class="number">28</span>; <span class="comment">//2,3位  第一位保持一直为0</span></span><br><span class="line">			<span class="comment">//0001 1111</span></span><br><span class="line">			rtpPacket-&gt;payload[<span class="number">1</span>] = naluType &amp; <span class="number">0x1F</span>; <span class="comment">//后5位,处理后 0 0 0 iiiii 代表既不是第一个也不是最后一个包</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (i == <span class="number">0</span>) <span class="comment">//第一包数据中的</span></span><br><span class="line">				rtpPacket-&gt;payload[<span class="number">1</span>] |= <span class="number">0x80</span>; <span class="comment">// start 0 1 0 00000 : S标为1代表是第一个包</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (remainPktSize == <span class="number">0</span> &amp;&amp; i == pktNum - <span class="number">1</span>) <span class="comment">//最后一个整包数据</span></span><br><span class="line">				rtpPacket-&gt;payload[<span class="number">1</span>] |= <span class="number">0x40</span>; <span class="comment">// end 0 0 1 00000 : E标为1代表是最后一个包</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">//frame就是NALU类型,第一个字节是header,给予了RTP格式的前两位信息后,RTP之后就是数据,这个数据就从NALU+1,跳过header得到</span></span><br><span class="line">			<span class="built_in">memcpy</span>(rtpPacket-&gt;payload + <span class="number">2</span>, frame + pos, RTP_MAX_PKT_SIZE); <span class="comment">//由于前两个字节是载荷的信息不是有效数据</span></span><br><span class="line">			ret = <span class="built_in">RtpSendPacketOverUdp</span>(serverRtpSockfd, ip, port, rtpPacket, RTP_MAX_PKT_SIZE + <span class="number">2</span>);</span><br><span class="line">			<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">			rtpPacket-&gt;rtpHeader.seq++;</span><br><span class="line">			sendBytes += ret;</span><br><span class="line">			pos += RTP_MAX_PKT_SIZE;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 发送剩余的数据</span></span><br><span class="line">		<span class="keyword">if</span> (remainPktSize &gt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			rtpPacket-&gt;payload[<span class="number">0</span>] = (naluType &amp; <span class="number">0x60</span>) | <span class="number">28</span>;</span><br><span class="line">			rtpPacket-&gt;payload[<span class="number">1</span>] = naluType &amp; <span class="number">0x1F</span>;</span><br><span class="line">			rtpPacket-&gt;payload[<span class="number">1</span>] |= <span class="number">0x40</span>; <span class="comment">//end</span></span><br><span class="line"></span><br><span class="line">			<span class="built_in">memcpy</span>(rtpPacket-&gt;payload + <span class="number">2</span>, frame + pos, remainPktSize + <span class="number">2</span>);</span><br><span class="line">			ret = <span class="built_in">RtpSendPacketOverUdp</span>(serverRtpSockfd, ip, port, rtpPacket, remainPktSize + <span class="number">2</span>);</span><br><span class="line">			<span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">			rtpPacket-&gt;rtpHeader.seq++;</span><br><span class="line">			sendBytes += ret;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	rtpPacket-&gt;rtpHeader.timestamp += <span class="number">90000</span> / <span class="number">25</span>; <span class="comment">//  一秒定义为90000的单位 / 帧数 加时间戳</span></span><br><span class="line">out:</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sendBytes;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">DoClient</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">char</span>* ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span> method[<span class="number">40</span>],url[<span class="number">100</span>],version[<span class="number">40</span>];</span><br><span class="line">	<span class="type">int</span> CSeq, client_Rtp_port, client_Rtcp_port;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> server_Rtp_fd = <span class="number">-1</span>;</span><br><span class="line">	<span class="type">int</span> server_Rtcp_fd = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span>* r_buf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(BUF_MAX_SIZE); <span class="comment">//读缓冲区,读取客户端数据</span></span><br><span class="line">	<span class="type">char</span>* w_buf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(BUF_MAX_SIZE); <span class="comment">//写缓冲区,向客户端发送数据</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">int</span> recv_len = <span class="built_in">recv</span>(fd, r_buf, BUF_MAX_SIZE, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (recv_len &lt;= <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">		r_buf[recv_len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">		std::cout &lt;&lt; std::endl &lt;&lt; __FUNCTION__ &lt;&lt; <span class="string">&quot; r_buf  = &quot;</span> &lt;&lt; r_buf &lt;&lt; std::endl;</span><br><span class="line">		<span class="type">const</span> <span class="type">char</span>* sepe = <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">		<span class="type">char</span>* line = <span class="built_in">strtok</span>(r_buf, sepe);</span><br><span class="line">		<span class="keyword">while</span> (line)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;OPTIONS&quot;</span>) ||</span><br><span class="line">				<span class="built_in">strstr</span>(line, <span class="string">&quot;DESCRIBE&quot;</span>) ||</span><br><span class="line">				<span class="built_in">strstr</span>(line, <span class="string">&quot;SETUP&quot;</span>) ||</span><br><span class="line">				<span class="built_in">strstr</span>(line, <span class="string">&quot;PLAY&quot;</span>))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;%s %s %s\r\n&quot;</span>, method, url, version) != <span class="number">3</span>) <span class="comment">//return success args num</span></span><br><span class="line">				&#123;</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;sscanf method url version fail&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">					<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;CSeq&quot;</span>))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;CSeq: %d\r\n&quot;</span>, &amp;CSeq) != <span class="number">1</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;sscanf CSeq&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">					<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(line, <span class="string">&quot;Transport:&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;Transport:&quot;</span>))) <span class="comment">//suces</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;Transport: RTP/AVP/UDP;unicast;client_port=%d-%d\r\n&quot;</span>, &amp;client_Rtp_port, &amp;client_Rtcp_port) != <span class="number">2</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;sscanf 2 port fail&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">					<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			line = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, sepe);</span><br><span class="line">			<span class="comment">//nullptr</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;OPTIONS&quot;</span>))</span><br><span class="line">			<span class="built_in">Handle_Option</span>(w_buf, CSeq); <span class="comment">//no check</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;DESCRIBE&quot;</span>))</span><br><span class="line">			<span class="built_in">Handle_Describe</span>(w_buf, CSeq, url);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;SETUP&quot;</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">Handle_Setup</span>(w_buf, CSeq, client_Rtp_port);</span><br><span class="line">			server_Rtp_fd = <span class="built_in">CreateUdpSocket</span>();</span><br><span class="line">			server_Rtcp_fd = <span class="built_in">CreateUdpSocket</span>();</span><br><span class="line">			<span class="keyword">if</span> (server_Rtp_fd &lt; <span class="number">0</span> || server_Rtcp_fd &lt; <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;create server udp fail&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(<span class="built_in">BindSocketAddr</span>(server_Rtp_fd, SERVER_RTP_PORT) &lt; <span class="number">0</span>||</span><br><span class="line">				<span class="built_in">BindSocketAddr</span>(server_Rtcp_fd, SERVER_RTCP_PORT) &lt; <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;bind server_fd fail&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;PLAY&quot;</span>))</span><br><span class="line">			<span class="built_in">Handle_Play</span>(w_buf, CSeq);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;nb method : &quot;</span> &lt;&lt; method &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">		std::cout &lt;&lt; std::endl &lt;&lt; __FUNCTION__ &lt;&lt; <span class="string">&quot;w_buf = &quot;</span> &lt;&lt; w_buf &lt;&lt; std::endl;</span><br><span class="line">		<span class="built_in">send</span>(fd, w_buf, <span class="built_in">strlen</span>(w_buf), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;PLAY&quot;</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">int</span> framesize, startcode;</span><br><span class="line">			<span class="type">char</span>* frame = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">500000</span>);</span><br><span class="line">			RtpPacket* rtp_packet = (RtpPacket*)<span class="built_in">malloc</span>(<span class="number">500000</span>);</span><br><span class="line">			FILE* fp = <span class="built_in">fopen</span>(H264_FILE_NAME, <span class="string">&quot;rb&quot;</span>); <span class="comment">//只读二进制</span></span><br><span class="line">			<span class="keyword">if</span> (!fp)</span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;file fp fail&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">RtpHeaderInit</span>(rtp_packet, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, RTP_VESION, RTP_PAYLOAD_TYPE_H264, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0X88923423</span>);</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;start play\n&quot;</span> &lt;&lt; <span class="string">&quot;client ip:&quot;</span> &lt;&lt; ip &lt;&lt; std::endl &lt;&lt; <span class="string">&quot;client port:&quot;</span> &lt;&lt; client_Rtp_port &lt;&lt; std::endl;</span><br><span class="line">			<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				framesize = <span class="built_in">GetFrameFromH264File</span>(fp, frame, <span class="number">500000</span>); <span class="comment">//获取的是当前 00至00的大小</span></span><br><span class="line">				<span class="keyword">if</span> (framesize &lt; <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					std::cout &lt;&lt; <span class="string">&quot;read &quot;</span> &lt;&lt; H264_FILE_NAME &lt;&lt; <span class="string">&quot;end, framesize = &quot;</span> &lt;&lt; framesize &lt;&lt; std::endl;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">StartCode3</span>(frame))</span><br><span class="line">					startcode = <span class="number">3</span>;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					startcode = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">				framesize -= startcode; <span class="comment">//减去开头的起始码,真正的数据大小</span></span><br><span class="line">				<span class="built_in">RtpSendH264Frame</span>(server_Rtp_fd, ip, client_Rtp_port, rtp_packet, frame + startcode, framesize);</span><br><span class="line">				<span class="built_in">Sleep</span>(<span class="number">30</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">free</span>(frame);</span><br><span class="line">			<span class="built_in">free</span>(rtp_packet);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">memset</span>(method, <span class="number">0</span>, <span class="built_in">sizeof</span>(method));</span><br><span class="line">		<span class="built_in">memset</span>(url, <span class="number">0</span>, <span class="built_in">sizeof</span>(url));</span><br><span class="line">		CSeq = <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="comment">//next while</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">closesocket</span>(fd);</span><br><span class="line">	<span class="keyword">if</span> (server_Rtp_fd) &#123;</span><br><span class="line">		<span class="built_in">closesocket</span>(server_Rtp_fd);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (server_Rtcp_fd &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">closesocket</span>(server_Rtcp_fd);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">free</span>(r_buf);</span><br><span class="line">	<span class="built_in">free</span>(w_buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	WSADATA winsock;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;winsock) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;winsock start error&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> server_fd = <span class="built_in">CreateTcpSocket</span>();</span><br><span class="line">	<span class="keyword">if</span> (server_fd &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">WSACleanup</span>();</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;tcpsocket create fail&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">BindSocketAddr</span>(server_fd,SERVER_PORT) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;bind fail&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">listen</span>(server_fd, <span class="number">128</span>) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;listen fail&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	std::cout &lt;&lt; __FILE__ &lt;&lt; <span class="string">&quot; rtsp://127.0.0.1:&quot;</span> &lt;&lt; SERVER_PORT &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">int</span> client_fd;</span><br><span class="line">		<span class="type">char</span> client_ip[<span class="number">40</span>];</span><br><span class="line">		<span class="type">int</span> client_port;</span><br><span class="line">		client_fd = <span class="built_in">AcceptClient</span>(server_fd, client_ip, &amp;client_port);</span><br><span class="line">		<span class="keyword">if</span> (client_fd &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;accept fail&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;accept client ip:&quot;</span> &lt;&lt; client_ip &lt;&lt; <span class="string">&quot; port:&quot;</span> &lt;&lt; client_port;</span><br><span class="line">		<span class="built_in">DoClient</span>(client_fd, client_ip, client_port);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">closesocket</span>(server_fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="3-音频原理"><a href="#3-音频原理" class="headerlink" title="3. 音频原理"></a>3. 音频原理</h1><h2 id="3-1-PCM数据格式"><a href="#3-1-PCM数据格式" class="headerlink" title="3.1 PCM数据格式"></a>3.1 PCM数据格式</h2><p><code>PCM</code>(Pulse Code Modulation)也被称为 脉码编码调制。<br>PCM中的声音数据没有被压缩，如果是单声道的文件，采样数据按时间的先后顺序依次存入。(它的基本组织单位是BYTE(8bit)或WORD(16bit))</p>
<p>一般情况下，一帧PCM是由<code>2048</code>次采样组成的</p>
<p>如果是双声道的文件，采样数据按时间先后顺序交叉地存入。如图所示:</p>
<p><img src="/img/rtsp21.png"></p>
<blockquote>
<p>对于解析PCM数据有所帮助</p>
</blockquote>
<p>麦克风在录音采样后，直接获得的就是音频原始数据pcm。<br>但由于pcm数据较大，所以通常需要压缩之后才能传输或保存，常见的音频压缩技术有aac，g711，opus，mp3等，最常用的就是<code>aac</code>。</p>
<p>1秒钟的pcm的声音大小 &#x3D; 44100 * 2(声道) * 2（字节） &#x2F; 1024 * 60(秒) &#x2F;1024<br>一分钟约等于5MB</p>
<h2 id="3-2-几个可能会用到的命令行"><a href="#3-2-几个可能会用到的命令行" class="headerlink" title="3.2 几个可能会用到的命令行"></a>3.2 几个可能会用到的命令行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//指定时间段录制</span><br><span class="line">ffmpeg -i input.mp4 -c:v copy -c:a copy -ss 00:10:20 -to 00:30:20 out.mp4</span><br><span class="line"></span><br><span class="line">//指定录制时长</span><br><span class="line">ffmpeg -i input.mp4 -c:v copy -c:a copy -t 30 out.mp4</span><br><span class="line">备注: -t 30 表示指定30秒的录制时长</span><br><span class="line"></span><br><span class="line">//ffmpeg命令行 从mp4视频文件提取aac 音频文件</span><br><span class="line">ffmpeg -i test.mp4  -vn -acodec aac test.aac</span><br><span class="line">备注：-i 表示输入文件 </span><br><span class="line">      -vm <span class="built_in">disable</span> video / 丢掉视频</span><br><span class="line">      -acodec 设置音频编码格式</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//ffmpeg 从aac音频文件解码为pcm音频文件</span><br><span class="line">ffmpeg -i test.aac -f s16le test.pcm</span><br><span class="line">备注：-i 表示输入文件 </span><br><span class="line">      -f 表示输出格式</span><br><span class="line"></span><br><span class="line">//ffplay 播放.pcm音频文件</span><br><span class="line">备注：-i 表示指定的输入文件</span><br><span class="line">      -f 表示强制使用的格式</span><br><span class="line">      -ar 表示播放的音频数据的采样率</span><br><span class="line">      -ac 表示播放的音频数据的通道数</span><br></pre></td></tr></table></figure>


<h2 id="3-3-代码"><a href="#3-3-代码" class="headerlink" title="3.3  代码"></a>3.3  代码</h2><blockquote>
<p>Adts.h</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdint&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">AdtsHeader</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> syncword;  <span class="comment">//12 bit 同步字 &#x27;1111 1111 1111&#x27;，说明一个ADTS帧的开始</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> id;        <span class="comment">//1 bit MPEG 标示符， 0 for MPEG-4，1 for MPEG-2</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> layer;     <span class="comment">//2 bit 总是&#x27;00&#x27;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> protectionAbsent;  <span class="comment">//1 bit 1表示没有crc，0表示有crc</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> profile;           <span class="comment">//1 bit 表示使用哪个级别的AAC  //2bit</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> samplingFreqIndex; <span class="comment">//4 bit 表示使用的采样频率</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> privateBit;        <span class="comment">//1 bit</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> channelCfg; <span class="comment">//3 bit 表示声道数</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> originalCopy;         <span class="comment">//1 bit</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> home;                  <span class="comment">//1 bit</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*下面的为改变的参数即每一帧都不同*/</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> copyrightIdentificationBit;   <span class="comment">//1 bit</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> copyrightIdentificationStart; <span class="comment">//1 bit</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> aacFrameLength;               <span class="comment">//13 bit 一个ADTS帧的长度包括ADTS头和AAC原始流</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> adtsBufferFullness;           <span class="comment">//11 bit 0x7FF 说明是码率可变的码流</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* number_of_raw_data_blocks_in_frame</span></span><br><span class="line"><span class="comment">     * 表示ADTS帧中有number_of_raw_data_blocks_in_frame + 1个AAC原始帧</span></span><br><span class="line"><span class="comment">     * 所以说number_of_raw_data_blocks_in_frame == 0</span></span><br><span class="line"><span class="comment">     * 表示说ADTS帧中有一个AAC数据块并不是说没有。(一个AAC原始帧包含一段时间内1024个采样及相关数据)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> numberOfRawDataBlockInFrame; <span class="comment">//2 bit</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Parse_AdtsHeader</span><span class="params">(<span class="type">uint8_t</span>* headerBuf, <span class="keyword">struct</span> AdtsHeader* adtsHeader)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Convert_AdtsHeader_ToBuf</span><span class="params">(<span class="keyword">struct</span> AdtsHeader* adtsHeader, <span class="type">uint8_t</span>* adtsHeaderBuf)</span></span>;</span><br></pre></td></tr></table></figure>


<blockquote>
<p>Adts.cpp</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Adts.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Parse_AdtsHeader</span><span class="params">(<span class="type">uint8_t</span>* headerBuf, AdtsHeader* adtsHeader)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(adtsHeader, <span class="number">0</span>, <span class="built_in">sizeof</span>(*adtsHeader)); <span class="comment">//初始化</span></span><br><span class="line">    <span class="keyword">if</span> ((headerBuf[<span class="number">0</span>] == <span class="number">0xFF</span>) &amp;&amp; ((headerBuf[<span class="number">1</span>] &amp; <span class="number">0xF0</span>) == <span class="number">0xF0</span>))<span class="comment">//三个 &#x27;1111&#x27;代表 1个ADTS帧的开始</span></span><br><span class="line">    &#123;</span><br><span class="line">        adtsHeader-&gt;id = ((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">1</span>] &amp; <span class="number">0x08</span>) &gt;&gt; <span class="number">3</span>; <span class="comment">//如果id==1, &gt;&gt;3后变为1</span></span><br><span class="line">        adtsHeader-&gt;layer = ((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">1</span>] &amp; <span class="number">0x06</span>) &gt;&gt; <span class="number">1</span>;<span class="comment">// 0000 0110, layer一般为0 &amp;后为0</span></span><br><span class="line">        adtsHeader-&gt;protectionAbsent = (<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">1</span>] &amp; <span class="number">0x01</span>;</span><br><span class="line">        adtsHeader-&gt;profile = ((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">2</span>] &amp; <span class="number">0xc0</span>) &gt;&gt; <span class="number">6</span>; <span class="comment">//1100 0000</span></span><br><span class="line">        adtsHeader-&gt;samplingFreqIndex = ((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">2</span>] &amp; <span class="number">0x3c</span>) &gt;&gt; <span class="number">2</span>; <span class="comment">// 0011 1100</span></span><br><span class="line">        adtsHeader-&gt;privateBit = ((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">2</span>] &amp; <span class="number">0x02</span>) &gt;&gt; <span class="number">1</span>; <span class="comment">// 0000 0010</span></span><br><span class="line">        <span class="comment">// 0000 0001 -&gt; 0000 0100 | 1100 0000 -&gt; 0000 0011</span></span><br><span class="line">        adtsHeader-&gt;channelCfg = ((((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">2</span>] &amp; <span class="number">0x01</span>) &lt;&lt; <span class="number">2</span>) |</span><br><span class="line">                (((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">3</span>] &amp; <span class="number">0xc0</span>) &gt;&gt; <span class="number">6</span>));</span><br><span class="line">        adtsHeader-&gt;originalCopy = ((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">3</span>] &amp; <span class="number">0x20</span>) &gt;&gt; <span class="number">5</span>; <span class="comment">// 0010 0000</span></span><br><span class="line">        adtsHeader-&gt;home = ((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">3</span>] &amp; <span class="number">0x10</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">        adtsHeader-&gt;copyrightIdentificationBit = ((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">3</span>] &amp; <span class="number">0x08</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">        adtsHeader-&gt;copyrightIdentificationStart = ((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">3</span>] &amp; <span class="number">0x04</span>) &gt;&gt; <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//0000 0000 0000 0011 -&gt; 0001 1111 1111 1111</span></span><br><span class="line">        adtsHeader-&gt;aacFrameLength = (((((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">3</span>]) &amp; <span class="number">0x03</span>) &lt;&lt; <span class="number">11</span>) |</span><br><span class="line">                (((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">4</span>] &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">3</span>) |</span><br><span class="line">                ((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">5</span>] &amp; <span class="number">0xE0</span>) &gt;&gt; <span class="number">5</span>);</span><br><span class="line">        adtsHeader-&gt;adtsBufferFullness = (((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">5</span>] &amp; <span class="number">0x1f</span>) &lt;&lt; <span class="number">6</span> |</span><br><span class="line">                ((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">6</span>] &amp; <span class="number">0xfc</span>) &gt;&gt; <span class="number">2</span>);</span><br><span class="line">        adtsHeader-&gt;numberOfRawDataBlockInFrame = ((<span class="type">unsigned</span> <span class="type">int</span>)headerBuf[<span class="number">6</span>] &amp; <span class="number">0x03</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;fail to parse&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Convert_AdtsHeader_ToBuf</span><span class="params">(<span class="keyword">struct</span> AdtsHeader* adtsHeader, <span class="type">uint8_t</span>* adtsHeaderBuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    adtsHeaderBuf[<span class="number">0</span>] = <span class="number">0xFF</span>;</span><br><span class="line">    adtsHeaderBuf[<span class="number">1</span>] = <span class="number">0xF1</span>;</span><br><span class="line">    adtsHeaderBuf[<span class="number">2</span>] = ((adtsHeader-&gt;profile) &lt;&lt; <span class="number">6</span>) + (adtsHeader-&gt;samplingFreqIndex &lt;&lt; <span class="number">2</span>) + (adtsHeader-&gt;channelCfg &gt;&gt; <span class="number">2</span>);</span><br><span class="line">    adtsHeaderBuf[<span class="number">3</span>] = (((adtsHeader-&gt;channelCfg &amp; <span class="number">3</span>) &lt;&lt; <span class="number">6</span>) + (adtsHeader-&gt;aacFrameLength &gt;&gt; <span class="number">11</span>));</span><br><span class="line">    adtsHeaderBuf[<span class="number">4</span>] = ((adtsHeader-&gt;aacFrameLength &amp; <span class="number">0x7FF</span>) &gt;&gt; <span class="number">3</span>);</span><br><span class="line">    adtsHeaderBuf[<span class="number">5</span>] = (((adtsHeader-&gt;aacFrameLength &amp; <span class="number">7</span>) &lt;&lt; <span class="number">5</span>) + <span class="number">0x1F</span>);</span><br><span class="line">    adtsHeaderBuf[<span class="number">6</span>] = <span class="number">0xFC</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<blockquote>
<p>decode_aac, aac格式转pcm格式</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> AAC_FILE_NAME <span class="string">&quot;D:/ffmpeg/learn/test.aac&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fdk-aac/aacdecoder_lib.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//data载入buf中的有效信息(包括帧头), data_size 赋值为buf中framesize;</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Get_ADTSframe</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span>* buf, <span class="type">int</span> buf_size, <span class="type">unsigned</span> <span class="type">char</span>* data, <span class="type">unsigned</span> <span class="type">int</span>* data_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!buf || !data || !data_size)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> framesize = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (buf_size &lt; <span class="number">7</span>) <span class="comment">//头信息</span></span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>; </span><br><span class="line">		<span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="number">0xff</span> &amp;&amp; ((buf[<span class="number">1</span>] &amp; <span class="number">0xf0</span>) == <span class="number">0xf0</span>)) <span class="comment">//比较运算符优先级高于位运算符</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//赋值运算符优先级最低</span></span><br><span class="line">			<span class="comment">//aac_frame_length (&lt;&lt;&gt;&gt; 优先级 高于 &amp;)</span></span><br><span class="line">			framesize |= ((buf[<span class="number">3</span>] &amp; <span class="number">0x03</span>) &lt;&lt; <span class="number">11</span>);</span><br><span class="line">			framesize |= buf[<span class="number">4</span>] &lt;&lt; <span class="number">3</span>;</span><br><span class="line">			framesize |= ((buf[<span class="number">5</span>] &amp; <span class="number">0xe0</span>) &gt;&gt; <span class="number">5</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		--buf_size;</span><br><span class="line">		++buf;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (buf_size &lt; framesize)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">memcpy</span>(data, buf, framesize);</span><br><span class="line">	*data_size = framesize;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FILE* aac_file = <span class="built_in">fopen</span>(AAC_FILE_NAME, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (!aac_file)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;open aac fail\n&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	HANDLE_AACDECODER aac_coder = <span class="built_in">aacDecoder_Open</span>(TT_MP4_ADTS, <span class="number">1</span>);</span><br><span class="line">	AAC_DECODER_ERROR aac_error;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>* aac_frame = (<span class="type">unsigned</span> <span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">1024</span> * <span class="number">5</span>);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>* aac_buf = (<span class="type">unsigned</span> <span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> pcm_size = <span class="number">8</span> * <span class="number">1024</span> * <span class="built_in">sizeof</span>(INT_PCM);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>* pcm_data = (<span class="type">unsigned</span> <span class="type">char</span>*)<span class="built_in">malloc</span>(pcm_size);</span><br><span class="line">	</span><br><span class="line">	<span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> offset = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> aac_datasize = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> aac_framesize = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> valid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (!<span class="built_in">feof</span>(aac_file)) <span class="comment">//函数返回0 代表文件尚未读取结束</span></span><br><span class="line">	&#123;</span><br><span class="line">		aac_datasize = <span class="built_in">fread</span>(aac_buf + offset, <span class="number">1</span>, <span class="number">1024</span> * <span class="number">1024</span> - offset, aac_file);</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">char</span>* aac_data = aac_buf; <span class="comment">//因为要得到framesize就要移动指针来找头</span></span><br><span class="line">		<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//其实buf和frame都是一样的</span></span><br><span class="line">			<span class="type">int</span> ret = <span class="built_in">Get_ADTSframe</span>(aac_data, aac_datasize, aac_frame, &amp;aac_framesize);</span><br><span class="line">			<span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;adts frame end\n&quot;</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">1</span>) <span class="comment">//ADTS中信息不完整</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">memcpy</span>(aac_buf, aac_data, aac_datasize);</span><br><span class="line">				offset = aac_datasize;</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;adts frame broken\n&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			valid = aac_framesize;</span><br><span class="line">			aac_error = <span class="built_in">aacDecoder_Fill</span>(aac_coder, &amp;aac_frame, &amp;aac_framesize, &amp;valid);</span><br><span class="line">			<span class="keyword">if</span> (aac_error &gt; <span class="number">0</span>)</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;fill decoder\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">			aac_error = <span class="built_in">aacDecoder_DecodeFrame</span>(aac_coder, (INT_PCM*)pcm_data,</span><br><span class="line">				pcm_size / <span class="built_in">sizeof</span>(INT_PCM), <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">if</span> (aac_error &gt; <span class="number">0</span>)</span><br><span class="line">				std::cout &lt;&lt; <span class="string">&quot;decode error\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*sampleRate: 解码后的PCM音频信号的采样率（单位：Hz）（经过SBR处理后的采样率）。</span></span><br><span class="line"><span class="comment">			frameSize : 解码后的PCM音频信号的帧大小。</span></span><br><span class="line"><span class="comment">				对于AAC - LC：1024或960。</span></span><br><span class="line"><span class="comment">				对于HE - AAC（v2）：2048或1920。</span></span><br><span class="line"><span class="comment">				对于AAC - LD和AAC - ELD：512或480。</span></span><br><span class="line"><span class="comment">			numChannels : 解码后的PCM音频信号中输出音频通道的数量。</span></span><br><span class="line"><span class="comment">			pChannelType : 每个输出音频通道的音频通道类型。</span></span><br><span class="line"><span class="comment">			pChannelIndices : 每个输出音频通道的音频通道索引。</span></span><br><span class="line"><span class="comment">			aacSampleRate : 不带SBR的采样率（来自配置信息）。</span></span><br><span class="line"><span class="comment">			profile : MPEG - 2配置文件（来自文件头）（ - 1：不适用（例如，MPEG - 4））。</span></span><br><span class="line"><span class="comment">			aot : 音频对象类型（来自ASC）：针对MPEG - 2比特流设置为适当的值（例如，AAC - LC为2）。</span></span><br><span class="line"><span class="comment">			channelConfig : 通道配置（0：PCE定义，1：单声道，2：立体声，...）。</span></span><br><span class="line"><span class="comment">			bitRate : 瞬时比特率。</span></span><br><span class="line"><span class="comment">			aacSamplesPerFrame : AAC核心的每帧样本数（来自ASC）。</span></span><br><span class="line"><span class="comment">				对于AAC - LC：1024或960。</span></span><br><span class="line"><span class="comment">				对于AAC - LD和AAC - ELD：512或480。</span></span><br><span class="line"><span class="comment">			aacNumChannels : 经过AAC核心处理后（在PS或MPS处理之前）的音频通道数量。注意：这不是最终的输出通道数量！</span></span><br><span class="line"><span class="comment">			extAot : 扩展音频对象类型（来自ASC）。</span></span><br><span class="line"><span class="comment">			extSamplingRate : 扩展采样率（来自ASC）。</span></span><br><span class="line"><span class="comment">			outputDelay : 解码器额外延迟的样本数。</span></span><br><span class="line"><span class="comment">			flags : 内部标志的副本。仅由解码器写入，外部只能读取。</span></span><br><span class="line"><span class="comment">			epConfig : epConfig级别（来自ASC）：只支持级别0， - 1表示没有ER（例如，AOT = 2，MPEG - 2 AAC等）。</span></span><br><span class="line"><span class="comment">			numLostAccessUnits : 如果 aacDecoder_DecodeFrame() 返回 AAC_DEC_TRANSPORT_SYNC_ERROR，则此整数将反映估计的丢失访问单元的数量。如果估算失败，则会小于0。</span></span><br><span class="line"><span class="comment">			numTotalBytes : 通过解码器传递的总字节数。</span></span><br><span class="line"><span class="comment">			numBadBytes : 从 numTotalBytes 中考虑为带有错误的总字节数。</span></span><br><span class="line"><span class="comment">			numTotalAccessUnits : 通过解码器传递的总访问单元数。</span></span><br><span class="line"><span class="comment">			numBadAccessUnits : 从 numTotalAccessUnits 中考虑为带有错误的总访问单元数。</span></span><br><span class="line"><span class="comment">			drcProgRefLev : DRC（动态范围控制）程序参考电平。定义低于满量程的参考级别。</span></span><br><span class="line"><span class="comment">			drcPresMode : DRC（动态范围控制）呈现模式。*/</span></span><br><span class="line">			CStreamInfo* pcm_frame = <span class="built_in">aacDecoder_GetStreamInfo</span>(aac_coder); <span class="comment">//获取解码后的音频流的相关信息</span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;pcmFrame: channels=%d,simmpleRate=%d,frameSize=%d\n&quot;</span>,</span><br><span class="line">				pcm_frame-&gt;numChannels, pcm_frame-&gt;sampleRate, pcm_frame-&gt;frameSize);</span><br><span class="line"></span><br><span class="line">			<span class="comment">//码流格式</span></span><br><span class="line">			<span class="type">char</span> profile_str[<span class="number">10</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">			<span class="type">unsigned</span> <span class="type">char</span> profile = (aac_frame[<span class="number">2</span>] &amp; <span class="number">0xC0</span>) &gt;&gt; <span class="number">6</span>; <span class="comment">//aac级别,profile</span></span><br><span class="line">			<span class="keyword">switch</span> (profile)</span><br><span class="line">			&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0</span>: <span class="built_in">sprintf</span>(profile_str, <span class="string">&quot;Main&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span>: <span class="built_in">sprintf</span>(profile_str, <span class="string">&quot;LC&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span>: <span class="built_in">sprintf</span>(profile_str, <span class="string">&quot;SSR&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>: <span class="built_in">sprintf</span>(profile_str, <span class="string">&quot;unknown&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//采样率</span></span><br><span class="line">			<span class="type">char</span> frequence_str[<span class="number">10</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">			<span class="type">unsigned</span> <span class="type">char</span> sampling_frequency_index = (aac_frame[<span class="number">2</span>] &amp; <span class="number">0x3C</span>) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">			<span class="keyword">switch</span> (sampling_frequency_index)</span><br><span class="line">			&#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0</span>: <span class="built_in">sprintf</span>(frequence_str, <span class="string">&quot;96000Hz&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">1</span>: <span class="built_in">sprintf</span>(frequence_str, <span class="string">&quot;88200Hz&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">2</span>: <span class="built_in">sprintf</span>(frequence_str, <span class="string">&quot;64000Hz&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">3</span>: <span class="built_in">sprintf</span>(frequence_str, <span class="string">&quot;48000Hz&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">4</span>: <span class="built_in">sprintf</span>(frequence_str, <span class="string">&quot;44100Hz&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">5</span>: <span class="built_in">sprintf</span>(frequence_str, <span class="string">&quot;32000Hz&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">6</span>: <span class="built_in">sprintf</span>(frequence_str, <span class="string">&quot;24000Hz&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">7</span>: <span class="built_in">sprintf</span>(frequence_str, <span class="string">&quot;22050Hz&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">8</span>: <span class="built_in">sprintf</span>(frequence_str, <span class="string">&quot;16000Hz&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">9</span>: <span class="built_in">sprintf</span>(frequence_str, <span class="string">&quot;12000Hz&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">10</span>: <span class="built_in">sprintf</span>(frequence_str, <span class="string">&quot;11025Hz&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">11</span>: <span class="built_in">sprintf</span>(frequence_str, <span class="string">&quot;8000Hz&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:<span class="built_in">sprintf</span>(frequence_str, <span class="string">&quot;unknown&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%5d| %8s|  %8s| %5d| %5d |\n&quot;</span>,</span><br><span class="line">				count, profile_str, frequence_str, aac_framesize, pcm_size);</span><br><span class="line">			aac_datasize -= aac_framesize;</span><br><span class="line">			aac_data += aac_framesize;</span><br><span class="line">			++count;</span><br><span class="line">		&#125;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;---------------------------------------------\n&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">free</span>(pcm_data);</span><br><span class="line">	<span class="built_in">free</span>(aac_buf);</span><br><span class="line">	<span class="built_in">free</span>(aac_frame);</span><br><span class="line">	<span class="built_in">fclose</span>(aac_file);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<blockquote>
<p>sdl2_play_aac.cpp播放aac音频</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//播放aac格式的音频</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SDL_MAIN_HANDLED <span class="comment">//SDL 不要提供默认的 main 函数入口</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>( disable : 4996 )</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SDL.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Adts.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fdk-aac/aacdecoder_lib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AAC_FILE_NAME <span class="string">&quot;D:/ffmpeg/learn/test.aac&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> Uint8* audio_chunk;</span><br><span class="line"><span class="type">static</span> Uint32 audio_len;</span><br><span class="line"><span class="type">static</span> Uint8* audio_pos;</span><br><span class="line"></span><br><span class="line"><span class="comment">//data : SDL_AudioSpec.userdata</span></span><br><span class="line"><span class="comment">//stream 这个指针是 SDL 内部音频数据内存的指针，只要把数据拷贝到这个指针的地址，就能播放声音了。</span></span><br><span class="line"><span class="comment">//len 表示音频缓存区的大小</span></span><br><span class="line"><span class="comment">//SDL 打开音频硬件设备的时候，SDL 库就会创建一个线程，来及时执行回调函数 sdl_audio_callback()</span></span><br><span class="line"><span class="comment">//至于 SDL 线程多久回调一次函数，不需要太关心</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Fill_Audio</span><span class="params">(<span class="type">void</span>* data, Uint8* stream, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">SDL_memset</span>(stream, <span class="number">0</span>, len);</span><br><span class="line">    <span class="keyword">if</span> (audio_len == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    len = len &gt; audio_len ? audio_len : len; <span class="comment">//取min, audio_len是pcm_framesize</span></span><br><span class="line">    <span class="comment">//音量范围为0~128,设置为SDL_MIX_MAXVOLUME表示完整的音频音量</span></span><br><span class="line">    <span class="comment">//将audio_pos音频 混进 stream, len以字节计数大小</span></span><br><span class="line">    <span class="built_in">SDL_MixAudio</span>(stream, audio_pos, len, SDL_MIX_MAXVOLUME);</span><br><span class="line">    audio_pos += len; <span class="comment">//跳至下一个播放帧的起点</span></span><br><span class="line">    audio_len -= len; <span class="comment">//使主函数中的while等待终止,同时也给予自己足够时间执行改函数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">SDL_Init</span>(SDL_INIT_AUDIO | SDL_INIT_TIMER)) <span class="comment">//初始化音频子系统 | 初始化定时器子系统</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;init SDL fail - &quot;</span> &lt;&lt; <span class="built_in">SDL_GetError</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//typedef struct SDL_AudioSpec </span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    int freq;                   // 采样率 (samples per second)</span></span><br><span class="line">    <span class="comment">//    SDL_AudioFormat format;     // 音频格式</span></span><br><span class="line">    <span class="comment">//    Uint8 channels;             // 声道数 (1 for mono, 2 for stereo)</span></span><br><span class="line">    <span class="comment">//    Uint8 silence;              // 静音值 (通常为 0)</span></span><br><span class="line">    <span class="comment">//    Uint16 samples;             // 音频缓冲区大小 (单位是采样数)</span></span><br><span class="line">    <span class="comment">//    Uint16 padding;             // 对齐用的填充 (通常为 0)</span></span><br><span class="line">    <span class="comment">//    Uint32 size;                // 音频缓冲区大小 (单位是字节)</span></span><br><span class="line">    <span class="comment">//    SDL_AudioCallback callback; // 回调函数指针，用于处理音频数据</span></span><br><span class="line">    <span class="comment">//    void* userdata;             // 用户自定义数据</span></span><br><span class="line">    <span class="comment">//&#125;;</span></span><br><span class="line">    SDL_AudioSpec SDL_spec;</span><br><span class="line">    SDL_spec.freq = <span class="number">44100</span>;</span><br><span class="line">    SDL_spec.format = AUDIO_S16SYS; <span class="comment">//16-bit signed integer 的音频数据格式,使用主机系统的字节顺序</span></span><br><span class="line">    SDL_spec.channels = <span class="number">2</span>;</span><br><span class="line">    SDL_spec.silence = <span class="number">0</span>;</span><br><span class="line">    SDL_spec.samples = <span class="number">1024</span>; <span class="comment">//音频缓冲区大小(单位是采样数)</span></span><br><span class="line">    SDL_spec.callback = Fill_Audio;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">SDL_OpenAudio</span>(&amp;SDL_spec, <span class="literal">nullptr</span>) &lt; <span class="number">0</span>) <span class="comment">//打开音频设备并根据 SDL_spec 的要求进行初始化。</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;open audio fail\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SDL_PauseAudio</span>(<span class="number">0</span>);<span class="comment">//控制SDL音频设备的暂停状态。参数为0，音频设备将被恢复到正常状态并开始播放音频数据；</span></span><br><span class="line">                      <span class="comment">//而当参数为 1 时，音频设备将被暂停，停止播放音频数据。</span></span><br><span class="line"></span><br><span class="line">    FILE* aac_file = <span class="built_in">fopen</span>(AAC_FILE_NAME, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!aac_file)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;open file fail\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HANDLE_AACDECODER aac_coder = <span class="built_in">aacDecoder_Open</span>(TT_MP4_ADTS, <span class="number">1</span>); <span class="comment">//aac解码器实例化</span></span><br><span class="line">    <span class="type">uint8_t</span>* frame = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">2000</span>); <span class="comment">//存放aac数据</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> pcm_framesize = <span class="number">2</span> * <span class="number">1024</span> * <span class="built_in">sizeof</span>(INT_PCM); <span class="comment">//signed short</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>* pcm_frame = (<span class="type">unsigned</span> <span class="type">char</span>*)<span class="built_in">malloc</span>(pcm_framesize); <span class="comment">//存放pcm格式的数据</span></span><br><span class="line"></span><br><span class="line">    AdtsHeader adts_header;</span><br><span class="line">    <span class="type">int</span> adts_headerlen; <span class="comment">//ADTS头长</span></span><br><span class="line">    <span class="type">int</span> adts_contentlen;<span class="comment">//ADTS负载长</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> adts_len = <span class="number">0</span>; <span class="comment">//ADTS当前帧总长(头+负载)</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> count = <span class="number">0</span>; <span class="comment">//count循环次数, 计帧</span></span><br><span class="line">    AAC_DECODER_ERROR aac_error;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        adts_headerlen = <span class="built_in">fread</span>(frame, <span class="number">1</span>, <span class="number">7</span>, aac_file); <span class="comment">//头长是目前自定的7字节, 读头</span></span><br><span class="line">        <span class="keyword">if</span> (adts_headerlen &lt;= <span class="number">0</span>) <span class="comment">//没有数据或出错</span></span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;read header error\n&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Parse_AdtsHeader</span>(frame, &amp;adts_header) &lt; <span class="number">0</span>) <span class="comment">//处理头数据放置于包内</span></span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;parse header error\n&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读取aacfile中头后面(一段帧)的数据</span></span><br><span class="line">        adts_contentlen = <span class="built_in">fread</span>(frame + <span class="number">7</span>, <span class="number">1</span>, adts_header.aacFrameLength - <span class="number">7</span>, aac_file);</span><br><span class="line">        <span class="keyword">if</span> (adts_contentlen &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;read content error\n&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        adts_len = adts_header.aacFrameLength;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//AAC解码器是解码用的,解什么,就通过这个函数传进去</span></span><br><span class="line">        <span class="comment">//从缓冲区中(frame)</span></span><br><span class="line">        <span class="comment">//外部输入缓冲区的大小(length)</span></span><br><span class="line">        <span class="comment">//返回信息(len) 以便后续调用aacDecoder Fill时，可以确定pBuffer中的正确位置以获取下一个数据。</span></span><br><span class="line">        aac_error = <span class="built_in">aacDecoder_Fill</span>(aac_coder, &amp;frame, &amp;adts_header.aacFrameLength, &amp;adts_len);</span><br><span class="line">        <span class="keyword">if</span> (aac_error &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;decoder fill error\n&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始编码数据, 将解析为 pcm 格式的数据存储至pcm_frame中</span></span><br><span class="line">        <span class="comment">//最后一位是标志位 :</span></span><br><span class="line">        <span class="comment">//0 无附加信息</span></span><br><span class="line">        <span class="comment">//AACDEC_CONCEAL（值为 1）：表示需要进行数据的掩盖（concealment）处理。</span></span><br><span class="line">        <span class="comment">//AACDEC_FLUSH（值为 2）：表示需要丢弃输入数据，并清空滤波器组（filter banks），输出延迟的音频。</span></span><br><span class="line">        <span class="comment">//AACDEC_INTR（值为 4）：表示输入数据是不连续的（discontinuous），需要重新同步解码器内部状态。</span></span><br><span class="line">        aac_error = <span class="built_in">aacDecoder_DecodeFrame</span>(aac_coder, (INT_PCM*)pcm_frame,</span><br><span class="line">            pcm_framesize / <span class="built_in">sizeof</span>(INT_PCM), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (aac_error &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;decode frame error\n&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        audio_chunk = (Uint8*)pcm_frame;</span><br><span class="line">        audio_len = pcm_framesize;</span><br><span class="line">        audio_pos = audio_chunk;</span><br><span class="line">        <span class="keyword">while</span> (audio_len &gt; <span class="number">0</span>) <span class="comment">//等待时间让SDL线程完成FillAudio函数的任务</span></span><br><span class="line">            <span class="built_in">SDL_Delay</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;count=%d, aac_FrameLength=%d, pcm_FrameSize=%d \n&quot;</span>, count, adts_header.aacFrameLength, pcm_framesize);</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(frame);</span><br><span class="line">    <span class="built_in">free</span>(pcm_frame);</span><br><span class="line">    <span class="built_in">fclose</span>(aac_file);</span><br><span class="line">    <span class="built_in">SDL_Quit</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>sdl2_play_pcm.cpp, 播放pcm音频</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SDL_MAIN_HANDLED</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PCM_FILE_NAME <span class="string">&quot;D:/ffmpeg/learn/test.pcm&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>( disable : 4996 )</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SDL.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> Uint8* audio_chunk;</span><br><span class="line"><span class="type">static</span> Uint32 audio_len;</span><br><span class="line"><span class="type">static</span> Uint8* audio_pos;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Fill_Audio</span><span class="params">(<span class="type">void</span>* data, Uint8* stream, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">SDL_memset</span>(stream, <span class="number">0</span>, len);</span><br><span class="line">	<span class="keyword">if</span> (audio_len == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">	len = len &gt; audio_len ? audio_len : len;</span><br><span class="line">	<span class="built_in">SDL_MixAudio</span>(stream, audio_pos, len, SDL_MIX_MAXVOLUME);</span><br><span class="line">	audio_pos += len;</span><br><span class="line">	audio_len -= len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">SDL_Init</span>(SDL_INIT_AUDIO | SDL_INIT_TIMER))</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;init SDL fail - &quot;</span> &lt;&lt; SDL_GetError &lt;&lt; std::endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	SDL_AudioSpec SDL_spec;</span><br><span class="line">	SDL_spec.freq = <span class="number">44100</span>;</span><br><span class="line">	SDL_spec.format = AUDIO_S16SYS;</span><br><span class="line">	SDL_spec.channels = <span class="number">2</span>;</span><br><span class="line">	SDL_spec.silence = <span class="number">0</span>;</span><br><span class="line">	SDL_spec.samples = <span class="number">1024</span>;</span><br><span class="line">	SDL_spec.callback = Fill_Audio;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">SDL_OpenAudio</span>(&amp;SDL_spec, <span class="literal">nullptr</span>) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;SDL open fail\n&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">SDL_PauseAudio</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	FILE* pcm_file = <span class="built_in">fopen</span>(PCM_FILE_NAME, <span class="string">&quot;rb+&quot;</span>); <span class="comment">//允许以二进制格式读取和写入文件</span></span><br><span class="line">	<span class="keyword">if</span> (!pcm_file)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;open file fail\n&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> pcm_buf_size = <span class="number">409600</span>; <span class="comment">//一次性从pcm文件中读取的数据大小</span></span><br><span class="line">	<span class="type">char</span>* pcm_buf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(pcm_buf_size);</span><br><span class="line">	<span class="type">int</span> data_sum = <span class="number">0</span>;</span><br><span class="line">	<span class="type">size_t</span> count;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		count = <span class="built_in">fread</span>(pcm_buf, <span class="number">1</span>, pcm_buf_size, pcm_file);</span><br><span class="line">		<span class="keyword">if</span> (count != pcm_buf_size) <span class="comment">//播放完后重新循环播放</span></span><br><span class="line">		&#123;</span><br><span class="line">			std::cout &lt;&lt; <span class="string">&quot;read pcm end, count = &quot;</span> &lt;&lt; count &lt;&lt; std::endl;</span><br><span class="line">			<span class="built_in">fseek</span>(pcm_file, <span class="number">0</span>, SEEK_SET); <span class="comment">//0 代表将文件指针重新放置开头位置</span></span><br><span class="line">			<span class="built_in">fread</span>(pcm_buf, <span class="number">1</span>, pcm_buf_size, pcm_file);</span><br><span class="line">			data_sum = <span class="number">0</span>;</span><br><span class="line">			<span class="comment">//break;</span></span><br><span class="line">		&#125;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;now playing &quot;</span> &lt;&lt; data_sum &lt;&lt; <span class="string">&quot;bytes data\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">		data_sum += pcm_buf_size;</span><br><span class="line">		audio_chunk = (Uint8*)pcm_buf;</span><br><span class="line">		audio_len = pcm_buf_size;</span><br><span class="line">		audio_pos = audio_chunk;</span><br><span class="line">		<span class="comment">/*假设音频的采样率位44100，即每秒钟采样44100次。</span></span><br><span class="line"><span class="comment">		AAC一般将1024次采样编码成一帧，所以一秒就有44100 / 1024 = 43帧。</span></span><br><span class="line"><span class="comment">		RTP包发送的每一帧数据的时间增量为44100 / 43 = 1025。</span></span><br><span class="line"><span class="comment">		每一帧数据的时间间隔为1000 / 43 = 23ms。*/</span></span><br><span class="line">		<span class="keyword">while</span> (audio_len &gt; <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">SDL_Delay</span>(<span class="number">23</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">free</span>(pcm_buf);</span><br><span class="line">	<span class="built_in">SDL_Quit</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-UDP的RTP传输音频aac的RTSP服务器，能拉流播放"><a href="#4-UDP的RTP传输音频aac的RTSP服务器，能拉流播放" class="headerlink" title="4. UDP的RTP传输音频aac的RTSP服务器，能拉流播放"></a>4. UDP的RTP传输音频aac的RTSP服务器，能拉流播放</h1><h2 id="4-1-aac码流格式"><a href="#4-1-aac码流格式" class="headerlink" title="4.1 aac码流格式"></a>4.1 aac码流格式</h2><ul>
<li><code>ADIF(Audio Data Interchage Format)</code>，音频数据交换格式：<br>只有一个统一的头，必须得到所有数据后解码，适用于本地文件。</li>
<li><code>ADTS(Audio Data Transport Stream)</code>，音视数据传输流：<br>每一帧都有头信息，任意帧解码，适用于传输流。</li>
</ul>
<p>AAC共有9种规格，以适应不同的场合的需要：</p>
<ul>
<li><p><code>MPEG-2 AAC LC</code> 低复杂度规格（Low Complexity） 注：比较简单，没有增益控制，但提高了编码效率，在中等码率的编码效率以及音质方面，都能找到平衡点</p>
</li>
<li><p><code>MPEG-2 AAC Main</code> 主规格</p>
</li>
<li><p><code>MPEG-2 AAC SSR</code> 可变采样率规格（Scaleable Sample Rate）</p>
</li>
<li><p><code>MPEG-4 AAC LC</code> 低复杂度规格（Low Complexity）—现在的手机比较常见的MP4文件中的音频部份就包括了该规格音频文件</p>
</li>
<li><p><code>MPEG-4 AAC Main</code> 主规格 注：包含了除增益控制之外的全部功能，其音质最好</p>
</li>
<li><p><code>MPEG-4 AAC SSR</code> 可变采样率规格（Scaleable Sample Rate）</p>
</li>
<li><p><code>MPEG-4 AAC LTP</code> 长时期预测规格（Long Term Predicition）</p>
</li>
<li><p><code>MPEG-4 AAC LD</code> 低延迟规格（Low Delay）</p>
</li>
<li><p><code>MPEG-4 AAC HE</code> 高效率规格（High Efficiency）—这种规格适合用于低码率编码，有Nero ACC 编码器支持</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>序号</th>
<th>字段</th>
<th>长度</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>synword</td>
<td>12bit</td>
<td>同步头，总是0xFFF，代表着1个ADTS帧的开始。</td>
</tr>
<tr>
<td>2</td>
<td>id</td>
<td>1bit</td>
<td>设置MPEG标识符，1bit，0标识MPEG-4，1标识MPEG-2。</td>
</tr>
<tr>
<td>3</td>
<td>layer</td>
<td>2bit</td>
<td>总是00。</td>
</tr>
<tr>
<td>4</td>
<td>protection_absent</td>
<td>1bit</td>
<td>误码校验，标识是否进行误码校验。0表示有CRC校验，1表示没有CRC校验。为0时头部7bytes后面+2bytesCRC检验位。</td>
</tr>
<tr>
<td>5</td>
<td>profile</td>
<td>2bit</td>
<td>AAC级别，0表示AAC Main, 1表示AAC LC, 2表示AAC SSR。<br>profile的值等于Audio Object Type的值减1。</td>
</tr>
<tr>
<td>6</td>
<td>sampling_frequency_index</td>
<td>4bit</td>
<td>采样率下标，下标对应的采样率如下：<br>0: 96000 Hz<br>1: 88200 Hz<br>2 : 64000 Hz<br>3 : 48000 Hz<br>4 : 44100 Hz<br>5 : 32000 Hz<br>6 : 24000 Hz<br>7 : 22050 Hz<br>8 : 16000 Hz<br>9 : 12000 Hz<br>10 : 11025 Hz<br>11 : 8000 Hz<br>12 : 7350 Hz<br>13 : Reserved<br>14 : Reserved<br>15 : frequency is written explictly</td>
</tr>
<tr>
<td>7</td>
<td>private_bit</td>
<td>1bit</td>
<td>私有位，编码时设置为0，解码时忽略。</td>
</tr>
<tr>
<td>8</td>
<td>channel_configuration</td>
<td>3bit</td>
<td>声道数。<br>0: Defined in AOT Specifc Config<br>1: 1 channel : front - center<br>2 : 2 channels : front - left, front - right<br>3 : 3 channels : front - center, front - left, front - right<br>4 : 4 channels : front - center, front - left, front - right, back - center<br>5 : 5 channels : front - center, front - left, front - right, back - left, back - right<br>6 : 6 channels : front - center, front - left, front - right, back - left, back - right, LFE - channel<br>7 : 8 channels : front - center, front - left, front - right, side - left, side - right, back - left, back - right, LFE - channel<br>8 - 15 : Reserved</td>
</tr>
<tr>
<td>9</td>
<td>orininal_copy</td>
<td>1bit</td>
<td>编码时设置为0，解码时忽略。</td>
</tr>
<tr>
<td>10</td>
<td>home</td>
<td>1bit</td>
<td>编码时设置为0，解码时忽略。</td>
</tr>
<tr>
<td>11</td>
<td>copyrigth_identification_bit</td>
<td>1bit</td>
<td>编码时设置为0，解码时忽略。</td>
</tr>
<tr>
<td>12</td>
<td>copyrigth_identification_stat</td>
<td>1bit</td>
<td>编码时设置为0，解码时忽略。</td>
</tr>
<tr>
<td>13</td>
<td>aac_frame_length</td>
<td>13bit</td>
<td>一个ADTS帧的长度，包括ADTS头和AAC原始流。</td>
</tr>
<tr>
<td>14</td>
<td>adts_bufferfullness</td>
<td>11bit</td>
<td>缓冲区充满度，0x7FF说明是码率可变的码流，不需要此字段。CBR可能需要此字段，不同编码器使用情况不同。具体查看附录。</td>
</tr>
<tr>
<td>15</td>
<td>number_of_raw_data_blocks_in_frame</td>
<td>2bit</td>
<td>表示ADTS帧中有number_of_raw_data_blocks_in_frame + 1个AAC原始帧，为0表示说ADTS帧中只有一个AAC数据.</td>
</tr>
<tr>
<td>16</td>
<td>CRC</td>
<td>16bit</td>
<td>CRC校验码</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>序号</th>
<th>字段</th>
<th>长度</th>
<th>值</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>synword</td>
<td>12bit</td>
<td>111111111111</td>
</tr>
<tr>
<td>2</td>
<td>id</td>
<td>1bit</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>layer</td>
<td>2bit</td>
<td>00</td>
</tr>
<tr>
<td>4</td>
<td>protection_absent</td>
<td>1bit</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>profile</td>
<td>2bit</td>
<td>01</td>
</tr>
<tr>
<td>6</td>
<td>sampling_frequency_index</td>
<td>4bit</td>
<td>0100（十进制4）</td>
</tr>
<tr>
<td>7</td>
<td>private_bit</td>
<td>1bit</td>
<td>0</td>
</tr>
<tr>
<td>8</td>
<td>channel_configuration</td>
<td>3bit</td>
<td>010 （十进制2）</td>
</tr>
<tr>
<td>9</td>
<td>orininal_copy</td>
<td>1bit</td>
<td>0</td>
</tr>
<tr>
<td>10</td>
<td>home</td>
<td>1bit</td>
<td>0</td>
</tr>
<tr>
<td>11</td>
<td>copyrigth_identification_bit</td>
<td>1bit</td>
<td>0</td>
</tr>
<tr>
<td>12</td>
<td>copyrigth_identification_stat</td>
<td>1bit</td>
<td>0</td>
</tr>
<tr>
<td>13</td>
<td>aac_frame_length</td>
<td>13bit</td>
<td>0000101111100（十进制380）</td>
</tr>
<tr>
<td>14</td>
<td>adts_bufferfullness</td>
<td>11bit</td>
<td>00010010000</td>
</tr>
<tr>
<td>15</td>
<td>number_of_raw_data_blocks_in_frame</td>
<td>2bit</td>
<td>00</td>
</tr>
</tbody></table>
<blockquote>
<p>aac的RTP打包方式</p>
</blockquote>
<p>  AAC的RTP打包方式并没有向H.264那样丰富，一种方式，主要AAC一帧数据大小都是几百个字节，不会向H.264那么少则几个字节，多则几千。<br>     AAC的RTP打包方式就是将ADTS帧取出ADTS头部，取出AAC数据，每帧数据封装成一个RTP包<br>     需要注意的是，并不是将AAC数据直接拷贝到RTP的载荷中<br>     。AAC封装成RTP包，在RTP载荷中的前四个字节是有特殊含义的，然后再是AAC数据，如下图所示。</p>
<p><img src="/img/rtsp22.png"></p>
<p> 其中RTP载荷的一个字节为0x00，第二个字节为0x10<br> 第三个字节和第四个字节保存AAC Data的大小，最多只能保存13bit<br> 第三个字节保存数据大小的高八位<br> 第四个字节的高5位保存数据大小的低5位.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rtpPacket-&gt;payload[<span class="number">0</span>] = <span class="number">0x00</span>;</span><br><span class="line">rtpPacket-&gt;payload[<span class="number">1</span>] = <span class="number">0x10</span>;</span><br><span class="line">rtpPacket-&gt;payload[<span class="number">2</span>] = (frameSize &amp; <span class="number">0x1FE0</span>) &gt;&gt; <span class="number">5</span>; <span class="comment">//高8位</span></span><br><span class="line">rtpPacket-&gt;payload[<span class="number">3</span>] = (frameSize &amp; <span class="number">0x1F</span>) &lt;&lt; <span class="number">3</span>; <span class="comment">//低5位</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>RTP包时间戳的计算</p>
</blockquote>
<p>  假设音频的采样率位44100，即每秒钟采样44100次。<br>AAC一般将1024次采样编码成一帧，所以一秒就有44100&#x2F;1024&#x3D;43帧。<br>RTP包发送的每一帧数据的时间增量为44100&#x2F;43&#x3D;1025。<br>每一帧数据的时间间隔为1000&#x2F;43&#x3D;23ms。</p>
<blockquote>
<p>可能会用到的ffmpeg命令行</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ffmpeg命令行 从mp4视频文件提取aac 音频文件</span></span><br><span class="line">ffmpeg -i test.mp4  -vn -acodec aac test.aac</span><br><span class="line">备注：-i 表示输入文件 </span><br><span class="line">      -vm disable video / 丢掉视频</span><br><span class="line">      -acodec 设置音频编码格式</span><br><span class="line"></span><br><span class="line"><span class="comment">//ffmpeg 从aac音频文件解码为pcm音频文件</span></span><br><span class="line">ffmpeg -i test.aac -f s16le test.pcm</span><br><span class="line">备注：-i 表示输入文件 </span><br><span class="line">      -f 表示输出格式</span><br><span class="line"></span><br><span class="line"><span class="comment">//ffplay 播放.pcm音频文件</span></span><br><span class="line">ffplay -ar <span class="number">44100</span> -ac <span class="number">2</span> -f s16le -i test.pcm</span><br><span class="line">备注：-i 表示指定的输入文件</span><br><span class="line">      -f 表示强制使用的格式</span><br><span class="line">      -ar 表示播放的音频数据的采样率</span><br><span class="line">      -ac 表示播放的音频数据的通道数</span><br></pre></td></tr></table></figure>

<h2 id="4-2-代码实现"><a href="#4-2-代码实现" class="headerlink" title="4.2 代码实现"></a>4.2 代码实现</h2><blockquote>
<p>rtp.h</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_VESION              2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_PAYLOAD_TYPE_H264   96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_PAYLOAD_TYPE_AAC    97</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_HEADER_SIZE         12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_MAX_PKT_SIZE        1400</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RtpHeader</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> csrcLen : <span class="number">4</span>;</span><br><span class="line">    <span class="type">uint8_t</span> extension : <span class="number">1</span>;</span><br><span class="line">    <span class="type">uint8_t</span> padding : <span class="number">1</span>;</span><br><span class="line">    <span class="type">uint8_t</span> version : <span class="number">2</span>;</span><br><span class="line">    <span class="type">uint8_t</span> payloadType : <span class="number">7</span>;</span><br><span class="line">    <span class="type">uint8_t</span> marker : <span class="number">1</span>; <span class="comment">//音频中标记会话的开始</span></span><br><span class="line">    <span class="type">uint16_t</span> seq;</span><br><span class="line">    <span class="type">uint32_t</span> timestamp;</span><br><span class="line">    <span class="type">uint32_t</span> ssrc;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RtpPacket</span></span><br><span class="line">&#123;</span><br><span class="line">    RtpHeader rtpHeader;</span><br><span class="line">    <span class="type">uint8_t</span> payload[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rtpHeaderInit</span><span class="params">(RtpPacket* rtpPacket, <span class="type">uint8_t</span> csrcLen, <span class="type">uint8_t</span> extension,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint8_t</span> padding, <span class="type">uint8_t</span> version, <span class="type">uint8_t</span> payloadType, <span class="type">uint8_t</span> marker,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint16_t</span> seq, <span class="type">uint32_t</span> timestamp, <span class="type">uint32_t</span> ssrc)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rtpSendPacketOverTcp</span><span class="params">(<span class="type">int</span> clientSockfd, RtpPacket* rtpPacket, <span class="type">uint32_t</span> dataSize)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rtpSendPacketOverUdp</span><span class="params">(<span class="type">int</span> serverRtpSockfd, <span class="type">const</span> <span class="type">char</span>* ip, <span class="type">int16_t</span> port, RtpPacket* rtpPacket, <span class="type">uint32_t</span> dataSize)</span></span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>rtp.cpp</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rtp.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rtpHeaderInit</span><span class="params">(RtpPacket* rtpPacket, <span class="type">uint8_t</span> csrcLen, <span class="type">uint8_t</span> extension,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint8_t</span> padding, <span class="type">uint8_t</span> version, <span class="type">uint8_t</span> payloadType, <span class="type">uint8_t</span> marker,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint16_t</span> seq, <span class="type">uint32_t</span> timestamp, <span class="type">uint32_t</span> ssrc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.csrcLen = csrcLen;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.extension = extension;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.padding = padding;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.version = version;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.payloadType = payloadType;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.marker = marker;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq = seq;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp = timestamp;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.ssrc = ssrc;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rtpSendPacketOverTcp</span><span class="params">(<span class="type">int</span> clientSockfd, RtpPacket* rtpPacket, <span class="type">uint32_t</span> dataSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq = <span class="built_in">htons</span>(rtpPacket-&gt;rtpHeader.seq);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp = <span class="built_in">htonl</span>(rtpPacket-&gt;rtpHeader.timestamp);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.ssrc = <span class="built_in">htonl</span>(rtpPacket-&gt;rtpHeader.ssrc);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> rtpSize = RTP_HEADER_SIZE + dataSize;</span><br><span class="line">    <span class="type">char</span>* tempBuf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">4</span> + rtpSize);</span><br><span class="line">    tempBuf[<span class="number">0</span>] = <span class="number">0x24</span>;<span class="comment">//$</span></span><br><span class="line">    tempBuf[<span class="number">1</span>] = <span class="number">0x00</span>;</span><br><span class="line">    tempBuf[<span class="number">2</span>] = (<span class="type">uint8_t</span>)(((rtpSize) &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span>);</span><br><span class="line">    tempBuf[<span class="number">3</span>] = (<span class="type">uint8_t</span>)((rtpSize) &amp; <span class="number">0xFF</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(tempBuf + <span class="number">4</span>, (<span class="type">char</span>*)rtpPacket, rtpSize);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">send</span>(clientSockfd, tempBuf, <span class="number">4</span> + rtpSize, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq = <span class="built_in">ntohs</span>(rtpPacket-&gt;rtpHeader.seq);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp = <span class="built_in">ntohl</span>(rtpPacket-&gt;rtpHeader.timestamp);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.ssrc = <span class="built_in">ntohl</span>(rtpPacket-&gt;rtpHeader.ssrc);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(tempBuf);</span><br><span class="line">    tempBuf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rtpSendPacketOverUdp</span><span class="params">(<span class="type">int</span> serverRtpSockfd, <span class="type">const</span> <span class="type">char</span>* ip, <span class="type">int16_t</span> port, RtpPacket* rtpPacket, <span class="type">uint32_t</span> dataSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    sockaddr_in addr;</span><br><span class="line"></span><br><span class="line">    addr.sin_family = AF_INET;</span><br><span class="line">    addr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    addr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip);</span><br><span class="line"></span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq = <span class="built_in">htons</span>(rtpPacket-&gt;rtpHeader.seq);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp = <span class="built_in">htonl</span>(rtpPacket-&gt;rtpHeader.timestamp);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.ssrc = <span class="built_in">htonl</span>(rtpPacket-&gt;rtpHeader.ssrc);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">sendto</span>(serverRtpSockfd, (<span class="type">char</span>*)rtpPacket, dataSize + RTP_HEADER_SIZE, <span class="number">0</span>,</span><br><span class="line">            (sockaddr*)&amp;addr, <span class="built_in">sizeof</span>(addr));</span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq = <span class="built_in">ntohs</span>(rtpPacket-&gt;rtpHeader.seq);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp = <span class="built_in">ntohl</span>(rtpPacket-&gt;rtpHeader.timestamp);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.ssrc = <span class="built_in">ntohl</span>(rtpPacket-&gt;rtpHeader.ssrc);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<blockquote>
<p>main.cpp</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关闭SDL检查</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rtp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVER_PORT     8554</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVER_RTP_PORT  55532</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVER_RTCP_PORT 55533</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_MAX_SIZE    (1024*1024)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AAC_FILE_NAME   <span class="string">&quot;D:/ffmpeg/learn/test.aac&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">AdtsHeader</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> syncword;</span><br><span class="line">    <span class="type">uint8_t</span> id;</span><br><span class="line">    <span class="type">uint8_t</span> layer;</span><br><span class="line">    <span class="type">uint8_t</span> protectionAbsent;</span><br><span class="line">    <span class="type">uint8_t</span> profile;</span><br><span class="line">    <span class="type">uint8_t</span> samplingFreqIndex;</span><br><span class="line">    <span class="type">uint8_t</span> privateBit;</span><br><span class="line">    <span class="type">uint8_t</span> channelCfg;</span><br><span class="line">    <span class="type">uint8_t</span> originalCopy;</span><br><span class="line">    <span class="type">uint8_t</span> home;</span><br><span class="line">    <span class="type">uint8_t</span> copyrightIdentificationBit;</span><br><span class="line">    <span class="type">uint8_t</span> copyrightIdentificationStart;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> aacFrameLength;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> adtsBufferFullness;</span><br><span class="line">    <span class="type">uint8_t</span> numberOfRawDataBlockInFrame;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">Parse_AdtsHeader</span><span class="params">(<span class="type">uint8_t</span>* in, AdtsHeader* res)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> frame_number = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(res, <span class="number">0</span>, <span class="built_in">sizeof</span>(*res));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((in[<span class="number">0</span>] == <span class="number">0xFF</span>) &amp;&amp; ((in[<span class="number">1</span>] &amp; <span class="number">0xF0</span>) == <span class="number">0xF0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        res-&gt;id = ((<span class="type">uint8_t</span>)in[<span class="number">1</span>] &amp; <span class="number">0x08</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">        res-&gt;layer = ((<span class="type">uint8_t</span>)in[<span class="number">1</span>] &amp; <span class="number">0x06</span>) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        res-&gt;protectionAbsent = (<span class="type">uint8_t</span>)in[<span class="number">1</span>] &amp; <span class="number">0x01</span>;</span><br><span class="line">        res-&gt;profile = ((<span class="type">uint8_t</span>)in[<span class="number">2</span>] &amp; <span class="number">0xc0</span>) &gt;&gt; <span class="number">6</span>;</span><br><span class="line">        res-&gt;samplingFreqIndex = ((<span class="type">uint8_t</span>)in[<span class="number">2</span>] &amp; <span class="number">0x3c</span>) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">        res-&gt;privateBit = ((<span class="type">uint8_t</span>)in[<span class="number">2</span>] &amp; <span class="number">0x02</span>) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        res-&gt;channelCfg = ((((<span class="type">uint8_t</span>)in[<span class="number">2</span>] &amp; <span class="number">0x01</span>) &lt;&lt; <span class="number">2</span>) | (((<span class="type">unsigned</span> <span class="type">int</span>)in[<span class="number">3</span>] &amp; <span class="number">0xc0</span>) &gt;&gt; <span class="number">6</span>));</span><br><span class="line">        res-&gt;originalCopy = ((<span class="type">uint8_t</span>)in[<span class="number">3</span>] &amp; <span class="number">0x20</span>) &gt;&gt; <span class="number">5</span>;</span><br><span class="line">        res-&gt;home = ((<span class="type">uint8_t</span>)in[<span class="number">3</span>] &amp; <span class="number">0x10</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">        res-&gt;copyrightIdentificationBit = ((<span class="type">uint8_t</span>)in[<span class="number">3</span>] &amp; <span class="number">0x08</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">        res-&gt;copyrightIdentificationStart = ((<span class="type">uint8_t</span>)in[<span class="number">3</span>] &amp; <span class="number">0x04</span>) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">        res-&gt;aacFrameLength = (((((<span class="type">unsigned</span> <span class="type">int</span>)in[<span class="number">3</span>]) &amp; <span class="number">0x03</span>) &lt;&lt; <span class="number">11</span>) |</span><br><span class="line">            (((<span class="type">unsigned</span> <span class="type">int</span>)in[<span class="number">4</span>] &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">3</span>) |</span><br><span class="line">            ((<span class="type">unsigned</span> <span class="type">int</span>)in[<span class="number">5</span>] &amp; <span class="number">0xE0</span>) &gt;&gt; <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        res-&gt;adtsBufferFullness = (((<span class="type">unsigned</span> <span class="type">int</span>)in[<span class="number">5</span>] &amp; <span class="number">0x1f</span>) &lt;&lt; <span class="number">6</span> |</span><br><span class="line">            ((<span class="type">unsigned</span> <span class="type">int</span>)in[<span class="number">6</span>] &amp; <span class="number">0xfc</span>) &gt;&gt; <span class="number">2</span>);</span><br><span class="line">        res-&gt;numberOfRawDataBlockInFrame = ((<span class="type">uint8_t</span>)in[<span class="number">6</span>] &amp; <span class="number">0x03</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;parse adts header fail\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">createTcpSocket</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> sockfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">setsockopt</span>(sockfd, SOL_SOCKET, SO_REUSEADDR, (<span class="type">const</span> <span class="type">char</span>*)&amp;on, <span class="built_in">sizeof</span>(on));</span><br><span class="line">    <span class="keyword">return</span> sockfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">createUdpSocket</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> sockfd = <span class="built_in">socket</span>(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">setsockopt</span>(sockfd, SOL_SOCKET, SO_REUSEADDR, (<span class="type">const</span> <span class="type">char</span>*)&amp;on, <span class="built_in">sizeof</span>(on));</span><br><span class="line">    <span class="keyword">return</span> sockfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">bindSocketAddr</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="type">char</span>* ip, <span class="type">int</span> port)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sockaddr_in addr;</span><br><span class="line">    addr.sin_family = AF_INET;</span><br><span class="line">    addr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    addr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(sockfd, (sockaddr*)&amp;addr, <span class="built_in">sizeof</span>(sockaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">acceptClient</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">char</span>* ip, <span class="type">int</span>* port)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sockaddr_in addr;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="built_in">sizeof</span>(addr));</span><br><span class="line">    <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(addr);</span><br><span class="line">    <span class="type">int</span> clientfd = <span class="built_in">accept</span>(sockfd, (sockaddr*)&amp;addr, &amp;len);</span><br><span class="line">    <span class="keyword">if</span> (clientfd &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(ip, <span class="built_in">inet_ntoa</span>(addr.sin_addr));</span><br><span class="line">    *port = <span class="built_in">ntohs</span>(addr.sin_port);</span><br><span class="line">    <span class="keyword">return</span> clientfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">handleCmd_OPTIONS</span><span class="params">(<span class="type">char</span>* result, <span class="type">int</span> cseq)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">sprintf</span>(result, <span class="string">&quot;RTSP/1.0 200 OK\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;CSeq: %d\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Public: OPTIONS, DESCRIBE, SETUP, PLAY\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">        ,cseq);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">handleCmd_DESCRIBE</span><span class="params">(<span class="type">char</span>* result, <span class="type">int</span> cseq, <span class="type">char</span>* url)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> sdp[<span class="number">500</span>], localIp[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">sscanf</span>(url, <span class="string">&quot;rtsp://%[^:]:&quot;</span>, localIp);</span><br><span class="line">    <span class="built_in">sprintf</span>(sdp, <span class="string">&quot;v=0\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;o=- 9%ld 1 IN IP4 %s\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;t=0 0\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;a=control:*\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;m=audio 0 RTP/AVP 97\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;a=rtpmap:97 mpeg4-generic/44100/2\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;a=fmtp:97 profile-level-id=1;mode=AAC-hbr;sizelength=13;indexlength=3;indexdeltalength=3;config=1210;\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;a=control:track0\r\n&quot;</span>,</span><br><span class="line">        <span class="built_in">time</span>(<span class="literal">NULL</span>), localIp);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(result, <span class="string">&quot;RTSP/1.0 200 OK\r\nCSeq: %d\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Content-Base: %s\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Content-type: application/sdp\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Content-length: %d\r\n\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;%s&quot;</span>,</span><br><span class="line">        cseq, url, <span class="built_in">strlen</span>(sdp), sdp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">handleCmd_SETUP</span><span class="params">(<span class="type">char</span>* result, <span class="type">int</span> cseq, <span class="type">int</span> clientRtpPort)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">sprintf</span>(result, <span class="string">&quot;RTSP/1.0 200 OK\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;CSeq: %d\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Transport: RTP/AVP;unicast;client_port=%d-%d;server_port=%d-%d\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Session: 66334873\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;\r\n&quot;</span>,</span><br><span class="line">        cseq, clientRtpPort, clientRtpPort + <span class="number">1</span>, SERVER_RTP_PORT, SERVER_RTCP_PORT);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">handleCmd_PLAY</span><span class="params">(<span class="type">char</span>* result, <span class="type">int</span> cseq)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">sprintf</span>(result, <span class="string">&quot;RTSP/1.0 200 OK\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;CSeq: %d\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Range: npt=0.000-\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Session: 66334873; timeout=10\r\n\r\n&quot;</span>,</span><br><span class="line">        cseq);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">Rtp_SendAACFrame</span><span class="params">(<span class="type">int</span> socket, <span class="type">const</span> <span class="type">char</span>* ip, <span class="type">int16_t</span> port,</span></span></span><br><span class="line"><span class="params"><span class="function">        RtpPacket* rtpPacket, <span class="type">uint8_t</span>* frame, <span class="type">uint32_t</span> frameSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    rtpPacket-&gt;payload[<span class="number">0</span>] = <span class="number">0x00</span>;</span><br><span class="line">    rtpPacket-&gt;payload[<span class="number">1</span>] = <span class="number">0x10</span>;</span><br><span class="line">    rtpPacket-&gt;payload[<span class="number">2</span>] = (frameSize &amp; <span class="number">0x1FE0</span>) &gt;&gt; <span class="number">5</span>; </span><br><span class="line">    rtpPacket-&gt;payload[<span class="number">3</span>] = (frameSize &amp; <span class="number">0x1F</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(rtpPacket-&gt;payload + <span class="number">4</span>, frame, frameSize);</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">rtpSendPacketOverUdp</span>(socket, ip, port, rtpPacket, frameSize + <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to send rtp packet\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq++;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 如果采样频率是44100</span></span><br><span class="line"><span class="comment">     * 一般AAC每个1024个采样为一帧</span></span><br><span class="line"><span class="comment">     * 所以一秒就有 44100 / 1024 = 43帧</span></span><br><span class="line"><span class="comment">     * 时间增量就是 44100 / 43 = 1025</span></span><br><span class="line"><span class="comment">     * 一帧的时间为 1 / 43 = 23ms</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp += <span class="number">1025</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//static char* getLineFromBuf(char* buf, char* line) &#123;</span></span><br><span class="line"><span class="comment">//    while (*buf != &#x27;\n&#x27;)</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        *line = *buf;</span></span><br><span class="line"><span class="comment">//        line++;</span></span><br><span class="line"><span class="comment">//        buf++;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    *line = &#x27;\n&#x27;;</span></span><br><span class="line"><span class="comment">//    ++line;</span></span><br><span class="line"><span class="comment">//    *line = &#x27;\0&#x27;;</span></span><br><span class="line"><span class="comment">//    ++buf;</span></span><br><span class="line"><span class="comment">//    return buf;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">doClient</span><span class="params">(<span class="type">int</span> clientSockfd, <span class="type">const</span> <span class="type">char</span>* clientIP, <span class="type">int</span> clientPort)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> method[<span class="number">40</span>], url[<span class="number">100</span>], version[<span class="number">40</span>];</span><br><span class="line">    <span class="type">int</span> serverRtpSockfd = <span class="number">-1</span>, serverRtcpSockfd = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">int</span> clientRtpPort, clientRtcpPort, CSeq;</span><br><span class="line">    <span class="type">char</span>* rBuf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(BUF_MAX_SIZE);</span><br><span class="line">    <span class="type">char</span>* sBuf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(BUF_MAX_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> recvLen = <span class="built_in">recv</span>(clientSockfd, rBuf, BUF_MAX_SIZE, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (recvLen &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        rBuf[recvLen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s rBuf = %s \n&quot;</span>, __FUNCTION__, rBuf);</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* sep = <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="type">char</span>* line = <span class="built_in">strtok</span>(rBuf, sep);</span><br><span class="line">        <span class="keyword">while</span> (line) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;OPTIONS&quot;</span>) || <span class="built_in">strstr</span>(line, <span class="string">&quot;DESCRIBE&quot;</span>) ||</span><br><span class="line">                <span class="built_in">strstr</span>(line, <span class="string">&quot;SETUP&quot;</span>) || <span class="built_in">strstr</span>(line, <span class="string">&quot;PLAY&quot;</span>)) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;%s %s %s\r\n&quot;</span>, method, url, version) != <span class="number">3</span>)</span><br><span class="line">                &#123;&#125;      <span class="comment">// error</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;CSeq&quot;</span>)) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;CSeq: %d\r\n&quot;</span>, &amp;CSeq) != <span class="number">1</span>) </span><br><span class="line">                &#123;&#125;      <span class="comment">// error</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(line, <span class="string">&quot;Transport:&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;Transport:&quot;</span>))) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;Transport: RTP/AVP/UDP;unicast;client_port=%d-%d\r\n&quot;</span>,</span><br><span class="line">                    &amp;clientRtpPort, &amp;clientRtcpPort) != <span class="number">2</span>) </span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;parse Transport error \n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            line = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, sep);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;OPTIONS&quot;</span>)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">handleCmd_OPTIONS</span>(sBuf, CSeq))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;failed to handle options\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;DESCRIBE&quot;</span>)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">handleCmd_DESCRIBE</span>(sBuf, CSeq, url))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;failed to handle describe\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;SETUP&quot;</span>)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">handleCmd_SETUP</span>(sBuf, CSeq, clientRtpPort))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;failed to handle setup\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            serverRtpSockfd = <span class="built_in">createUdpSocket</span>();</span><br><span class="line">            serverRtcpSockfd = <span class="built_in">createUdpSocket</span>();</span><br><span class="line">            <span class="keyword">if</span> (serverRtpSockfd &lt; <span class="number">0</span> || serverRtcpSockfd &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;failed to create udp socket\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">bindSocketAddr</span>(serverRtpSockfd, <span class="string">&quot;0.0.0.0&quot;</span>, SERVER_RTP_PORT) &lt; <span class="number">0</span> ||</span><br><span class="line">                <span class="built_in">bindSocketAddr</span>(serverRtcpSockfd, <span class="string">&quot;0.0.0.0&quot;</span>, SERVER_RTCP_PORT) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;failed to bind addr\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;PLAY&quot;</span>)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">handleCmd_PLAY</span>(sBuf, CSeq))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;failed to handle play\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;未定义的method = %s \n&quot;</span>, method);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s sBuf = %s \n&quot;</span>, __FUNCTION__, sBuf);</span><br><span class="line">        <span class="built_in">send</span>(clientSockfd, sBuf, <span class="built_in">strlen</span>(sBuf), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开始播放，发送RTP包</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;PLAY&quot;</span>)) </span><br><span class="line">        &#123;</span><br><span class="line">            AdtsHeader adtsHeader;</span><br><span class="line">            RtpPacket* rtpPacket;</span><br><span class="line">            <span class="type">uint8_t</span>* frame;</span><br><span class="line">            <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">            FILE* fp = <span class="built_in">fopen</span>(AAC_FILE_NAME, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!fp) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;读取 %s 失败\n&quot;</span>, AAC_FILE_NAME);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            frame = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">5000</span>);</span><br><span class="line">            rtpPacket = (RtpPacket*)<span class="built_in">malloc</span>(<span class="number">5000</span>);</span><br><span class="line">            <span class="built_in">rtpHeaderInit</span>(rtpPacket, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, RTP_VESION, RTP_PAYLOAD_TYPE_AAC, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x32411</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ret = <span class="built_in">fread</span>(frame, <span class="number">1</span>, <span class="number">7</span>, fp);</span><br><span class="line">                <span class="keyword">if</span> (ret &lt;= <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;fread err\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;fread ret=%d \n&quot;</span>, ret);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">Parse_AdtsHeader</span>(frame, &amp;adtsHeader) &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;parseAdtsHeader err\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ret = <span class="built_in">fread</span>(frame, <span class="number">1</span>, adtsHeader.aacFrameLength - <span class="number">7</span>, fp);</span><br><span class="line">                <span class="keyword">if</span> (ret &lt;= <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;fread err\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">Rtp_SendAACFrame</span>(serverRtpSockfd, clientIP, clientRtpPort,</span><br><span class="line">                    rtpPacket, frame, adtsHeader.aacFrameLength - <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">Sleep</span>(<span class="number">1</span>);</span><br><span class="line">                <span class="comment">//usleep(23223);//1000/43.06 * 1000</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">free</span>(frame);</span><br><span class="line">            <span class="built_in">free</span>(rtpPacket);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(method, <span class="number">0</span>, <span class="built_in">sizeof</span>(method));</span><br><span class="line">        <span class="built_in">memset</span>(url, <span class="number">0</span>, <span class="built_in">sizeof</span>(url));</span><br><span class="line">        CSeq = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">closesocket</span>(clientSockfd);</span><br><span class="line">    <span class="keyword">if</span> (serverRtpSockfd)</span><br><span class="line">        <span class="built_in">closesocket</span>(serverRtpSockfd);</span><br><span class="line">    <span class="keyword">if</span> (serverRtcpSockfd &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">closesocket</span>(serverRtcpSockfd);</span><br><span class="line">    <span class="built_in">free</span>(rBuf);</span><br><span class="line">    <span class="built_in">free</span>(sBuf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;PC Server Socket Start Up Error \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> rtspServerSockfd;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    rtspServerSockfd = <span class="built_in">createTcpSocket</span>();</span><br><span class="line">    <span class="keyword">if</span> (rtspServerSockfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to create tcp socket\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = <span class="built_in">bindSocketAddr</span>(rtspServerSockfd, <span class="string">&quot;0.0.0.0&quot;</span>, SERVER_PORT);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to bind addr\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = <span class="built_in">listen</span>(rtspServerSockfd, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to listen\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s rtsp://127.0.0.1:%d\n&quot;</span>, __FILE__, SERVER_PORT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> clientSockfd, clientPort;</span><br><span class="line">        <span class="type">char</span> clientIp[<span class="number">40</span>];</span><br><span class="line">        clientSockfd = <span class="built_in">acceptClient</span>(rtspServerSockfd, clientIp, &amp;clientPort);</span><br><span class="line">        <span class="keyword">if</span> (clientSockfd &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;failed to accept client\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;accept client;client ip:%s,client port:%d\n&quot;</span>, clientIp, clientPort);</span><br><span class="line">        <span class="built_in">doClient</span>(clientSockfd, clientIp, clientPort);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">closesocket</span>(rtspServerSockfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="5-TCP的RTP同时传输h264和aac的RTSP服务器，能拉流播放"><a href="#5-TCP的RTP同时传输h264和aac的RTSP服务器，能拉流播放" class="headerlink" title="5. TCP的RTP同时传输h264和aac的RTSP服务器，能拉流播放"></a>5. TCP的RTP同时传输h264和aac的RTSP服务器，能拉流播放</h1><blockquote>
<p>相对于之前实现的功能，<code>变化</code>如下<br>1，客户端请求RTSP的Describe请求时，RTSP服务器返回的SDP协议，需要同时包含音频流和视频流的信息。<br>2，客户端请求RTSP的Setup请求时，RTSP服务器不需要再对应创建RTP和RTCP的UDP连接通道，因为TCP版的RTP传输，客户端与服务器交互时，无论是RTSP信令还是RTP数据包或者是RTCP数据包，都是使用同一个tcp连接通道。只不过这个tcp连接通道在发送rtp数据包或者rtcp数据包时，需要加一些分隔字节。<br>3，客户端请求RTSP的Play请求时，RTSP服务器在对Play请求回复以后，还需要源源不断的同时向客户端发送音频流和视频流的RTP数据包。<br>4，有几点注意，在这个案例项目中，使用的h264视频文件，对应的fps需要是25。另外由于Nalu的数量并不等于视频帧数量的原因，该案例的音视频并不能同步。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffplay -i -rtsp_transport tcp rtsp://127.0.0.1:8554</span><br></pre></td></tr></table></figure>

<h2 id="5-1-ffmpeg命令行"><a href="#5-1-ffmpeg命令行" class="headerlink" title="5.1 ffmpeg命令行"></a>5.1 ffmpeg命令行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//ffmpeg命令行 从mp4视频文件提取h264 码流文件</span><br><span class="line">ffmpeg -i test.mp4 -an -vcodec copy -f h264 test.h264</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//ffmpeg命令行 从mp4视频文件提取aac 音频文件</span><br><span class="line">ffmpeg -i test.mp4  -vn -acodec aac test.aac</span><br><span class="line"></span><br><span class="line">备注：-i 表示输入文件 </span><br><span class="line">      -vm <span class="built_in">disable</span> video / 丢掉视频</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="5-2-代码实现"><a href="#5-2-代码实现" class="headerlink" title="5.2 代码实现"></a>5.2 代码实现</h2><blockquote>
<p>rtp.h</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_VESION              2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_PAYLOAD_TYPE_H264   96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_PAYLOAD_TYPE_AAC    97</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_HEADER_SIZE         12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTP_MAX_PKT_SIZE        1400</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RtpHeader</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint8_t</span> csrcLen : <span class="number">4</span>;</span><br><span class="line">    <span class="type">uint8_t</span> extension : <span class="number">1</span>;</span><br><span class="line">    <span class="type">uint8_t</span> padding : <span class="number">1</span>;</span><br><span class="line">    <span class="type">uint8_t</span> version : <span class="number">2</span>;</span><br><span class="line">    <span class="type">uint8_t</span> payloadType : <span class="number">7</span>;</span><br><span class="line">    <span class="type">uint8_t</span> marker : <span class="number">1</span>; <span class="comment">//音频中标记会话的开始</span></span><br><span class="line">    <span class="type">uint16_t</span> seq;</span><br><span class="line">    <span class="type">uint32_t</span> timestamp;</span><br><span class="line">    <span class="type">uint32_t</span> ssrc;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RtpPacket</span></span><br><span class="line">&#123;</span><br><span class="line">    RtpHeader rtpHeader;</span><br><span class="line">    <span class="type">uint8_t</span> payload[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rtpHeaderInit</span><span class="params">(RtpPacket* rtpPacket, <span class="type">uint8_t</span> csrcLen, <span class="type">uint8_t</span> extension,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint8_t</span> padding, <span class="type">uint8_t</span> version, <span class="type">uint8_t</span> payloadType, <span class="type">uint8_t</span> marker,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint16_t</span> seq, <span class="type">uint32_t</span> timestamp, <span class="type">uint32_t</span> ssrc)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rtpSendPacketOverTcp</span><span class="params">(<span class="type">int</span> clientSockfd, RtpPacket* rtpPacket, <span class="type">uint32_t</span> dataSize, <span class="type">char</span> channel)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rtpSendPacketOverUdp</span><span class="params">(<span class="type">int</span> serverRtpSockfd, <span class="type">const</span> <span class="type">char</span>* ip, <span class="type">int16_t</span> port, RtpPacket* rtpPacket, <span class="type">uint32_t</span> dataSize)</span></span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>rtp.cpp</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rtp.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rtpHeaderInit</span><span class="params">(RtpPacket* rtpPacket, <span class="type">uint8_t</span> csrcLen, <span class="type">uint8_t</span> extension,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint8_t</span> padding, <span class="type">uint8_t</span> version, <span class="type">uint8_t</span> payloadType, <span class="type">uint8_t</span> marker,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">uint16_t</span> seq, <span class="type">uint32_t</span> timestamp, <span class="type">uint32_t</span> ssrc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.csrcLen = csrcLen;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.extension = extension;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.padding = padding;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.version = version;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.payloadType = payloadType;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.marker = marker;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq = seq;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp = timestamp;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.ssrc = ssrc;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rtpSendPacketOverTcp</span><span class="params">(<span class="type">int</span> clientSockfd, RtpPacket* rtpPacket, <span class="type">uint32_t</span> dataSize, <span class="type">char</span> channel)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq = <span class="built_in">htons</span>(rtpPacket-&gt;rtpHeader.seq);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp = <span class="built_in">htonl</span>(rtpPacket-&gt;rtpHeader.timestamp);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.ssrc = <span class="built_in">htonl</span>(rtpPacket-&gt;rtpHeader.ssrc);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> rtpSize = RTP_HEADER_SIZE + dataSize;</span><br><span class="line">    <span class="type">char</span>* tempBuf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">4</span> + rtpSize);</span><br><span class="line">    tempBuf[<span class="number">0</span>] = <span class="number">0x24</span>;<span class="comment">//$</span></span><br><span class="line">    tempBuf[<span class="number">1</span>] = channel; <span class="comment">//0x00</span></span><br><span class="line">    tempBuf[<span class="number">2</span>] = (<span class="type">uint8_t</span>)(((rtpSize) &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span>);</span><br><span class="line">    tempBuf[<span class="number">3</span>] = (<span class="type">uint8_t</span>)((rtpSize) &amp; <span class="number">0xFF</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(tempBuf + <span class="number">4</span>, (<span class="type">char</span>*)rtpPacket, rtpSize);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">send</span>(clientSockfd, tempBuf, <span class="number">4</span> + rtpSize, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq = <span class="built_in">ntohs</span>(rtpPacket-&gt;rtpHeader.seq);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp = <span class="built_in">ntohl</span>(rtpPacket-&gt;rtpHeader.timestamp);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.ssrc = <span class="built_in">ntohl</span>(rtpPacket-&gt;rtpHeader.ssrc);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(tempBuf);</span><br><span class="line">    tempBuf = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rtpSendPacketOverUdp</span><span class="params">(<span class="type">int</span> serverRtpSockfd, <span class="type">const</span> <span class="type">char</span>* ip, <span class="type">int16_t</span> port, RtpPacket* rtpPacket, <span class="type">uint32_t</span> dataSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    sockaddr_in addr;</span><br><span class="line"></span><br><span class="line">    addr.sin_family = AF_INET;</span><br><span class="line">    addr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    addr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip);</span><br><span class="line"></span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq = <span class="built_in">htons</span>(rtpPacket-&gt;rtpHeader.seq);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp = <span class="built_in">htonl</span>(rtpPacket-&gt;rtpHeader.timestamp);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.ssrc = <span class="built_in">htonl</span>(rtpPacket-&gt;rtpHeader.ssrc);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">sendto</span>(serverRtpSockfd, (<span class="type">char</span>*)rtpPacket, dataSize + RTP_HEADER_SIZE, <span class="number">0</span>,</span><br><span class="line">        (sockaddr*)&amp;addr, <span class="built_in">sizeof</span>(addr));</span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq = <span class="built_in">ntohs</span>(rtpPacket-&gt;rtpHeader.seq);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp = <span class="built_in">ntohl</span>(rtpPacket-&gt;rtpHeader.timestamp);</span><br><span class="line">    rtpPacket-&gt;rtpHeader.ssrc = <span class="built_in">ntohl</span>(rtpPacket-&gt;rtpHeader.ssrc);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>main.cpp</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WS2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;rtp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AAC_FILE_NAME   <span class="string">&quot;D:/ffmpeg/learn/test.aac&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> H264_FILE_NAME   <span class="string">&quot;D:/ffmpeg/learn/test.h264&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVER_PORT      8554</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_MAX_SIZE     (1024*1024)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">createTcpSocket</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> on = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> sockfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">setsockopt</span>(sockfd, SOL_SOCKET, SO_REUSEADDR, (<span class="type">const</span> <span class="type">char</span>*)&amp;on, <span class="built_in">sizeof</span>(on));</span><br><span class="line">    <span class="keyword">return</span> sockfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">bindSocketAddr</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="type">char</span>* ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sockaddr_in addr;</span><br><span class="line">    addr.sin_family = AF_INET;</span><br><span class="line">    addr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    addr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;addr, <span class="built_in">sizeof</span>(sockaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">acceptClient</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">char</span>* ip, <span class="type">int</span>* port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sockaddr_in addr;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="built_in">sizeof</span>(addr));</span><br><span class="line">    <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(addr);</span><br><span class="line">    <span class="type">int</span> clientfd = <span class="built_in">accept</span>(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;addr, &amp;len);</span><br><span class="line">    <span class="keyword">if</span> (clientfd &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(ip, <span class="built_in">inet_ntoa</span>(addr.sin_addr));</span><br><span class="line">    *port = <span class="built_in">ntohs</span>(addr.sin_port);</span><br><span class="line">    <span class="keyword">return</span> clientfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title">startCode3</span><span class="params">(<span class="type">char</span>* buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="number">0</span> &amp;&amp; buf[<span class="number">1</span>] == <span class="number">0</span> &amp;&amp; buf[<span class="number">2</span>] == <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title">startCode4</span><span class="params">(<span class="type">char</span>* buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="number">0</span> &amp;&amp; buf[<span class="number">1</span>] == <span class="number">0</span> &amp;&amp; buf[<span class="number">2</span>] == <span class="number">0</span> &amp;&amp; buf[<span class="number">3</span>] == <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">char</span>* <span class="title">findNextStartCode</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len - <span class="number">3</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">startCode3</span>(buf) || <span class="built_in">startCode4</span>(buf))</span><br><span class="line">            <span class="keyword">return</span> buf;</span><br><span class="line">        ++buf;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*if (startCode3(buf))</span></span><br><span class="line"><span class="comment">        return buf;*/</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">getFrameFromH264File</span><span class="params">(FILE* fp, <span class="type">char</span>* frame, <span class="type">int</span> size)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> frameSize = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">int</span> rSize = <span class="built_in">fread</span>(frame, <span class="number">1</span>, size, fp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">startCode3</span>(frame) &amp;&amp; !<span class="built_in">startCode4</span>(frame))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* nextStartCode = <span class="built_in">findNextStartCode</span>(frame + <span class="number">3</span>, rSize - <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> (!nextStartCode)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        frameSize = (nextStartCode - frame);</span><br><span class="line">        <span class="built_in">fseek</span>(fp, frameSize - rSize, SEEK_CUR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> frameSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">AdtsHeader</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> syncword;</span><br><span class="line">    <span class="type">uint8_t</span> id;</span><br><span class="line">    <span class="type">uint8_t</span> layer;</span><br><span class="line">    <span class="type">uint8_t</span> protectionAbsent;</span><br><span class="line">    <span class="type">uint8_t</span> profile;</span><br><span class="line">    <span class="type">uint8_t</span> samplingFreqIndex;</span><br><span class="line">    <span class="type">uint8_t</span> privateBit;</span><br><span class="line">    <span class="type">uint8_t</span> channelCfg;</span><br><span class="line">    <span class="type">uint8_t</span> originalCopy;</span><br><span class="line">    <span class="type">uint8_t</span> home;</span><br><span class="line">    <span class="type">uint8_t</span> copyrightIdentificationBit;</span><br><span class="line">    <span class="type">uint8_t</span> copyrightIdentificationStart;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> aacFrameLength;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> adtsBufferFullness;</span><br><span class="line">    <span class="type">uint8_t</span> numberOfRawDataBlockInFrame;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">Parse_AdtsHeader</span><span class="params">(<span class="type">uint8_t</span>* in, AdtsHeader* res)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> frame_number = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(res, <span class="number">0</span>, <span class="built_in">sizeof</span>(*res));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((in[<span class="number">0</span>] == <span class="number">0xFF</span>) &amp;&amp; ((in[<span class="number">1</span>] &amp; <span class="number">0xF0</span>) == <span class="number">0xF0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        res-&gt;id = ((<span class="type">uint8_t</span>)in[<span class="number">1</span>] &amp; <span class="number">0x08</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">        res-&gt;layer = ((<span class="type">uint8_t</span>)in[<span class="number">1</span>] &amp; <span class="number">0x06</span>) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        res-&gt;protectionAbsent = (<span class="type">uint8_t</span>)in[<span class="number">1</span>] &amp; <span class="number">0x01</span>;</span><br><span class="line">        res-&gt;profile = ((<span class="type">uint8_t</span>)in[<span class="number">2</span>] &amp; <span class="number">0xc0</span>) &gt;&gt; <span class="number">6</span>;</span><br><span class="line">        res-&gt;samplingFreqIndex = ((<span class="type">uint8_t</span>)in[<span class="number">2</span>] &amp; <span class="number">0x3c</span>) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">        res-&gt;privateBit = ((<span class="type">uint8_t</span>)in[<span class="number">2</span>] &amp; <span class="number">0x02</span>) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        res-&gt;channelCfg = ((((<span class="type">uint8_t</span>)in[<span class="number">2</span>] &amp; <span class="number">0x01</span>) &lt;&lt; <span class="number">2</span>) | (((<span class="type">unsigned</span> <span class="type">int</span>)in[<span class="number">3</span>] &amp; <span class="number">0xc0</span>) &gt;&gt; <span class="number">6</span>));</span><br><span class="line">        res-&gt;originalCopy = ((<span class="type">uint8_t</span>)in[<span class="number">3</span>] &amp; <span class="number">0x20</span>) &gt;&gt; <span class="number">5</span>;</span><br><span class="line">        res-&gt;home = ((<span class="type">uint8_t</span>)in[<span class="number">3</span>] &amp; <span class="number">0x10</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">        res-&gt;copyrightIdentificationBit = ((<span class="type">uint8_t</span>)in[<span class="number">3</span>] &amp; <span class="number">0x08</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">        res-&gt;copyrightIdentificationStart = ((<span class="type">uint8_t</span>)in[<span class="number">3</span>] &amp; <span class="number">0x04</span>) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">        res-&gt;aacFrameLength = (((((<span class="type">unsigned</span> <span class="type">int</span>)in[<span class="number">3</span>]) &amp; <span class="number">0x03</span>) &lt;&lt; <span class="number">11</span>) |</span><br><span class="line">            (((<span class="type">unsigned</span> <span class="type">int</span>)in[<span class="number">4</span>] &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">3</span>) |</span><br><span class="line">            ((<span class="type">unsigned</span> <span class="type">int</span>)in[<span class="number">5</span>] &amp; <span class="number">0xE0</span>) &gt;&gt; <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        res-&gt;adtsBufferFullness = (((<span class="type">unsigned</span> <span class="type">int</span>)in[<span class="number">5</span>] &amp; <span class="number">0x1f</span>) &lt;&lt; <span class="number">6</span> |</span><br><span class="line">            ((<span class="type">unsigned</span> <span class="type">int</span>)in[<span class="number">6</span>] &amp; <span class="number">0xfc</span>) &gt;&gt; <span class="number">2</span>);</span><br><span class="line">        res-&gt;numberOfRawDataBlockInFrame = ((<span class="type">uint8_t</span>)in[<span class="number">6</span>] &amp; <span class="number">0x03</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;parse adts header fail\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rtpSendAACFrame</span><span class="params">(<span class="type">int</span> clientSockfd, RtpPacket* rtpPacket, <span class="type">uint8_t</span>* frame, <span class="type">uint32_t</span> frameSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    rtpPacket-&gt;payload[<span class="number">0</span>] = <span class="number">0x00</span>;</span><br><span class="line">    rtpPacket-&gt;payload[<span class="number">1</span>] = <span class="number">0x10</span>;</span><br><span class="line">    rtpPacket-&gt;payload[<span class="number">2</span>] = (frameSize &amp; <span class="number">0x1FE0</span>) &gt;&gt; <span class="number">5</span>; </span><br><span class="line">    rtpPacket-&gt;payload[<span class="number">3</span>] = (frameSize &amp; <span class="number">0x1F</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(rtpPacket-&gt;payload + <span class="number">4</span>, frame, frameSize);</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">rtpSendPacketOverTcp</span>(clientSockfd, rtpPacket, frameSize + <span class="number">4</span>, <span class="number">0x02</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to send rtp packet\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.seq++;</span><br><span class="line">    rtpPacket-&gt;rtpHeader.timestamp += <span class="number">1025</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rtpSendH264Frame</span><span class="params">(<span class="type">int</span> clientSockfd, RtpPacket* rtpPacket, <span class="type">char</span>* frame, <span class="type">uint32_t</span> frameSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> sendByte = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">uint8_t</span> naluType = frame[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s frameSize=%d \n&quot;</span>, __FUNCTION__, frameSize);</span><br><span class="line">    <span class="keyword">if</span> (frameSize &lt;= RTP_MAX_PKT_SIZE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(rtpPacket-&gt;payload, frame, frameSize);</span><br><span class="line">        ret = <span class="built_in">rtpSendPacketOverTcp</span>(clientSockfd, rtpPacket, frameSize, <span class="number">0x00</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        rtpPacket-&gt;rtpHeader.seq++;</span><br><span class="line">        sendByte += ret;</span><br><span class="line">        <span class="keyword">if</span> ((naluType &amp; <span class="number">0x1F</span>) == <span class="number">7</span> || (naluType &amp; <span class="number">0x1F</span>) == <span class="number">8</span>) </span><br><span class="line">            <span class="keyword">return</span> sendByte;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> pktNum = frameSize / RTP_MAX_PKT_SIZE;</span><br><span class="line">        <span class="type">int</span> remainPktSize = frameSize % RTP_MAX_PKT_SIZE;</span><br><span class="line">        <span class="type">int</span> pos = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pktNum; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            rtpPacket-&gt;payload[<span class="number">0</span>] = (naluType &amp; <span class="number">0x60</span>) | <span class="number">28</span>;</span><br><span class="line">            rtpPacket-&gt;payload[<span class="number">1</span>] = naluType &amp; <span class="number">0x1F</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">                rtpPacket-&gt;payload[<span class="number">1</span>] |= <span class="number">0x80</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (remainPktSize == <span class="number">0</span> &amp;&amp; i == pktNum - <span class="number">1</span>) </span><br><span class="line">                rtpPacket-&gt;payload[<span class="number">1</span>] |= <span class="number">0x40</span>;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">memcpy</span>(rtpPacket-&gt;payload + <span class="number">2</span>, frame + pos, RTP_MAX_PKT_SIZE);</span><br><span class="line">            ret = <span class="built_in">rtpSendPacketOverTcp</span>(clientSockfd, rtpPacket, RTP_MAX_PKT_SIZE + <span class="number">2</span>, <span class="number">0x00</span>);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">            rtpPacket-&gt;rtpHeader.seq++;</span><br><span class="line">            sendByte += ret;</span><br><span class="line">            pos += RTP_MAX_PKT_SIZE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (remainPktSize &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            rtpPacket-&gt;payload[<span class="number">0</span>] = (naluType &amp; <span class="number">0x60</span>) | <span class="number">28</span>;</span><br><span class="line">            rtpPacket-&gt;payload[<span class="number">1</span>] = naluType &amp; <span class="number">0x1F</span>;</span><br><span class="line">            rtpPacket-&gt;payload[<span class="number">1</span>] |= <span class="number">0x40</span>; <span class="comment">//end</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">memcpy</span>(rtpPacket-&gt;payload + <span class="number">2</span>, frame + pos, remainPktSize + <span class="number">2</span>);</span><br><span class="line">            ret = <span class="built_in">rtpSendPacketOverTcp</span>(clientSockfd, rtpPacket, remainPktSize + <span class="number">2</span>, <span class="number">0x00</span>);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">            rtpPacket-&gt;rtpHeader.seq++;</span><br><span class="line">            sendByte += ret;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sendByte;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">handleCmd_OPTIONS</span><span class="params">(<span class="type">char</span>* result, <span class="type">int</span> cseq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">sprintf</span>(result, <span class="string">&quot;RTSP/1.0 200 OK\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;CSeq: %d\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Public: OPTIONS, DESCRIBE, SETUP, PLAY\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;\r\n&quot;</span>,</span><br><span class="line">        cseq);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">handleCmd_DESCRIBE</span><span class="params">(<span class="type">char</span>* result, <span class="type">int</span> cseq, <span class="type">char</span>* url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> sdp[<span class="number">500</span>];</span><br><span class="line">    <span class="type">char</span> localIp[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sscanf</span>(url, <span class="string">&quot;rtsp://%[^:]:&quot;</span>, localIp);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(sdp, <span class="string">&quot;v=0\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;o=- 9%ld 1 IN IP4 %s\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;t=0 0\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;a=control:*\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;m=video 0 RTP/AVP/TCP 96\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;a=rtpmap:96 H264/90000\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;a=control:track0\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;m=audio 1 RTP/AVP/TCP 97\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;a=rtpmap:97 mpeg4-generic/44100/2\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;a=fmtp:97 profile-level-id=1;mode=AAC-hbr;sizelength=13;indexlength=3;indexdeltalength=3;config=1210;\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;a=control:track1\r\n&quot;</span>,</span><br><span class="line">        <span class="built_in">time</span>(<span class="literal">NULL</span>), localIp);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(result, <span class="string">&quot;RTSP/1.0 200 OK\r\nCSeq: %d\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Content-Base: %s\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Content-type: application/sdp\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Content-length: %zu\r\n\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;%s&quot;</span>,</span><br><span class="line">        cseq, url, <span class="built_in">strlen</span>(sdp), sdp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">handleCmd_SETUP</span><span class="params">(<span class="type">char</span>* result, <span class="type">int</span> cseq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cseq == <span class="number">3</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(result, <span class="string">&quot;RTSP/1.0 200 OK\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;CSeq: %d\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Transport: RTP/AVP/TCP;unicast;interleaved=0-1\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Session: 66334873\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\r\n&quot;</span>,</span><br><span class="line">            cseq);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (cseq == <span class="number">4</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(result, <span class="string">&quot;RTSP/1.0 200 OK\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;CSeq: %d\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Transport: RTP/AVP/TCP;unicast;interleaved=2-3\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Session: 66334873\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;\r\n&quot;</span>,</span><br><span class="line">            cseq);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">handleCmd_PLAY</span><span class="params">(<span class="type">char</span>* result, <span class="type">int</span> cseq)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">sprintf</span>(result, <span class="string">&quot;RTSP/1.0 200 OK\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;CSeq: %d\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Range: npt=0.000-\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Session: 66334873; timeout=10\r\n\r\n&quot;</span>,</span><br><span class="line">        cseq);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">doClient</span><span class="params">(<span class="type">int</span> clientSockfd, <span class="type">const</span> <span class="type">char</span>* clientIP, <span class="type">int</span> clientPort)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> method[<span class="number">40</span>], url[<span class="number">100</span>], version[<span class="number">40</span>];</span><br><span class="line">    <span class="type">int</span> CSeq;</span><br><span class="line">    <span class="type">char</span>* rBuf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(BUF_MAX_SIZE);</span><br><span class="line">    <span class="type">char</span>* sBuf = (<span class="type">char</span>*)<span class="built_in">malloc</span>(BUF_MAX_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> recvLen = <span class="built_in">recv</span>(clientSockfd, rBuf, BUF_MAX_SIZE, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (recvLen &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        rBuf[recvLen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;接收请求 rBuf = %s \n&quot;</span>, rBuf);</span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* sep = <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="type">char</span>* line = <span class="built_in">strtok</span>(rBuf, sep);</span><br><span class="line">        <span class="keyword">while</span> (line) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;OPTIONS&quot;</span>) ||</span><br><span class="line">                <span class="built_in">strstr</span>(line, <span class="string">&quot;DESCRIBE&quot;</span>) ||</span><br><span class="line">                <span class="built_in">strstr</span>(line, <span class="string">&quot;SETUP&quot;</span>) ||</span><br><span class="line">                <span class="built_in">strstr</span>(line, <span class="string">&quot;PLAY&quot;</span>)) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;%s %s %s\r\n&quot;</span>, method, url, version) != <span class="number">3</span>)</span><br><span class="line">                &#123;&#125;      <span class="comment">// error </span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;CSeq&quot;</span>)) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;CSeq: %d\r\n&quot;</span>, &amp;CSeq) != <span class="number">1</span>)</span><br><span class="line">                &#123;&#125;      <span class="comment">// error</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(line, <span class="string">&quot;Transport:&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;Transport:&quot;</span>))) </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot;Transport: RTP/AVP/TCP;unicast;interleaved=0-1\r\n&quot;</span>) != <span class="number">0</span>) </span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;parse Transport error \n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            line = <span class="built_in">strtok</span>(<span class="literal">NULL</span>, sep);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;OPTIONS&quot;</span>)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">handleCmd_OPTIONS</span>(sBuf, CSeq))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;failed to handle options\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;DESCRIBE&quot;</span>)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">handleCmd_DESCRIBE</span>(sBuf, CSeq, url))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;failed to handle describe\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;SETUP&quot;</span>)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">handleCmd_SETUP</span>(sBuf, CSeq))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;failed to handle setup\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;PLAY&quot;</span>)) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">handleCmd_PLAY</span>(sBuf, CSeq))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;failed to handle play\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;未定义的method = %s \n&quot;</span>, method);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;响应 sBuf = %s \n&quot;</span>, sBuf);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">send</span>(clientSockfd, sBuf, <span class="built_in">strlen</span>(sBuf), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(method, <span class="string">&quot;PLAY&quot;</span>)) </span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="function">std::thread <span class="title">t1</span><span class="params">([&amp;]() &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">int</span> frameSize, startCode;</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">char</span>* frame = (<span class="type">char</span>*)malloc(<span class="number">500000</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                RtpPacket* rtpPacket = (RtpPacket*)malloc(<span class="number">500000</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                FILE* fp = fopen(H264_FILE_NAME, <span class="string">&quot;rb&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">if</span> (!fp) </span></span></span><br><span class="line"><span class="params"><span class="function">                &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    printf(<span class="string">&quot;读取 %s 失败\n&quot;</span>, H264_FILE_NAME);</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">return</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                rtpHeaderInit(rtpPacket, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, RTP_VESION, RTP_PAYLOAD_TYPE_H264, </span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="number">0</span>,<span class="number">0</span>, <span class="number">0</span>, <span class="number">0x88923423</span>);</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                printf(<span class="string">&quot;start play\n&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">while</span> (<span class="literal">true</span>) </span></span></span><br><span class="line"><span class="params"><span class="function">                &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    frameSize = getFrameFromH264File(fp, frame, <span class="number">500000</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">if</span> (frameSize &lt; <span class="number">0</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">                    &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                        printf(<span class="string">&quot;读取%s结束,frameSize=%d \n&quot;</span>, H264_FILE_NAME, frameSize);</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">if</span> (startCode3(frame))</span></span></span><br><span class="line"><span class="params"><span class="function">                        startCode = <span class="number">3</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">else</span></span></span></span><br><span class="line"><span class="params"><span class="function">                        startCode = <span class="number">4</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                    frameSize -= startCode;</span></span></span><br><span class="line"><span class="params"><span class="function">                    rtpSendH264Frame(clientSockfd, rtpPacket, frame + startCode, frameSize);</span></span></span><br><span class="line"><span class="params"><span class="function">                    rtpPacket-&gt;rtpHeader.timestamp += <span class="number">90000</span> / <span class="number">25</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="comment">//Sleep(40);//-&gt;30,20,</span></span></span></span><br><span class="line"><span class="params"><span class="function">                    Sleep(<span class="number">20</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="comment">//usleep(40000);//1000/25 * 1000</span></span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                free(frame);</span></span></span><br><span class="line"><span class="params"><span class="function">                free(rtpPacket);</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">std::thread <span class="title">t2</span><span class="params">([&amp;]() &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                AdtsHeader adtsHeader;          </span></span></span><br><span class="line"><span class="params"><span class="function">                FILE* fp = fopen(AAC_FILE_NAME, <span class="string">&quot;rb&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">if</span> (!fp) </span></span></span><br><span class="line"><span class="params"><span class="function">                &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    printf(<span class="string">&quot;读取 %s 失败\n&quot;</span>, AAC_FILE_NAME);</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">return</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">uint8_t</span>* frame = (<span class="type">uint8_t</span>*)malloc(<span class="number">5000</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                RtpPacket* rtpPacket = (RtpPacket*)malloc(<span class="number">5000</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                rtpHeaderInit(rtpPacket, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, RTP_VESION, RTP_PAYLOAD_TYPE_AAC, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x32411</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">int</span> ret;</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">while</span> (<span class="literal">true</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">                &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    ret = fread(frame, <span class="number">1</span>, <span class="number">7</span>, fp);</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">if</span> (ret &lt;= <span class="number">0</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">                    &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                        printf(<span class="string">&quot;fread err\n&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                    printf(<span class="string">&quot;fread ret=%d \n&quot;</span>, ret);</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">if</span> (Parse_AdtsHeader(frame, &amp;adtsHeader) &lt; <span class="number">0</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">                    &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                        printf(<span class="string">&quot;parseAdtsHeader err\n&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                    ret = fread(frame, <span class="number">1</span>, adtsHeader.aacFrameLength - <span class="number">7</span>, fp);</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">if</span> (ret &lt;= <span class="number">0</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">                    &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                        printf(<span class="string">&quot;fread err\n&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                    rtpSendAACFrame(clientSockfd,</span></span></span><br><span class="line"><span class="params"><span class="function">                        rtpPacket, frame, adtsHeader.aacFrameLength - <span class="number">7</span>);</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                    Sleep(<span class="number">23</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="comment">//usleep(23223);//1000/43.06 * 1000</span></span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                free(frame);</span></span></span><br><span class="line"><span class="params"><span class="function">                free(rtpPacket);</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;)</span></span>;</span><br><span class="line"></span><br><span class="line">            t1.<span class="built_in">join</span>();</span><br><span class="line">            t2.<span class="built_in">join</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(method, <span class="number">0</span>, <span class="built_in">sizeof</span>(method));</span><br><span class="line">        <span class="built_in">memset</span>(url, <span class="number">0</span>, <span class="built_in">sizeof</span>(url));</span><br><span class="line">        CSeq = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">closesocket</span>(clientSockfd);</span><br><span class="line">    <span class="built_in">free</span>(rBuf);</span><br><span class="line">    <span class="built_in">free</span>(sBuf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;PC Server Socket Start Up Error \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> serverSockfd;</span><br><span class="line">    serverSockfd = <span class="built_in">createTcpSocket</span>();</span><br><span class="line">    <span class="keyword">if</span> (serverSockfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to create tcp socket\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bindSocketAddr</span>(serverSockfd, <span class="string">&quot;0.0.0.0&quot;</span>, SERVER_PORT) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to bind addr\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">listen</span>(serverSockfd, <span class="number">10</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to listen\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s rtsp://127.0.0.1:%d\n&quot;</span>, __FILE__, SERVER_PORT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> clientSockfd;</span><br><span class="line">        <span class="type">char</span> clientIp[<span class="number">40</span>];</span><br><span class="line">        <span class="type">int</span> clientPort;</span><br><span class="line">        clientSockfd = <span class="built_in">acceptClient</span>(serverSockfd, clientIp, &amp;clientPort);</span><br><span class="line">        <span class="keyword">if</span> (clientSockfd &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;failed to accept client\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;accept client;client ip:%s,client port:%d\n&quot;</span>, clientIp, clientPort);</span><br><span class="line">        <span class="built_in">doClient</span>(clientSockfd, clientIp, clientPort);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">closesocket</span>(serverSockfd);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-3-分析抓包理解源码"><a href="#5-3-分析抓包理解源码" class="headerlink" title="5.3 分析抓包理解源码"></a>5.3 分析抓包理解源码</h2><blockquote>
<p>两个<code>m</code><br><img src="/img/rtsp23.png"></p>
</blockquote>
<blockquote>
<p>第一路流的rtp和rtcp的通道序号<br><img src="/img/rtsp24.png"></p>
</blockquote>
<blockquote>
<p>返回的同理,第一路流的0通道和1通道在这里插入图片描述<br><img src="/img/rtsp25.png"></p>
</blockquote>
<blockquote>
<p>同理第二路流用2,3通道,replay同理<br><img src="/img/rtsp26.png"></p>
</blockquote>
<blockquote>
<p>97代表的是aac, 96代表的是h264<br><img src="/img/rtsp27.png"></p>
</blockquote>
<blockquote>
<p>$符号(间隔符),通道00,第一路流的第一个通道,长度<br><img src="/img/rtsp28.png"></p>
</blockquote>
<blockquote>
<p>$符号,02,第二路流的第一个通道,长度<br><img src="/img/rtsp29.png"></p>
</blockquote>
<hr>
<h1 id="6-RTSPServer"><a href="#6-RTSPServer" class="headerlink" title="6. RTSPServer"></a>6. RTSPServer</h1><p><a target="_blank" rel="noopener" href="https://github.com/9TSe/RTSPServer">GitHub源码</a></p>
<p>整体逻辑如下图</p>
<p><img src="/img/rtsp30.png"></p>
<p><strong>Linux配置环境</strong></p>
<ol>
<li>配置SDL环境</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://sourceforge.net/projects/libsdl/files/SDL/1.2.15/SDL-1.2.15.tar.gz/download">一键下寨!</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf SDL-1.2.15.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> SDL-1.2.15/</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>


<ol start="2">
<li>安装ffmpeg库</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ffmpeg</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>整理文件</li>
</ol>
<p>先切换到RTSP_Server目录中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> src</span><br><span class="line"><span class="built_in">mv</span> *.cpp src</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> include</span><br><span class="line"><span class="built_in">mv</span> *.h include</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> build</span><br></pre></td></tr></table></figure>

<p>准备好 .aac 和 .h264 文件放置RTSP_Server目录中</p>
<ol start="4">
<li>运行</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake ..</span><br><span class="line">make</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">./app</span><br></pre></td></tr></table></figure>

<p>另起一个终端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#over tcp</span></span><br><span class="line">ffplay -i -rtsp_transport tcp  rtsp://127.0.0.1:8554/test</span><br><span class="line"></span><br><span class="line"><span class="comment">#over udp</span></span><br><span class="line">ffplay -i rtsp://127.0.0.1:8554/test</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="7-RTCP"><a href="#7-RTCP" class="headerlink" title="7. RTCP"></a>7. RTCP</h1><blockquote>
<p>实时传输控制协议(Real-time ControlProtocol，RTCP)是和 RTP一起工作的控制协议。<br>在RTP会话期间，Udp传输时通过使用不同的端口号可把RTP数据包和RTCP信息包区分开来<br>Tcp使用相同的端口号, 每个会话参与者周期性地向所有其他参与者发送RTCP控制信息包。</p>
</blockquote>
<p><strong>功能</strong>:<br>在RTP会话期间，每个会话参与者周期性地向所有其他参与者发送RTCP控制信息包。<br>每个RTCP信息包<code>不是</code>封装声音或者视频数据，而是封装发送端或接收端的统计报表。<br>这些信息包括发送的信息包数目、丢失的信息包数目和信息包的抖动等情况<br>信息包具体的有: 假设是直播推流的场景,<br>截至目前已经发送了多少的RTP数据包, RTP对应的字节流的长度的数据, RTP最新的时间戳, NTP(精准时间戳,ms级)等</p>
<h2 id="1-1-RTCP包类型"><a href="#1-1-RTCP包类型" class="headerlink" title="1.1 RTCP包类型"></a>1.1 RTCP包类型</h2><p>根据所携带的控制信息不同，RTCP信息包可分为<br>RR（接收者报告包）、SR（源报告包）、SEDS（源描述包）、BYE（离开申明）和APP（特殊应用包）</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>缩写</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>200</td>
<td>SR</td>
<td>发送端报告</td>
</tr>
<tr>
<td>201</td>
<td>RR</td>
<td>接收端报告</td>
</tr>
<tr>
<td>202</td>
<td>SDES</td>
<td>源点描述</td>
</tr>
<tr>
<td>203</td>
<td>BYE</td>
<td>结束传输</td>
</tr>
<tr>
<td>204</td>
<td>APP</td>
<td>特定应用</td>
</tr>
</tbody></table>
<p>实际RTCP真正拥有的类型有20多种</p>
<p><strong>SR</strong>:</p>
<ul>
<li><code>版本（V）</code>：2比特，RTCP版本。</li>
<li><code>填充（P）</code>：1比特，如果该位置为1，则该RTCP包的尾部就包含附加的填充字节。</li>
<li><code>接收报告计数器（RC）</code>：5比特，该SR包中的接收报告块的数目，可以为零。</li>
<li><code>包类型（PT）</code>：8比特，SR包是200。</li>
<li><code>长度域（Length）</code>：16比特，RTCP包的长度，包括填充的内容。</li>
<li><code>同步源（SSRC of sender）</code>：32比特，SR包发送者的同步源标识符。与对应RTP包中的SSRC一样。</li>
<li><code>NTP timestamp（MSW+LWS）</code>：64比特， 表示发送此报告时以挂钟时间测量的时间点。 结合来自各个接收器的接收报告中返回的时间戳，它可用于估计往返于接收器的往返传播时间。</li>
<li><code>RTP timestamp</code>：32比特，与NTP时间戳对应，与RTP数据包中的RTP时间戳具有相同的单位和随机初始值。</li>
<li><code>Sender’s packet count</code>：32比特，从开始发送包到产生这个SR包这段时间里，发送者发送的RTP数据包的总数. SSRC改变时，这个域清零。</li>
<li><code>Senders octet count</code>：32比特，从开始发送包到产生这个SR包这段时间里，发送者发送的净荷数据的总字节数（不包括头部和填充）。发送者改变其SSRC时，这个域要清零。</li>
<li><code>SSRC_n</code> ：32比特，在此块中报告其接收的发送者的 SSRC 标识符</li>
<li><code>丢失率(Fraction Lost)</code> :8比特，表明从上一个SR或RR包发出以来从同步源n(SSRC_n)来的RTP数据包的丢失率</li>
<li><code>累计的包丢失数目（cumulative number of packets lost ）</code>：24比特，从开始接收到SSRC_n的包到发送SR,从SSRC_n传过来的RTP数据包的丢失总数。</li>
<li><code>收到的扩展最大序列号(extended highest sequence number received  EHSN )</code>：<br>从SSRC_n收到的RTP数据包中最大的序列号<br><code>uint16_t seq_cycles</code>;  &#x2F;&#x2F;Sequence number cycles count (序列号循环计数<br>  <code>uint16_t seq_max</code>;	 &#x2F;&#x2F;highest sequence number received (序列最大值</li>
<li><code>接收抖动（Interarrival jitter）</code>：32比特，RTP数据包接受时间的统计方差估计</li>
<li><code>上次SR时间戳（Last SR,LSR）</code>：32比特，取最近从SSRC_n收到的SR包中的NTP时间戳的中间32比特。如果目前还没收到SR包，则该域清零</li>
<li><code>上次SR以来的延时（Delay since last SR,DLSR）</code>：32比特，上次从SSRC_n收到SR包到发送本报告的延时</li>
<li>扩展字段 profile-specific extensions</li>
</ul>
<h2 id="1-2-RTCP抓包"><a href="#1-2-RTCP抓包" class="headerlink" title="1.2 RTCP抓包"></a>1.2 RTCP抓包</h2><p><img src="/img/rtsp31.png"></p>
<p>服务段先发送RR, 推流端收到RR后发送SR</p>
<p><em>推流端第一次发送SR</em></p>
<p><img src="/img/rtsp32.png"></p>
<ul>
<li><code>Sender&#39;s packet count</code> : 截止到当前发送RTP包的数量</li>
<li><code>Sender&#39;s octet count</code> : 发送RTP包对应字节流的长度</li>
<li><code>RTP timestamp</code> : 当前发送RTCP时RTP最新的RTPHeader时间戳</li>
<li><code>Timestamp, MSW</code> 和 <code>Timestamp, LSW</code>: NTP用两个字段用来表示和传输</li>
</ul>
<p><em>第二次发送SR:</em></p>
<p><img src="/img/rtsp33.png"></p>
<p>demo(未完成): <a target="_blank" rel="noopener" href="https://github.com/9TSe/RTSPServer">6,7 RTCP</a><br>client实际发送的数据目前未知,client端表示发送成功, server端表示接受的ssrc,packetcount等超过类型最大值,cout失败<br>推测端口被占用</p>
<hr>
<h1 id="8-RTSP客户端"><a href="#8-RTSP客户端" class="headerlink" title="8. RTSP客户端"></a>8. RTSP客户端</h1><blockquote>
<p>ffmpeg向RTSPServer推流, RTSPClient再向RTSPServer拉流 生成可播放的h264文件</p>
</blockquote>
<h2 id="1-SDP-Session-Description-Protocol-简介"><a href="#1-SDP-Session-Description-Protocol-简介" class="headerlink" title="1. SDP(Session Description Protocol) 简介"></a>1. SDP(Session Description Protocol) 简介</h2><blockquote>
<p>SDP 完全是一种<code>会话描述格式</code>, 它不属于传输协议<br>它只使用于不同的适当的传输协议，包括会话通知协议（SAP）、会话初始协议（SIP）、实时流协议（RTSP）、MIME 扩展协议的电子邮件以及超文本传输协议（HTTP）。<br>SDP协议是也是<code>基于文本的协议</code>，这样就能保证协议的可扩展性比较强，这样就使其具有广泛的应用范围。SDP 不支持会话内容或媒体编码的协商，所以在流媒体中<code>只用来描述媒体信息</code>。媒体协商这一块要用RTSP来实现．</p>
</blockquote>
<h2 id="2-向-RTSP服务端-推流的ffmpeg命令"><a href="#2-向-RTSP服务端-推流的ffmpeg命令" class="headerlink" title="2. 向 RTSP服务端 推流的ffmpeg命令"></a>2. 向 RTSP服务端 推流的ffmpeg命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -re -stream_loop -1 -i xxx.mp4  \</span><br><span class="line">-rtsp_transport tcp -c copy -f rtsp rtsp://127.0.0.1:554/live/test</span><br><span class="line"><span class="comment">#stream_loop 为了方便调试,使流循环推流</span></span><br></pre></td></tr></table></figure>

<h2 id="3-WireShark-常用过滤-及-抓包分析"><a href="#3-WireShark-常用过滤-及-抓包分析" class="headerlink" title="3. WireShark 常用过滤 及 抓包分析"></a>3. WireShark 常用过滤 及 抓包分析</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tcp.srcport != 63639 and rtsp and !rtcp</span><br><span class="line">ip.src_host == 127.0.0.1</span><br><span class="line">ip.dst_host == 127.0.0.1</span><br><span class="line">tcp.srcport == xx</span><br><span class="line">tcp.dstport == xx</span><br></pre></td></tr></table></figure>

<p><em><strong>抓包分析:</strong></em></p>
<blockquote>
<p>Option<br><img src="/img/rtsp34.png"><br><img src="/img/rtsp35.png"></p>
</blockquote>
<blockquote>
<p>Reply1 : public 是允许的字段<br><img src="/img/rtsp36.png"><br><img src="/img/rtsp37.png"></p>
</blockquote>
<blockquote>
<p>Describe<br><img src="/img/rtsp38.png"></p>
</blockquote>
<blockquote>
<p>Reply 2: 包含SDP(回应describe后, 由于SDP, 以后不管推拉流都要包含session中独特的序列<br><img src="/img/rtsp39.png"><br><img src="/img/rtsp40.png"></p>
</blockquote>
<blockquote>
<p>Setup 1 : 视频流<br><img src="/img/rtsp41.png"></p>
</blockquote>
<blockquote>
<p>Reply 3:<br><img src="/img/rtsp42.png"></p>
</blockquote>
<blockquote>
<p>Setup 2 : 音频流<br><img src="/img/rtsp43.png"></p>
</blockquote>
<blockquote>
<p>Reply 4:<br><img src="/img/rtsp44.png"></p>
</blockquote>
<blockquote>
<p>Play:<br><img src="/img/rtsp45.png"></p>
</blockquote>
<blockquote>
<p>Reply 5:<br><img src="/img/rtsp46.png"></p>
</blockquote>
<p><code>**SetUp中若有,字幕流,弹幕流等 Setup就会++**</code></p>
<p><a target="_blank" rel="noopener" href="https://github.com/9TSe/RTSPServer">RTSPClient 源码</a></p>
<h2 id="4-windows下查看端口命令"><a href="#4-windows下查看端口命令" class="headerlink" title="4. windows下查看端口命令"></a>4. windows下查看端口命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#windows查看端口占用进程</span></span><br><span class="line">netstat -aon|findstr <span class="string">&quot;10000&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#windows查看命令占用进程</span></span><br><span class="line">tasklist | findstr <span class="string">&quot;python&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#windows根据进程ID查看应用</span></span><br><span class="line">tasklist|findstr <span class="string">&quot;11748&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#windows根据进程ID杀死应用</span></span><br><span class="line">taskkill /pid 11748 /F</span><br><span class="line">taskkill -PID 进程号 -F</span><br></pre></td></tr></table></figure></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/RTSP/">RTSP</a></div><div class="post_share"><div class="social-share" data-image="/pic/1.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/03/18/RTMP/" title="RTMP"><img class="cover" src="/pic/1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">RTMP</div></div></a></div><div class="next-post pull-right"><a href="/2023/12/05/ffmpeg/" title="ffmpeg命令行简介"><img class="cover" src="/pic/1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ffmpeg命令行简介</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/pic/avater.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">NineTSe</div><div class="author-info__description">难正经</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">70</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">45</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/9tse"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/9TSe" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:9TSewer@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">C++部分,Qt,Linux,文章摘于 https://subingwen.cn/</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-RTSP%E5%8D%8F%E8%AE%AE%E7%AE%80%E4%BB%8B"><span class="toc-text">1. RTSP协议简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-RTSP%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9F%BA%E7%A1%80%E6%A1%86%E6%9E%B6"><span class="toc-text">1.1 RTSP服务器基础框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E5%88%86%E6%9E%90%E6%8A%93%E5%8C%85%E6%95%B0%E6%8D%AE"><span class="toc-text">1.2 分析抓包数据</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-UDP%E7%9A%84RTP%E4%BC%A0%E8%BE%93h264%E7%9A%84RTSP%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E8%83%BD%E6%8B%89%E6%B5%81%E6%92%AD%E6%94%BE"><span class="toc-text">2. UDP的RTP传输h264的RTSP服务器，能拉流播放</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-RTP%E7%90%86%E8%A7%A3"><span class="toc-text">2.1 RTP理解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-RTP%E7%AE%80%E8%BF%B0"><span class="toc-text">2.1.1 RTP简述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-RTP%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F"><span class="toc-text">2.1.2 RTP报文格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3-RTP%E5%8C%85%E5%8F%91%E9%80%81%E5%89%8D%E7%BC%80"><span class="toc-text">2.1.3 RTP包发送前缀</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-H264%E7%90%86%E8%A7%A3"><span class="toc-text">2.2 H264理解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E5%8E%8B%E7%BC%A9%E6%96%B9%E5%BC%8F"><span class="toc-text">2.2.1 压缩方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-h264%E7%BB%84%E6%88%90"><span class="toc-text">2.2.2 h264组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-%E7%A0%81%E6%B5%81%E7%BB%93%E6%9E%84"><span class="toc-text">2.2.3 码流结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E8%A7%A3%E5%B0%81%E8%A3%85mp4%E7%94%9F%E6%88%90h264%E6%96%87%E4%BB%B6"><span class="toc-text">2.3 解封装mp4生成h264文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E5%B0%86H264%E5%B0%81%E8%A3%85%E5%88%B0RTP%E6%95%B0%E6%8D%AE%E5%8C%85"><span class="toc-text">2.4 将H264封装到RTP数据包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.5 代码实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E9%9F%B3%E9%A2%91%E5%8E%9F%E7%90%86"><span class="toc-text">3. 音频原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-PCM%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="toc-text">3.1 PCM数据格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E5%87%A0%E4%B8%AA%E5%8F%AF%E8%83%BD%E4%BC%9A%E7%94%A8%E5%88%B0%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="toc-text">3.2 几个可能会用到的命令行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E4%BB%A3%E7%A0%81"><span class="toc-text">3.3  代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-UDP%E7%9A%84RTP%E4%BC%A0%E8%BE%93%E9%9F%B3%E9%A2%91aac%E7%9A%84RTSP%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E8%83%BD%E6%8B%89%E6%B5%81%E6%92%AD%E6%94%BE"><span class="toc-text">4. UDP的RTP传输音频aac的RTSP服务器，能拉流播放</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-aac%E7%A0%81%E6%B5%81%E6%A0%BC%E5%BC%8F"><span class="toc-text">4.1 aac码流格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">4.2 代码实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-TCP%E7%9A%84RTP%E5%90%8C%E6%97%B6%E4%BC%A0%E8%BE%93h264%E5%92%8Caac%E7%9A%84RTSP%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E8%83%BD%E6%8B%89%E6%B5%81%E6%92%AD%E6%94%BE"><span class="toc-text">5. TCP的RTP同时传输h264和aac的RTSP服务器，能拉流播放</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-ffmpeg%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="toc-text">5.1 ffmpeg命令行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">5.2 代码实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E5%88%86%E6%9E%90%E6%8A%93%E5%8C%85%E7%90%86%E8%A7%A3%E6%BA%90%E7%A0%81"><span class="toc-text">5.3 分析抓包理解源码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-RTSPServer"><span class="toc-text">6. RTSPServer</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-RTCP"><span class="toc-text">7. RTCP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-RTCP%E5%8C%85%E7%B1%BB%E5%9E%8B"><span class="toc-text">1.1 RTCP包类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-RTCP%E6%8A%93%E5%8C%85"><span class="toc-text">1.2 RTCP抓包</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-RTSP%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">8. RTSP客户端</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-SDP-Session-Description-Protocol-%E7%AE%80%E4%BB%8B"><span class="toc-text">1. SDP(Session Description Protocol) 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%90%91-RTSP%E6%9C%8D%E5%8A%A1%E7%AB%AF-%E6%8E%A8%E6%B5%81%E7%9A%84ffmpeg%E5%91%BD%E4%BB%A4"><span class="toc-text">2. 向 RTSP服务端 推流的ffmpeg命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-WireShark-%E5%B8%B8%E7%94%A8%E8%BF%87%E6%BB%A4-%E5%8F%8A-%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90"><span class="toc-text">3. WireShark 常用过滤 及 抓包分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-windows%E4%B8%8B%E6%9F%A5%E7%9C%8B%E7%AB%AF%E5%8F%A3%E5%91%BD%E4%BB%A4"><span class="toc-text">4. windows下查看端口命令</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/05/03/ONVIF/" title="ONVIF"><img src="/pic/1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ONVIF"/></a><div class="content"><a class="title" href="/2024/05/03/ONVIF/" title="ONVIF">ONVIF</a><time datetime="2024-05-03T15:59:37.000Z" title="发表于 2024-05-03 23:59:37">2024-05-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/01/Python/" title="Python"><img src="/pic/1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Python"/></a><div class="content"><a class="title" href="/2024/05/01/Python/" title="Python">Python</a><time datetime="2024-05-01T13:07:51.000Z" title="发表于 2024-05-01 21:07:51">2024-05-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/18/GB28181/" title="GB28181"><img src="/pic/1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GB28181"/></a><div class="content"><a class="title" href="/2024/04/18/GB28181/" title="GB28181">GB28181</a><time datetime="2024-04-18T07:38:27.000Z" title="发表于 2024-04-18 15:38:27">2024-04-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/03/18/RTMP/" title="RTMP"><img src="/pic/1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RTMP"/></a><div class="content"><a class="title" href="/2024/03/18/RTMP/" title="RTMP">RTMP</a><time datetime="2024-03-18T04:14:50.000Z" title="发表于 2024-03-18 12:14:50">2024-03-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/12/05/RTSP1/" title="RTSP"><img src="/pic/1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RTSP"/></a><div class="content"><a class="title" href="/2023/12/05/RTSP1/" title="RTSP">RTSP</a><time datetime="2023-12-05T13:58:26.000Z" title="发表于 2023-12-05 21:58:26">2023-12-05</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By NineTSe</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>